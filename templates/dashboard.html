<!DOCTYPE html>
<html lang="en" class="dark h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectManager Dashboard</title>
    
    <!-- Favicon - E-Click Logo -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/E-CLICK LOGO FINGER.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/E-CLICK LOGO FINGER.png">
    <link rel="apple-touch-icon" href="/static/images/E-CLICK LOGO FINGER.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
   <style>
  /* Scrollbar styles for better UX */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #1e293b;
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb {
    background: #475569;
    border-radius: 4px;
    border: 1px solid #1e293b;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #64748b;
  }
  ::-webkit-scrollbar-corner {
    background: #1e293b;
  }

  /* Custom scrollbar for Gantt chart */
  .gantt-container::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }
  .gantt-container::-webkit-scrollbar-track {
    background: #0f172a;
    border-radius: 5px;
  }
  .gantt-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #475569, #64748b);
    border-radius: 5px;
    border: 1px solid #0f172a;
  }
  .gantt-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #64748b, #94a3b8);
  }

  /* Gantt Bar Styling */
  .gantt-timeline {
    position: relative;
    min-height: 64px;
    overflow-x: auto;
    display: flex;
    align-items: center;
  }

  /* Y-axis styling - make it very visible */
  .gantt-y-axis {
    background: #0f172a !important;
    border-right: 4px solid #3b82f6 !important;
    position: relative;
    min-width: 40px !important;
    width: 40px !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .gantt-y-axis-header {
    background: #0f172a !important;
    border-right: 4px solid #3b82f6 !important;
    position: relative;
    min-width: 40px !important;
    width: 40px !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  /* Y-axis visual indicator - make it very prominent */
  .gantt-y-axis::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #3b82f6;
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
  }

  /* Y-axis header styling */
  .gantt-y-axis-header > div {
    font-weight: bold;
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    font-size: 14px;
  }

  /* Debug styling to make Y-axis impossible to miss */
  .gantt-y-axis {
    border: 2px solid #ef4444 !important;
    background: #dc2626 !important;
  }

  .gantt-y-axis-header {
    border: 2px solid #ef4444 !important;
    background: #dc2626 !important;
  }

  /* Make projects container scrollable */
  #projects-container {
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
  }

  /* Ensure proper spacing for Y-axis */
  .gantt-container {
    position: relative;
  }

  /* Ensure Y-axis stays visible during scroll */
  .gantt-y-axis {
    position: sticky;
    left: 0;
    z-index: 10;
  }

  /* Make header sticky */
  #gantt-header {
    position: sticky;
    top: 0;
    z-index: 20;
    background: #0f172a;
  }
  .gantt-bar {
    position: absolute;
    border-radius: 6px;
    transition: all 0.3s ease, background 0.8s ease;
    cursor: pointer;
    top: 50%;
    transform: translateY(-50%);
    border: 2px solid transparent;
    overflow: hidden;
  }

  /* Progress bar styling for project bars - Green for completed, Yellow for uncompleted */
  .gantt-bar[data-progress] {
    position: relative;
  }

  /* Progress overlay for status-based bars */
  .gantt-progress-overlay {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    z-index: 2;
    pointer-events: none;
    transition: width 0.8s ease;
  }
  .gantt-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }

  /* Enhanced hover effect for project bars with progress */
  .gantt-bar[data-progress]:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 20px rgba(16, 185, 129, 0.3);
  }

  /* Special styling for completed projects */
  .gantt-bar[data-progress="100"] {
    background: #10b981 !important;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.6);
  }



  /* Status-based Gantt bar colors */
  .gantt-bar[data-status] {
    transition: all 0.3s ease;
  }

  /* Progress overlay for status-based bars */
  .gantt-progress-overlay {
    transition: width 0.8s ease;
  }

  /* Status-specific hover effects */
  .gantt-bar[data-status]:hover {
    transform: translateY(-2px);
    filter: brightness(1.1);
  }

  /* Completed status special effects */
  .gantt-bar[data-status*="completed"]:hover {
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
  }

  /* In-progress status special effects */
  .gantt-bar[data-status*="in-progress"]:hover {
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
  }

  /* Not started/blocked status special effects */
  .gantt-bar[data-status*="not-started"]:hover,
  .gantt-bar[data-status*="blocked"]:hover {
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
  }

  /* On-hold status special effects */
  .gantt-bar[data-status*="on-hold"]:hover {
    box-shadow: 0 8px 25px rgba(71, 85, 105, 0.4);
  }
  .gantt-bar:focus, .gantt-bar:active {
    border: 2px solid #38bdf8;
    outline: none;
  }
  .project-progress {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    transition: width 0.8s ease;
  }

  /* Tooltip styles */
  #tooltip {
    z-index: 1000;
    max-width: 90vw;
    backdrop-filter: blur(10px);
    background: rgba(17, 24, 39, 0.95);
    border: 1px solid rgba(75, 85, 99, 0.5);
    word-wrap: break-word;
  }

  /* Card styling */
  .stats-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  }

  /* Simple animations */
  .slide-in {
    animation: slideIn 0.3s ease-out;
  }
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .fade-in {
    animation: fadeIn 0.5s ease-out;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Responsive Gantt layout */
  .gantt-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: auto;
    min-width: 100%;
    max-height: 70vh; /* Limit height to enable vertical scrolling */
  }

  /* Gantt chart wrapper for better scrolling control */
  .gantt-chart-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 400px;
  }

  /* Gantt header that stays fixed during vertical scroll */
  .gantt-header-fixed {
    position: sticky;
    top: 0;
    background: var(--background-secondary, #1e293b);
    z-index: 20;
    border-bottom: 2px solid var(--border-medium, #475569);
  }

  /* Gantt body with vertical scroll */
  .gantt-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: auto;
    min-height: 300px;
  }

  /* Project rows container */
  .gantt-projects-container {
    min-height: 100%;
  }
  .gantt-project-details {
    width: 100%;
    min-width: 200px;
    max-width: 100%;
    box-sizing: border-box;
  }
  .gantt-timeline-area {
    min-width: 300px;
    flex: 1;
    overflow-x: auto;
    box-sizing: border-box;
  }

  @media (max-width: 768px) {
    .gantt-project-details {
      min-width: 150px;
      font-size: 0.75rem;
    }
    .gantt-timeline-area {
      min-width: 200px;
    }
    .stats-card {
      margin-bottom: 1rem;
    }
  }

  @media (max-width: 640px) {
    .gantt-project-details {
      min-width: 120px;
      font-size: 0.7rem;
    }
    .gantt-timeline-area {
      min-width: 150px;
    }
    .sidebar {
      width: 100%;
      max-width: 280px;
    }
  }

  @media (min-width: 1024px) {
    .gantt-project-details {
      width: 35%;
      min-width: 280px;
      max-width: 350px;
    }
    .gantt-timeline-area {
      width: 65%;
    }
  }

  /* Ensure main fills available height and is scrollable */
  html, body {
    height: 100%;
    overflow: hidden;
  }
  main {
    height: 100%;
    overflow-y: auto;
  }

  /* Mobile responsive improvements */
  @media (max-width: 768px) {
    .dashboard-content {
      padding: 0.5rem;
    }
    .gantt-header {
      font-size: 0.75rem;
    }
    .project-item {
      font-size: 0.8rem;
    }
    .controls-container {
      flex-direction: column;
      gap: 0.5rem;
    }
  }

  @media (max-width: 640px) {
    .dashboard-content {
      padding: 0.25rem;
    }
    .gantt-header {
      font-size: 0.7rem;
    }
    .project-item {
      font-size: 0.75rem;
    }
  }

  /* Add to the style section */
  @media (max-width: 1024px) {
    .gantt-container {
      min-width: 100vw;
      overflow-x: auto;
    }
    .gantt-project-details {
      min-width: 120px;
      font-size: 0.8rem;
    }
    .gantt-timeline-area {
      min-width: 200px;
    }
    .project-item {
      font-size: 0.9rem;
    }
  }
  @media (max-width: 640px) {
    .gantt-project-details {
      min-width: 90px;
      font-size: 0.7rem;
    }
    .gantt-timeline-area {
      min-width: 120px;
    }
    .dashboard-content {
      padding: 0.25rem;
    }
    .gantt-header {
      font-size: 0.7rem;
    }
    .project-item {
      font-size: 0.75rem;
    }
  }

  /* --- Responsive and Desktop-First Dashboard Improvements --- */
  html, body {
    height: 100%;
    overflow: hidden;
  }
  body {
    font-size: 1rem;
  }
  main {
    height: 100%;
    overflow-y: auto;
  }

  /* Sidebar always visible on desktop, overlays on mobile */
  #sidebar {
    width: 260px;
    min-width: 220px;
    max-width: 320px;
    background: #1e293b;
    transition: transform 0.3s;
  }
  @media (max-width: 1024px) {
    #sidebar {
      position: fixed;
      z-index: 50;
      transform: translateX(-100%);
      width: 80vw;
      max-width: 320px;
    }
    #sidebar.lg\:translate-x-0 {
      transform: translateX(0);
    }
  }

  /* Main content area uses all available width */
  .flex-1 {
    min-width: 0;
    width: 100%;
  }

  /* Gantt chart improvements */
  .gantt-container {
    width: 100%;
    overflow-x: auto;
    min-width: 100%;
    background: #0f172a;
  }
  .gantt-project-details {
    min-width: 220px;
    max-width: 350px;
    font-size: 1rem;
    background: #1e293b;
  }
  .gantt-timeline-area {
    min-width: 600px;
    flex: 1;
    overflow-x: auto;
    background: #0f172a;
  }
  @media (max-width: 1024px) {
    .gantt-project-details {
      min-width: 120px;
      font-size: 0.9rem;
    }
    .gantt-timeline-area {
      min-width: 300px;
    }
  }
  @media (max-width: 640px) {
    .gantt-project-details {
      min-width: 90px;
      font-size: 0.8rem;
    }
    .gantt-timeline-area {
      min-width: 120px;
    }
  }

  /* Controls and header alignment */
  .controls-container {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
  }
  @media (max-width: 640px) {
    .controls-container {
      flex-direction: column;
      gap: 0.5rem;
      align-items: stretch;
    }
  }

  /* Gantt bar polish */
  .gantt-bar {
    cursor: pointer;
    border: 2px solid transparent;
    transition: border 0.2s, box-shadow 0.2s;
  }
  .gantt-bar:focus, .gantt-bar:active, .gantt-bar:hover {
    border: 2px solid #38bdf8;
    outline: none;
    box-shadow: 0 0 0 2px #38bdf8;
  }

  /* Project row hover */
  .project-item .flex.border-b:hover {
    background: #334155 !important;
    transition: background 0.2s;
  }

  /* Hide horizontal scroll on desktop except for Gantt area */
  @media (min-width: 1024px) {
    body, html {
      overflow-x: hidden;
    }
    .gantt-container {
      overflow-x: auto;
    }
  }

  /* Subtle shadow for main card */
  .bg-slate-800.rounded-xl {
    box-shadow: 0 8px 32px rgba(0,0,0,0.18), 0 1.5px 4px rgba(30,41,59,0.12);
  }

  /* Responsive font sizes for stats and headers */
  .stats-card h2, .stats-card .text-lg, .stats-card .text-xl {
    font-size: 1.25rem;
  }
  @media (max-width: 640px) {
    .stats-card h2, .stats-card .text-lg, .stats-card .text-xl {
      font-size: 1rem;
    }
  }
</style>

</head>
<body class="bg-slate-900 text-white h-full overflow-hidden">
    <!-- Pass Django data to JavaScript FIRST -->
    <script>
        // This will be populated by your Django template
        window.djangoProjects = {{ projects_json|default:"[]"|safe }};
        window.djangoActivities = {{ activities_json|default:"[]"|safe }};
        
        console.log('Django projects loaded:', window.djangoProjects);
        console.log('Django activities loaded:', window.djangoActivities);
    </script>

    <div class="flex h-full">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-800 shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:w-64 lg:flex-shrink-0 flex flex-col h-full max-h-full overflow-y-auto overflow-x-hidden">
            <div class="flex flex-col h-full">
                <!-- Header -->
                <div class="flex items-center justify-between h-16 px-4 border-b border-slate-700 flex-shrink-0">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">PM</span>
                        </div>
                        <span class="ml-2 text-lg font-bold text-white">ProjectManager</span>
                    </div>
                    <button id="sidebar-close" class="lg:hidden p-2 rounded-md text-slate-400 hover:text-slate-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Navigation -->
                <nav class="flex-1 px-2 py-4 overflow-y-auto">
                    <div class="space-y-1">
                        <a href="/dashboard/" class="bg-blue-900 text-blue-200 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-blue-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H10a2 2 0 01-2-2V5z"></path>
                            </svg>
                            Dashboard
                        </a>
                        
                        <a href="/projects/" class="text-slate-300 hover:bg-slate-700 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-slate-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            Projects
                        </a>
                        
                        {% if user.is_superuser %}
                        <a href="/projects/create/" class="text-slate-300 hover:bg-slate-700 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-slate-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            New Project
                        </a>
                        {% endif %}
                        
                        <a href="/analytics/" class="text-slate-300 hover:bg-slate-700 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-slate-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Analytics
                        </a>
                        
                        <a href="/team/" class="text-slate-300 hover:bg-slate-700 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-slate-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Team
                        </a>

                        <!-- EMAIL FUNCTIONALITY COMMENTED OUT
                        <a href="#" onclick="showClientEmailModal()" class="text-slate-300 hover:bg-slate-700 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-slate-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Client Emails
                        </a>
                        -->

                        {% if user.is_superuser %}
                        <a href="/admin-control/" class="text-slate-300 hover:bg-slate-700 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-slate-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Admin Control
                        </a>
                        
                        <a href="/system-logs/" class="text-slate-300 hover:bg-slate-700 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-slate-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            System Logs
                        </a>
                        
                        <a href="/permission-management/" class="text-slate-300 hover:bg-slate-700 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                            <svg class="text-slate-400 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            Permissions
                        </a>
                        {% endif %}
                    </div>
                </nav>
                
                <!-- User Section -->
                <div class="border-t border-slate-700 p-4 flex-shrink-0">
                    <div class="flex items-center mb-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-sm">E</span>
                        </div>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-white">Ethan</div>
                            <div class="text-xs text-slate-400">ethan@example.com</div>
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="flex items-center px-2 py-2 text-sm font-medium text-red-400 hover:bg-red-900/20 rounded-md w-full">
                        <svg class="mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-h-0 lg:ml-0 w-full max-w-full">
            <!-- Header -->
            <header class="bg-slate-800 shadow-lg border-b border-slate-700 flex-shrink-0">
                <div class="px-2 sm:px-4 lg:px-6 xl:px-8">
                    <div class="flex items-center justify-between h-12 sm:h-16">
                        <div class="flex items-center">
                            <button id="sidebar-toggle" class="lg:hidden p-2 rounded-md text-slate-400 hover:text-slate-200">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                            <div class="ml-2 lg:ml-0">
                                <h1 class="text-lg sm:text-xl font-semibold text-white">Dashboard</h1>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-4">
                            <button onclick="toggleTheme()" class="p-1.5 sm:p-2 rounded-xl bg-slate-700 hover:bg-slate-600 transition-all duration-300">
                                <svg id="theme-icon" class="w-4 h-4 sm:w-5 sm:h-5 text-slate-300" fill="currentColor" viewBox="0 0 24 24">
                                    <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <main class="flex-1 p-2 sm:p-4 lg:p-6 xl:p-8 overflow-auto min-h-0 max-w-full w-full dashboard-content">
            <!-- DEBUG: Test if JavaScript is working -->
            <div id="js-test" class="text-xs text-green-400 mb-2 p-2 bg-green-900/20 rounded border border-green-500/30" style="display: none;">
                ✅ JavaScript is working - formatDevelopmentStatus function loaded
            </div>
            
            <!-- DEBUG: Show raw data from backend -->
            <div id="raw-data-debug" class="text-xs text-yellow-400 mb-2 p-2 bg-yellow-900/20 rounded border border-yellow-500/30">
                🔍 Raw data from backend will appear here
            </div>
            
            <!-- DEBUG: Direct inline test -->
            <div id="inline-test" class="text-xs text-blue-400 mb-2 p-2 bg-blue-900/20 rounded border border-blue-500/30">
                🔧 Inline Test: <span id="test-result">Loading...</span>
            </div>
                <!-- Enhanced Gantt Chart -->
                <div class="bg-slate-800 rounded-xl shadow-2xl p-3 sm:p-4 lg:p-6 mb-4 sm:mb-6 lg:mb-8">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-2 sm:gap-4 mb-4 lg:mb-6">
                        <h2 class="text-base sm:text-lg lg:text-xl font-bold text-white">Project Timeline</h2>
                        
                        <!-- Controls -->
                        <div class="flex flex-wrap items-center gap-2 sm:gap-3 controls-container">
                            <select id="status-filter" class="px-2 py-1 sm:px-3 sm:py-2 bg-slate-700 border border-slate-600 rounded-lg text-xs sm:text-sm text-white">
                                <option value="">All Status</option>
                                <option value="planning">Planning</option>
                                <option value="in-progress">In Progress</option>
                                <option value="in-progress-guidance-required">In Progress (Guidance Required)</option>
                                <option value="waiting-feedback">Waiting Feedback</option>
                                <option value="completed">Completed</option>
                                <option value="completed-review-pending">Completed (Review Pending)</option>
                                <option value="reviewing-completed">Reviewing Completed</option>
                                <option value="completed-data-discrepancy-addressing">Completed (Data Discrepancy addressing)</option>
                                <option value="on-hold">On Hold</option>
                                <option value="blocked">Blocked</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="not-started">Not Started</option>
                            </select>
                            
                            <select id="priority-filter" class="px-2 py-1 sm:px-3 sm:py-2 bg-slate-700 border border-slate-600 rounded-lg text-xs sm:text-sm text-white">
                                <option value="">All Priority</option>
                                <option value="low">🟢 Low</option>
                                <option value="medium">🟡 Medium</option>
                                <option value="high">🔴 High</option>
                                <option value="urgent">🚨 Urgent</option>
                            </select>
                            
                            <select id="development-filter" class="px-2 py-1 sm:px-3 sm:py-2 bg-slate-700 border border-slate-600 rounded-lg text-xs sm:text-sm text-white">
                                <option value="">All Development</option>
                                <option value="original_quoted">Original/Quoted Development</option>
                                <option value="change_order">Change Order</option>
                                <option value="additional_work">Additional Work</option>
                                <option value="rework">Rework</option>
                                <option value="new_development">New Development</option>
                            </select>
                            
                            <div class="flex bg-slate-700 rounded-lg p-1">
                                <button id="week-view" class="px-2 py-1 text-xs sm:text-sm rounded bg-slate-600 shadow-sm text-white">Weeks</button>
                                <button id="month-view" class="px-2 py-1 text-xs sm:text-sm rounded text-slate-400">Months</button>
                            </div>
                            
                            <!-- EMAIL FUNCTIONALITY COMMENTED OUT
                            <button onclick="generatePDFReport()" class="px-2 py-1 sm:px-3 sm:py-2 bg-green-600 text-white rounded-lg text-xs sm:text-sm hover:bg-green-700 transition-colors">
                                📊 Report
                            </button>
                            -->
                        </div>
                    </div>
                    
                    <div class="gantt-container border border-slate-700 rounded-lg overflow-x-auto w-full">
                        <!-- Gantt Header -->
                        <div class="flex bg-slate-900 border-b border-slate-700 sticky top-0 z-10 gantt-header">
                            <!-- Y-axis header column -->
                            <div class="gantt-y-axis-header px-2 py-2 sm:py-3 border-r border-slate-700 flex-shrink-0" style="width: 40px; min-width: 40px; background: #dc2626 !important; border: 2px solid #ef4444 !important;">
                                <div class="text-xs sm:text-sm font-semibold text-white text-center">Y</div>
                            </div>
                            <div class="gantt-project-details px-2 sm:px-3 lg:px-4 py-2 sm:py-3 border-r border-slate-700 w-full min-w-[180px] max-w-full">
                                <div class="text-xs sm:text-sm font-semibold text-white">Projects</div>
                            </div>
                            <!-- Timeline header with Y-axis -->
                            <div class="gantt-timeline-header-container flex-1 flex">
                                <!-- Y-axis for timeline -->
                                <div class="gantt-y-axis-header px-2 py-2 sm:py-3 border-r border-slate-700 flex-shrink-0" style="width: 40px; min-width: 40px; background: #dc2626 !important; border: 2px solid #ef4444 !important;">
                                    <div class="text-xs sm:text-sm font-semibold text-white text-center">Y</div>
                                </div>
                                <div class="gantt-timeline-area flex" id="gantt-header" style="min-width: 400px; width: 100%"></div>
                            </div>
                        </div>
                        
                        <!-- Projects Container -->
                        <div id="projects-container" class="project-item">
                            <!-- Projects will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-4 flex flex-wrap items-center gap-4 text-xs text-slate-400">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-blue-500 rounded"></div>
                            <span>Project Timeline</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-400 rounded"></div>
                            <span>Weekly Tasks</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-400 rounded"></div>
                            <span>Overdue</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-yellow-400 rounded"></div>
                            <span>In Progress</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="bg-slate-800 rounded-xl shadow-2xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-white">Recent Activities</h2>
                        <a href="/projects/" class="text-sm text-blue-400 hover:text-blue-300">View All</a>
                    </div>
                    
                    <div id="activities-container" class="activities-grid">
                        <!-- Activities will be dynamically added here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Enhanced Tooltip with better styling -->
    <div id="tooltip" class="fixed text-white text-sm rounded-xl px-4 py-3 pointer-events-none opacity-0 transition-all duration-300 z-50 max-w-sm shadow-2xl">
        <div id="tooltip-content"></div>
        <!-- Tooltip arrow -->
        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
            <div class="w-3 h-3 bg-gray-900 transform rotate-45 border border-slate-600"></div>
        </div>
    </div>

    <script>
        // Dashboard State
        let dashboardData = {
            projects: [],
            activities: [],
            stats: {
                total: 0,
                inProgress: 0,
                completed: 0,
                planning: 0
            },
            currentView: 'weeks',
            selectedFilter: '',
            selectedPriorityFilter: '',
            selectedDevelopmentFilter: ''
        };

        // Initialize Dashboard
        function initDashboard() {
            console.log('🚀 NEW CODE VERSION - Dashboard initialization started');
            console.log('=== NEW CODE VERSION ===');
            
            // Initialize dashboard data
            dashboardData = {
                projects: [],
                activities: [],
                stats: {
                    total: 0,
                    inProgress: 0,
                    completed: 0,
                    planning: 0
                },
                currentView: 'weeks',
                selectedFilter: '',
                selectedPriorityFilter: '',
                selectedDevelopmentFilter: ''
            };
            
            // Load Django context data
            loadDjangoContextData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup animations
            setupAnimations();
            
            // Load fresh stats from server
            loadDashboardStats();
            
            // Debug test
            setTimeout(testDataLoading, 1000);
        }

        // Load Django Context Data
        function loadDjangoContextData() {
            console.log('📊 Loading Django context data...');
            
            if (window.djangoProjects && window.djangoProjects.length > 0) {
                dashboardData.projects = window.djangoProjects;
                console.log('✅ Projects loaded:', dashboardData.projects.length);
            } else {
                console.log('⚠️ No projects data found');
            }
            
            if (window.djangoActivities && window.djangoActivities.length > 0) {
                dashboardData.activities = window.djangoActivities;
                console.log('✅ Activities loaded:', dashboardData.activities.length);
            } else {
                console.log('⚠️ No activities data found');
            }
            
            // Calculate and render stats
            calculateLiveStats();
            renderDashboard();
        }

        // Load Dashboard Stats from Server
        async function loadDashboardStats() {
            try {
                console.log('📈 Loading stats from server...');
                const response = await fetch('/dashboard/stats/');
                
                if (response.ok) {
                    const stats = await response.json();
                    console.log('✅ Server stats loaded:', stats);
                    
                    // Update dashboard stats
                    dashboardData.stats = {
                        total: stats.total_projects || 0,
                        inProgress: stats.in_progress || 0,
                        completed: stats.completed || 0,
                        planning: stats.planning || 0
                    };
                    
                    // Render the updated stats
                    renderStats();
                } else {
                    console.log('⚠️ Stats API not available, using calculated stats');
                }
            } catch (error) {
                console.error('❌ Error loading stats:', error);
                // Fall back to calculated stats
                calculateLiveStats();
                renderStats();
            }
        }

        // Calculate Stats from Live Data
        function calculateLiveStats() {
            const projects = dashboardData.projects;
            console.log('🧮 Calculating stats from projects:', projects.length);
            
            dashboardData.stats = {
                total: projects.length,
                inProgress: projects.filter(p => p.status === 'in-progress').length,
                completed: projects.filter(p => p.status === 'completed').length,
                planning: projects.filter(p => p.status === 'planning').length
            };
            
            console.log('📊 Calculated stats:', dashboardData.stats);
        }

        // Render Complete Dashboard
        function renderDashboard() {
            console.log('🎨 Rendering dashboard...');
            renderStats();
            renderGanttChart();
            renderActivities();
        }

        // Render Stats Cards
        function renderStats() {
            const stats = dashboardData.stats;
            console.log('📈 Rendering stats:', stats);
            
            // Update stats immediately
            updateStatElement('total-projects', stats.total);
            updateStatElement('in-progress-projects', stats.inProgress);
            updateStatElement('completed-projects', stats.completed);
            updateStatElement('planning-projects', stats.planning);
        }

        function updateStatElement(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                console.log(`✅ Updated ${elementId}: ${value}`);
            } else {
                console.error(`❌ Element not found: ${elementId}`);
            }
        }

        // Test function
        function testDataLoading() {
            console.log('🔍 === DASHBOARD TEST RESULTS ===');
            console.log('Projects loaded:', dashboardData.projects.length);
            console.log('Activities loaded:', dashboardData.activities.length);
            console.log('Current stats:', dashboardData.stats);
            
            // Test stats elements
            const statsCheck = {
                'total-projects': document.getElementById('total-projects'),
                'in-progress-projects': document.getElementById('in-progress-projects'),
                'completed-projects': document.getElementById('completed-projects'),
                'planning-projects': document.getElementById('planning-projects')
            };
            
            Object.keys(statsCheck).forEach(id => {
                const element = statsCheck[id];
                if (element) {
                    console.log(`✅ ${id}: ${element.textContent}`);
                } else {
                    console.error(`❌ Missing element: ${id}`);
                }
            });
            
            console.log('🔍 === END TEST RESULTS ===');
        }

        // Render Gantt Chart
        function renderGanttChart() {
            if (dashboardData.projects.length === 0) {
                showNoDataMessage();
                return;
            }
            
            renderGanttHeader();
            renderProjects();
        }

        function renderGanttHeader() {
            const header = document.getElementById('gantt-header');
            if (!header) return;

            header.innerHTML = '';
            
            // Calculate timeline based on actual project dates or default
            const { startDate, endDate } = calculateProjectDateRange();
            const timelineWidth = header.parentElement.clientWidth;
            const columnCount = Math.max(4, Math.floor(timelineWidth / 100));
            const columnWidth = Math.floor(timelineWidth / columnCount);

            // Add Y-axis header column
            const yAxisHeader = document.createElement('div');
            yAxisHeader.className = 'flex-shrink-0 text-center px-2 py-3 text-xs font-medium text-slate-300 border-r border-slate-700 bg-slate-800';
            yAxisHeader.textContent = 'Y';
            yAxisHeader.style.width = '40px';
            yAxisHeader.style.minWidth = '40px';
            header.appendChild(yAxisHeader);

            for (let i = 0; i < columnCount; i++) {
                const col = document.createElement('div');
                col.className = 'flex-shrink-0 text-center px-2 py-3 text-xs font-medium text-slate-300 border-r border-slate-700 last:border-r-0';
                col.style.width = columnWidth + 'px';
                
                const currentDate = new Date();
                currentDate.setDate(currentDate.getDate() + (i * 7));
                
                if (dashboardData.currentView === 'weeks') {
                    col.innerHTML = `
                        <div class="font-semibold">${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                        <div class="text-slate-500">W${getWeekNumber(currentDate)}</div>
                    `;
                } else {
                    col.innerHTML = `
                        <div class="font-semibold">${currentDate.toLocaleDateString('en-US', { month: 'long' })}</div>
                        <div class="text-slate-500">${currentDate.getFullYear()}</div>
                    `;
                }
                
                header.appendChild(col);
            }
            
            // Draw today's line after header is updated
            setTimeout(() => drawTodayLine(), 50);
            
            // Add status legend
            addStatusLegend();
        }

        function calculateProjectDateRange() {
            const today = new Date();
            const projects = dashboardData.projects;
            
            if (projects.length === 0) {
                return {
                    startDate: today,
                    endDate: new Date(today.getTime() + (90 * 24 * 60 * 60 * 1000))
                };
            }
            
            // Find the earliest start date and latest end date from all projects
            let earliestDate = new Date();
            let latestDate = new Date();
            
            projects.forEach(project => {
                if (project.start_date) {
                    const startDate = new Date(project.start_date);
                    if (startDate < earliestDate) {
                        earliestDate = startDate;
                    }
                }
                if (project.end_date) {
                    const endDate = new Date(project.end_date);
                    if (endDate > latestDate) {
                        latestDate = endDate;
                    }
                }
            });
            
            // If no valid dates found, use default range
            if (earliestDate.getTime() === today.getTime() && latestDate.getTime() === today.getTime()) {
                return {
                    startDate: today,
                    endDate: new Date(today.getTime() + (90 * 24 * 60 * 60 * 1000))
                };
            }
            
            return {
                startDate: earliestDate,
                endDate: latestDate
            };
        }

        function addStatusLegend() {
            const headerContainer = document.getElementById('gantt-header');
            if (!headerContainer) return;
            
            // Create legend container
            const legendContainer = document.createElement('div');
            legendContainer.className = 'flex flex-wrap gap-4 px-4 py-3 bg-slate-800 border-b border-slate-700 text-xs';
            
            // Define status legend items
            const statusItems = [
                { status: 'completed', label: 'Completed', description: 'Project/Task completed' },
                { status: 'in-progress', label: 'In Progress', description: 'Currently being worked on' },
                { status: 'not-started', label: 'Not Started', description: 'Project/Task not yet begun' },
                { status: 'on-hold', label: 'On Hold', description: 'Project/Task temporarily paused' },
                { status: 'waiting-feedback', label: 'Waiting Feedback', description: 'Awaiting client input' },
                { status: 'planning', label: 'Planning', description: 'In planning phase' },
                { status: 'blocked', label: 'Blocked', description: 'Project/Task blocked' }
            ];
            
            statusItems.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center gap-2';
                
                const colorBox = document.createElement('div');
                const statusColors = getStatusBarColors(item.status);
                colorBox.style.width = '16px';
                colorBox.style.height = '16px';
                colorBox.style.background = statusColors.background;
                colorBox.style.border = statusColors.border;
                colorBox.style.borderRadius = '4px';
                colorBox.style.flexShrink = '0';
                
                const textContainer = document.createElement('div');
                textContainer.className = 'text-slate-300';
                textContainer.innerHTML = `
                    <div class="font-medium">${item.label}</div>
                    <div class="text-slate-500 text-xs">${item.description}</div>
                `;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(textContainer);
                legendContainer.appendChild(legendItem);
            });
            
            // Add progress overlay explanation
            const progressLegend = document.createElement('div');
            progressLegend.className = 'flex items-center gap-2 ml-auto';
            
            const progressBox = document.createElement('div');
            progressBox.style.width = '16px';
            progressBox.style.height = '16px';
            progressBox.style.background = 'rgba(255, 255, 255, 0.3)';
            progressBox.style.borderRadius = '4px';
            progressBox.style.flexShrink = '0';
            
            const progressText = document.createElement('div');
            progressText.className = 'text-slate-300';
            progressText.innerHTML = `
                <div class="font-medium">Progress Overlay</div>
                <div class="text-slate-500 text-xs">White overlay shows completion</div>
            `;
            
            progressLegend.appendChild(progressBox);
            progressLegend.appendChild(progressText);
            legendContainer.appendChild(progressLegend);
            
            // Insert legend after the header row
            const headerRow = headerContainer.querySelector('.flex');
            if (headerRow) {
                headerContainer.insertBefore(legendContainer, headerRow.nextSibling);
            }
        }

        function renderProjects() {
            console.log('🔄 NEW CODE - renderProjects function called');
            
            const container = document.getElementById('projects-container');
            if (!container) return;

            container.innerHTML = '';
            
            console.log('=== RENDER PROJECTS DEBUG ===');
            console.log('All projects data:', dashboardData.projects);
            dashboardData.projects.forEach((project, index) => {
                console.log(`Project ${index + 1}:`, project);
                console.log(`Project ${index + 1} development_status:`, project.development_status);
                console.log(`Project ${index + 1} developmentStatus:`, project.developmentStatus);
            });
            console.log('=== END RENDER PROJECTS DEBUG ===');
            
            let filteredProjects = dashboardData.projects;
            
            // Apply status filter
            if (dashboardData.selectedFilter) {
                filteredProjects = filteredProjects.filter(p => p.status === dashboardData.selectedFilter);
            }
            
            // Apply priority filter
            if (dashboardData.selectedPriorityFilter) {
                filteredProjects = filteredProjects.filter(p => p.priority === dashboardData.selectedPriorityFilter);
            }
            
            // Apply development status filter
            if (dashboardData.selectedDevelopmentFilter) {
                filteredProjects = filteredProjects.filter(p => 
                    (p.development_status === dashboardData.selectedDevelopmentFilter) || 
                    (p.developmentStatus === dashboardData.selectedDevelopmentFilter)
                );
            }

            if (filteredProjects.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-8 text-slate-400">
                        <p class="text-sm">No projects match the selected filter</p>
                    </div>
                `;
                return;
            }

            filteredProjects.forEach(project => {
                const projectElement = createProjectElement(project);
                container.appendChild(projectElement);
            });

            // Position project bars on timeline
            setTimeout(() => {
                positionProjectBars();
                drawTodayLine(); // Draw today's line after positioning bars
            }, 100);
        }

        function createProjectElement(project) {
            console.log('Project data:', project);
            console.log('Development status (snake_case):', project.development_status);
            console.log('Development status (camelCase):', project.developmentStatus);
            
            const projectDiv = document.createElement('div');
            projectDiv.className = 'project-item fade-in';
            projectDiv.dataset.projectId = project.id;
            
            const statusColors = {
                'not-started': 'bg-red-900 text-red-200',
                'not_started': 'bg-red-900 text-red-200',
                'in-progress': 'bg-yellow-900 text-yellow-200',
                'in_progress': 'bg-yellow-900 text-yellow-200',
                'in-progress-guidance-required': 'bg-orange-900 text-orange-200',
                'in_progress_guidance_required': 'bg-orange-900 text-orange-200',
                'waiting-feedback': 'bg-orange-900 text-orange-200',
                'waiting_feedback': 'bg-orange-900 text-orange-200',
                'completed': 'bg-green-900 text-green-200',
                'completed-review-pending': 'bg-green-700 text-green-100',
                'completed_review_pending': 'bg-green-700 text-green-100',
                'reviewing-completed': 'bg-green-700 text-green-100',
                'reviewing_completed': 'bg-green-700 text-green-100',
                'completed-data-discrepancy-addressing': 'bg-green-700 text-green-100',
                'completed_data_discrepancy_addressing': 'bg-green-700 text-green-100',
                'on-hold': 'bg-gray-800 text-gray-200',
                'on_hold': 'bg-gray-800 text-gray-200',
                'cancelled': 'bg-gray-400 text-gray-100',
                'planning': 'bg-purple-900 text-purple-200',
                'blocked': 'bg-red-800 text-red-100'
            };

            // Handle both Django model field names and camelCase
            const projectName = project.name || project.title || 'Untitled Project';
            const client = (project.client && project.client.trim()) ? project.client.trim() : 'Client Not Set';
            const startDate = project.start_date || project.startDate || null;
            const endDate = project.end_date || project.endDate || null;
            const status = project.status || 'planning';
            const weeks = project.weeks || project.weekly_tasks || [];
            
            // Calculate progress based on completed tasks vs total tasks
            let progress = 0;
            if (weeks && weeks.length > 0) {
                let totalTasks = 0;
                let completedTasks = 0;
                
                weeks.forEach(week => {
                    const weekTotal = parseInt(week.total_tasks || week.totalTasks || 0);
                    const weekCompleted = parseInt(week.completed_tasks || week.completedTasks || 0);
                    totalTasks += weekTotal;
                    completedTasks += weekCompleted;
                });
                
                if (totalTasks > 0) {
                    progress = Math.round((completedTasks / totalTasks) * 100);
                }
            } else {
                // Fallback to project.progress if no weekly data
                progress = project.progress || 0;
            }
            
            console.log(`Project ${projectName} progress calculation:`, {
                weeks: weeks,
                totalTasks: weeks ? weeks.reduce((sum, w) => sum + (parseInt(w.total_tasks || w.totalTasks || 0)), 0) : 0,
                completedTasks: weeks ? weeks.reduce((sum, w) => sum + (parseInt(w.completed_tasks || w.completedTasks || 0)), 0) : 0,
                calculatedProgress: progress,
                originalProgress: project.progress
            });

            projectDiv.innerHTML = `
                <!-- Main Project Row -->
                <div class="flex border-b border-slate-700 hover:bg-slate-700/50 transition-colors group">
                    <!-- Y-axis column -->
                    <div class="gantt-y-axis px-2 py-4 border-r border-slate-700 bg-slate-800 flex-shrink-0" style="width: 40px; min-width: 40px; background: #dc2626 !important; border: 2px solid #ef4444 !important;">
                        <div class="w-full h-full border-l-2 border-slate-600"></div>
                    </div>
                    
                    <div class="gantt-project-details px-4 py-4 border-r border-slate-700">
                        <div class="flex items-center gap-3">
                            ${weeks.length > 0 ? `
                            <button onclick="toggleProjectWeeks(${project.id})" 
                                    class="project-toggle w-5 h-5 text-slate-400 hover:text-slate-300 transition-transform" 
                                    data-project-id="${project.id}">
                                <svg class="w-5 h-5 transform transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            ` : '<div class="w-5 h-5"></div>'}
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="text-sm font-semibold text-white truncate">${projectName}</h3>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[status]} flex-shrink-0">
                                        ${status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' ')}
                                    </span>
                                </div>
                                
                                <div class="text-xs text-slate-400 mb-2">
                                    <span class="mr-3">📅 ${formatDate(startDate)} - ${formatDate(endDate)}</span>
                                    <span class="mr-3">🏢 ${client}</span>
                                    <span class="mr-3">⚡ ${project.priority || 'medium'}</span>
                                    <span class="mr-3">🔧 ${formatDevelopmentStatus(project.development_status || project.developmentStatus || 'original_quoted')}</span>
                                    <!-- DEBUG: Raw value: ${project.development_status} -->
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-slate-600 rounded-full h-2">
                                        <div class="h-2 rounded-full bg-blue-500 transition-all duration-500" style="width: ${progress}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-white w-10">${progress}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gantt-timeline-area flex">
                        <!-- Y-axis column for timeline -->
                        <div class="gantt-y-axis px-2 py-4 border-r border-slate-700 bg-slate-800 flex-shrink-0" style="width: 40px; min-width: 40px; background: #dc2626 !important; border: 2px solid #ef4444 !important;">
                            <div class="w-full h-full border-l-2 border-slate-600"></div>
                        </div>
                        <!-- Timeline area -->
                        <div class="relative gantt-timeline py-4 flex-1" 
                             data-project-id="${project.id}"
                             data-start="${startDate}" 
                             data-end="${endDate}"
                             data-status="${status}"
                             data-progress="${progress}"
>
                            <!-- Project bar will be positioned by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Weekly Breakdown -->
                ${weeks.length > 0 ? `
                <div class="project-weeks hidden" id="weeks-${project.id}">
                    ${weeks.map((week, index) => `
                        <div class="flex border-b border-slate-800 hover:bg-slate-800/30 transition-colors">
                            <!-- Y-axis column for week rows -->
                            <div class="gantt-y-axis px-2 py-3 border-r border-slate-700 bg-slate-800 flex-shrink-0" style="width: 40px; min-width: 40px; background: #dc2626 !important; border: 2px solid #ef4444 !important;">
                                <div class="w-full h-full border-l-2 border-slate-500 opacity-50"></div>
                            </div>
                            
                            <div class="gantt-project-details px-4 py-3 border-r border-slate-700">
                                <div class="flex items-center gap-3 pl-8">
                                    <div class="w-2 h-2 bg-blue-400 rounded-full flex-shrink-0"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-slate-300">Week ${week.week_number || index + 1}</div>
                                        <div class="text-xs text-slate-400">
                                            ${formatDate(week.start_date || week.startDate)} - ${formatDate(week.end_date || week.endDate)}
                                            <span class="ml-2">📋 ${week.total_tasks || week.totalTasks || 0}</span> 
                                            <span class="ml-2">✅ ${week.completed_tasks || week.completedTasks || 0}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="gantt-timeline-area flex">
                                <!-- Y-axis column for timeline -->
                                <div class="gantt-y-axis px-2 py-3 border-r border-slate-700 bg-slate-800 flex-shrink-0" style="width: 40px; min-width: 40px; background: #dc2626 !important; border: 2px solid #ef4444 !important;">
                                    <div class="w-full h-full border-l-2 border-slate-500 opacity-50"></div>
                                </div>
                                <!-- Timeline area -->
                                <div class="relative gantt-timeline py-3 flex-1" 
                                     data-start="${week.start_date || week.startDate || ''}" 
                                     data-end="${week.end_date || week.endDate || ''}"
                                     data-tasks="${week.total_tasks || week.totalTasks || 0}"
                                     data-completed="${week.completed_tasks || week.completedTasks || 0}"
                                     data-week="true">
                                    <!-- Week bar will be positioned by JavaScript -->
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            `;
            console.log('PROJECT:', project);

            // Add Gantt bars after DOM insertion
            setTimeout(() => {
                addGanttBars(projectDiv);
                setupTooltips(projectDiv);
            }, 10);

            return projectDiv;
        }

        function addGanttBars(projectElement) {
            const timelines = projectElement.querySelectorAll('.gantt-timeline');
            const headerCells = document.querySelectorAll('#gantt-header > div');
            const timelineWidth = headerCells.length > 0 ? headerCells[0].parentElement.clientWidth : 600;
            
            timelines.forEach(timeline => {
                timeline.innerHTML = '';
                
                const startDate = new Date(timeline.dataset.start);
                const endDate = new Date(timeline.dataset.end);
                const isWeek = timeline.dataset.week === 'true';
                
                // Calculate position and width
                const today = new Date();
                const daysFromToday = Math.floor((startDate - today) / (1000 * 60 * 60 * 24));
                const duration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
                
                const startPercent = Math.max(0.1, (daysFromToday + 30) / 120); // Assume 120 day view
                const widthPercent = Math.min(duration / 120, 0.8);
                
                const bar = document.createElement('div');
                bar.className = 'gantt-bar';
                
                if (isWeek) {
                    // Week bar
                    const tasks = parseInt(timeline.dataset.tasks) || 0;
                    const completed = parseInt(timeline.dataset.completed) || 0;
                    
                    bar.style.height = '16px';
                    bar.style.left = (startPercent * timelineWidth) + 'px';
                    bar.style.width = Math.max(widthPercent * timelineWidth, 20) + 'px';
                    
                    // Determine week status based on task completion
                    let weekStatus = 'not-started';
                    if (tasks === 0) {
                        weekStatus = 'on-hold';
                    } else if (completed === tasks && tasks > 0) {
                        weekStatus = 'completed';
                    } else if (completed > 0) {
                        weekStatus = 'in-progress';
                    }
                    
                    // Use status-based colors for week bars
                    const statusColors = getStatusBarColors(weekStatus);
                    bar.style.background = statusColors.background;
                    bar.style.border = statusColors.border;
                    
                    // Add status data attributes
                    bar.setAttribute('data-status', weekStatus);
                    bar.classList.add(`status-${weekStatus.replace(/[^a-zA-Z0-9]/g, '-')}`);
                    
                    // Add progress overlay for weeks with tasks
                    if (tasks > 0) {
                        const progressBar = document.createElement('div');
                        progressBar.className = 'gantt-progress-overlay';
                        progressBar.style.position = 'absolute';
                        progressBar.style.top = '0';
                        progressBar.style.left = '0';
                        progressBar.style.height = '100%';
                        progressBar.style.width = `${(completed/tasks*100)}%`;
                        progressBar.style.background = 'rgba(255, 255, 255, 0.3)';
                        progressBar.style.borderRadius = '6px';
                        progressBar.style.zIndex = '2';
                        progressBar.style.pointerEvents = 'none';
                        
                        bar.appendChild(progressBar);
                        bar.setAttribute('data-progress', Math.round((completed/tasks*100)));
                    }
                } else {
                    // Project bar
                    const status = timeline.dataset.status;
                    const progress = parseInt(timeline.dataset.progress) || 0;
                    
                    bar.style.height = '24px';
                    bar.style.left = (startPercent * timelineWidth) + 'px';
                    bar.style.width = Math.max(widthPercent * timelineWidth, 40) + 'px';
                    
                    // Use status-based colors for the main bar
                    const statusColors = getStatusBarColors(status);
                    bar.style.background = statusColors.background;
                    bar.style.border = statusColors.border;
                    
                    // Add status data attributes for styling
                    bar.setAttribute('data-status', status);
                    bar.classList.add(`status-${status.replace(/[^a-zA-Z0-9]/g, '-')}`);
                    
                    // Add progress overlay if there's progress
                    if (progress > 0) {
                        // Create progress overlay bar
                        const progressBar = document.createElement('div');
                        progressBar.className = 'gantt-progress-overlay';
                        progressBar.style.position = 'absolute';
                        progressBar.style.top = '0';
                        progressBar.style.left = '0';
                        progressBar.style.height = '100%';
                        progressBar.style.width = `${progress}%`;
                        progressBar.style.background = 'rgba(255, 255, 255, 0.3)';
                        progressBar.style.borderRadius = '6px';
                        progressBar.style.zIndex = '2';
                        progressBar.style.pointerEvents = 'none';
                        
                        bar.appendChild(progressBar);
                        bar.setAttribute('data-progress', progress);
                        
                        // Add glow effect for completed projects
                        if (progress >= 100) {
                            bar.style.boxShadow = '0 0 15px rgba(34, 197, 94, 0.6)';
                        }
                        
                        console.log(`Project bar: Status ${status}, Progress ${progress}%`);
                    } else {
                        bar.removeAttribute('data-progress');
                        console.log(`Project bar: Status ${status}, No progress`);
                    }
                }
                
                timeline.appendChild(bar);
                bar.setAttribute('tabindex', '0');
                bar.setAttribute('aria-label', isWeek ? 'View week details' : 'View project details');
                bar.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter' || ev.key === ' ') {
                        handleBarClick(ev, bar);
                    }
                });
            });
        }

        function setupTooltips(element) {
            const bars = element.querySelectorAll('.gantt-bar');
            
            bars.forEach(bar => {
                bar.addEventListener('mouseenter', (e) => showTooltip(e, bar));
                bar.addEventListener('mouseleave', hideTooltip);
                bar.addEventListener('mousemove', updateTooltipPosition);
                bar.addEventListener('click', (e) => handleBarClick(e, bar));
            });
        }

        function showTooltip(e, bar) {
            console.log('=== SHOW TOOLTIP DEBUG ===');
            console.log('Tooltip triggered for bar:', bar);
            console.log('Event:', e);
            
            const tooltip = document.getElementById('tooltip');
            const content = document.getElementById('tooltip-content');
            
            console.log('Tooltip element found:', !!tooltip);
            console.log('Content element found:', !!content);
            
            // Determine if this is a project or week bar
            const timeline = bar.closest('.gantt-timeline');
            const isWeek = timeline.dataset.week === 'true';
            
            console.log('Is week bar:', isWeek);
            console.log('Timeline dataset:', timeline.dataset);
            
            let html = '';
            
            if (isWeek) {
                // Week task tooltip
                const tasks = parseInt(timeline.dataset.tasks) || 0;
                const completed = parseInt(timeline.dataset.completed) || 0;
                const remaining = tasks - completed;
                const completionRate = tasks > 0 ? Math.round((completed / tasks) * 100) : 0;
                
                const projectRow = timeline.closest('.project-item');
                const projectName = projectRow.querySelector('h3').textContent;
                const weekElement = timeline.closest('.project-weeks').querySelector('.text-sm.font-medium');
                const weekNumber = weekElement ? weekElement.textContent : 'Week';
                
                // Determine status text
                let statusText = 'Not Started';
                if (completed === tasks && tasks > 0) {
                    statusText = 'Completed';
                } else if (completed > 0) {
                    statusText = 'In Progress';
                }
                
                // Format dates safely
                const startDate = timeline.dataset.start;
                const endDate = timeline.dataset.end;
                const startDateFormatted = startDate && startDate !== 'null' ? formatDate(startDate) : 'Not Set';
                const endDateFormatted = endDate && endDate !== 'null' ? formatDate(endDate) : 'Not Set';
                
                html = `
                    <div class="space-y-2">
                        <div class="font-semibold text-blue-300 border-b border-slate-600 pb-1">
                            ${projectName} - ${weekNumber}
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div class="text-slate-300">
                                <div class="text-slate-400">Period</div>
                                <div class="font-medium">${startDateFormatted} - ${endDateFormatted}</div>
                            </div>
                            <div class="text-slate-300">
                                <div class="text-slate-400">Status</div>
                                <div class="font-medium">${statusText}</div>
                            </div>
                        </div>
                        <div class="space-y-1 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">📋 Total Tasks:</span>
                                <span class="text-white font-medium">${tasks}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-400">✅ Completed:</span>
                                <span class="text-green-300 font-medium">${completed}</span>
                            </div>
                            ${remaining > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-yellow-400">⏳ Remaining:</span>
                                <span class="text-yellow-300 font-medium">${remaining}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${tasks > 0 ? `
                        <div class="mt-2 pt-2 border-t border-slate-600">
                            <div class="text-xs text-slate-400 mb-1">Progress</div>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full transition-all duration-300" style="width: ${completionRate}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="text-xs text-slate-500 italic mt-2 pt-2 border-t border-slate-600">
                            Click to view task details
                        </div>
                    </div>
                `;
            } else {
                // Project bar tooltip
                const status = timeline.dataset.status;
                const progress = parseInt(timeline.dataset.progress) || 0;
                const projectElement = timeline.closest('.project-item');
                const projectName = projectElement.querySelector('h3').textContent;
                const clientElement = projectElement.querySelector('.text-xs.text-slate-400');
                const client = clientElement ? clientElement.textContent.split('🏢')[1]?.trim() || 'Client Not Set' : 'Client Not Set';
                
                // Get project weeks data
                const weeks = projectElement.querySelectorAll('.project-weeks .gantt-timeline[data-week="true"]');
                let totalWeeklyTasks = 0;
                let completedWeeklyTasks = 0;
                
                weeks.forEach(week => {
                    totalWeeklyTasks += parseInt(week.dataset.tasks) || 0;
                    completedWeeklyTasks += parseInt(week.dataset.completed) || 0;
                });
                
                const statusIcon = getStatusIcon(status);
                const statusColor = getStatusColor(status);
                
                // Debug development status data
                console.log('=== Tooltip Development Status Debug ===');
                console.log('Project object:', project);
                console.log('project.development_status:', project.development_status);
                console.log('project.developmentStatus:', project.developmentStatus);
                console.log('Fallback value:', 'original_quoted');
                console.log('Final value being formatted:', project.development_status || project.developmentStatus || 'original_quoted');
                console.log('=== End Tooltip Debug ===');
                
                // Calculate duration only if both dates are valid
                const startDate = timeline.dataset.start;
                const endDate = timeline.dataset.end;
                let durationDays = 'Not Set';
                if (startDate && endDate && startDate !== 'null' && endDate !== 'null') {
                    try {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                            durationDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + ' days';
                        }
                    } catch (error) {
                        durationDays = 'Invalid Dates';
                    }
                }
                
                html = `
                    <div class="space-y-3">
                        <div class="font-semibold text-blue-300 border-b border-slate-600 pb-2">
                            ${projectName}
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div class="text-slate-300">
                                <div class="text-slate-400">Client</div>
                                <div class="font-medium">${client}</div>
                            </div>
                            <div class="text-slate-300">
                                <div class="text-slate-400">Status</div>
                                <div class="font-medium ${statusColor}">${statusIcon} ${status}</div>
                            </div>
                            <div class="text-slate-300">
                                <div class="text-slate-400">Priority</div>
                                <div class="font-medium">${getPriorityIcon(project.priority || 'medium')} ${(project.priority || 'medium').charAt(0).toUpperCase() + (project.priority || 'medium').slice(1)}</div>
                            </div>
                            <div class="text-slate-300">
                                <div class="text-slate-400">Development</div>
                                <div class="font-medium">${formatDevelopmentStatus(project.development_status || project.developmentStatus || 'original_quoted')}</div>
                            </div>
                            <div class="text-slate-300">
                                <div class="text-slate-400">Duration</div>
                                <div class="font-medium">${durationDays}</div>
                            </div>
                            <div class="text-slate-300">
                                <div class="text-slate-400">Progress</div>
                                <div class="font-medium">${progress}%</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="text-xs text-slate-400">Project Timeline</div>
                            <div class="text-xs">
                                <div class="flex justify-between mb-1">
                                    <span class="text-slate-400">📅 Start:</span>
                                    <span class="text-white">${startDate && startDate !== 'null' ? formatDate(startDate) : 'Not Set'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">📅 End:</span>
                                    <span class="text-white">${endDate && endDate !== 'null' ? formatDate(endDate) : 'Not Set'}</span>
                                </div>
                            </div>
                        </div>
                        ${totalWeeklyTasks > 0 ? `
                        <div class="space-y-2 pt-2 border-t border-slate-600">
                            <div class="text-xs text-slate-400">Weekly Tasks Summary</div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">📋 Total:</span>
                                    <span class="text-white font-medium">${totalWeeklyTasks}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-400">✅ Done:</span>
                                    <span class="text-green-300 font-medium">${completedWeeklyTasks}</span>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="mt-3 pt-2 border-t border-slate-600">
                            <div class="text-xs text-slate-400 mb-1">Overall Progress</div>
                            <div class="w-full bg-slate-700 rounded-full h-2.5 mb-1">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                            <div class="text-xs text-center text-slate-300 font-medium">${progress}% Complete</div>
                        </div>
                        <div class="text-xs text-slate-500 italic mt-2 pt-2 border-t border-slate-600">
                            Click to view project details
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            tooltip.style.opacity = '1';
            updateTooltipPosition(e);
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.opacity = '0';
        }

        function updateTooltipPosition(e) {
            const tooltip = document.getElementById('tooltip');
            const rect = tooltip.getBoundingClientRect();
            let left = e.pageX + 15;
            let top = e.pageY - rect.height - 10;
            
            // Keep tooltip in viewport
            if (left + rect.width > window.innerWidth) {
                left = e.pageX - rect.width - 15;
            }
            if (top < 0) {
                top = e.pageY + 15;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function handleBarClick(e, bar) {
            e.stopPropagation();
            
            const timeline = bar.closest('.gantt-timeline');
            const isWeek = timeline.dataset.week === 'true';
            
            if (isWeek) {
                // Navigate to week edit page
                const projectId = timeline.closest('.project-item').dataset.projectId;
                const weekId = timeline.closest('.gantt-timeline').id?.split('-')[1];
                if (projectId && weekId) {
                    window.location.href = `/projects/${projectId}/weeks/${weekId}/edit/`;
                }
            } else {
                // Navigate to project details
                const projectId = timeline.dataset.projectId;
                if (projectId) {
                    window.location.href = `/projects/${projectId}/`;
                }
            }
        }

        // EMAIL FUNCTIONALITY COMMENTED OUT - Professional PDF Report Generation - FIXED
        /*
        async function generatePDFReport() {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '⏳ Generating...';
                button.disabled = true;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // PDF dimensions
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let yPosition = margin;

                // Helper function to check if we need a new page
                const checkNewPage = (requiredSpace = 30) => {
                    if (yPosition + requiredSpace > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                    }
                };

                // Company Header with better styling
                pdf.setFillColor(15, 23, 42); // slate-900
                pdf.rect(0, 0, pageWidth, 50, 'F');
                
                // Logo
                pdf.setFillColor(59, 130, 246); // blue-500
                pdf.roundedRect(margin, 12, 10, 10, 2, 2, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(7);
                pdf.text('PM', margin + 5, 19);

                // Title
                pdf.setFontSize(20);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(255, 255, 255);
                pdf.text('PROJECT PROGRESS REPORT', margin + 15, 20);
                
                // Date and user
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                const reportDate = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
                pdf.text(`Generated: ${reportDate}`, margin + 15, 30);
                pdf.text('Prepared by: Ethan', margin + 15, 38);

                yPosition = 65;

                // Executive Summary Section
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('EXECUTIVE SUMMARY', margin, yPosition);
                yPosition += 12;

                // Summary box
                pdf.setFillColor(248, 250, 252); // slate-50
                pdf.setDrawColor(203, 213, 225); // slate-300
                pdf.roundedRect(margin, yPosition, pageWidth - (margin * 2), 35, 3, 3, 'FD');

                const stats = dashboardData.stats;
                const summaryItems = [
                    { label: 'Total Projects', value: stats.total, x: margin + 5, y: yPosition + 8 },
                    { label: 'In Progress', value: stats.inProgress, x: margin + 50, y: yPosition + 8 },
                    { label: 'Completed', value: stats.completed, x: margin + 95, y: yPosition + 8 },
                    { label: 'Planning', value: stats.planning, x: margin + 140, y: yPosition + 8 }
                ];

                summaryItems.forEach(item => {
                    pdf.setFontSize(8);
                    pdf.setTextColor(71, 85, 105); // slate-600
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(item.label, item.x, item.y);
                    
                    pdf.setFontSize(14);
                    pdf.setTextColor(15, 23, 42); // slate-900
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(item.value.toString(), item.x, item.y + 8);
                });

                // Overall health
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Overall Status: ${getOverallHealth()}`, margin + 5, yPosition + 25);

                yPosition += 50;

                // Projects Section
                if (dashboardData.projects.length > 0) {
                    checkNewPage(40);
                    
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('PROJECT DETAILS', margin, yPosition);
                    yPosition += 15;

                    dashboardData.projects.forEach((project, index) => {
                        checkNewPage(60);

                        // Project container
                        pdf.setFillColor(255, 255, 255);
                        pdf.setDrawColor(203, 213, 225);
                        pdf.roundedRect(margin, yPosition, pageWidth - (margin * 2), 50, 2, 2, 'FD');

                        // Project name and status
                        pdf.setFontSize(12);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(15, 23, 42);
                        const projectName = (project.name || 'Untitled Project').substring(0, 40);
                        pdf.text(projectName, margin + 5, yPosition + 10);

                        // Status badge
                        const statusColor = getStatusColorRGB(project.status);
                        pdf.setFillColor(statusColor.r, statusColor.g, statusColor.b);
                        const statusWidth = 20;
                        pdf.roundedRect(pageWidth - margin - statusWidth - 5, yPosition + 3, statusWidth, 7, 2, 2, 'F');
                        
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'bold');
                        const statusText = (project.status || 'unknown').charAt(0).toUpperCase() + 
                                         (project.status || 'unknown').slice(1).replace('-', ' ');
                        // Calculate text width to center it
                        const textWidth = pdf.getTextWidth(statusText);
                        const textX = pageWidth - margin - statusWidth + (statusWidth - textWidth) / 2 - 5;
                        pdf.text(statusText, textX, yPosition + 8);

                        // Project details grid
                        pdf.setTextColor(71, 85, 105);
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'normal');
                        
                        const details = [
                            `Client: ${(project.client || 'Unknown').substring(0, 25)}`,
                            `Progress: ${project.progress || 0}%`,
                            `Start: ${formatDateShort(project.start_date)}`,
                            `End: ${formatDateShort(project.end_date)}`
                        ];

                        details.forEach((detail, i) => {
                            const x = margin + 5 + (i % 2) * 85;
                            const y = yPosition + 22 + Math.floor(i / 2) * 8;
                            pdf.text(detail, x, y);
                        });

                        // Progress bar
                        const progressBarY = yPosition + 38;
                        const progressBarWidth = pageWidth - (margin * 2) - 10;
                        const progress = project.progress || 0;
                        
                        // Background
                        pdf.setFillColor(226, 232, 240);
                        pdf.rect(margin + 5, progressBarY, progressBarWidth, 4, 'F');
                        
                        // Progress fill
                        if (progress > 0) {
                            pdf.setFillColor(34, 197, 94);
                            pdf.rect(margin + 5, progressBarY, (progressBarWidth * progress / 100), 4, 'F');
                        }
                        
                        // Progress text
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFontSize(8);
                        pdf.text(`${progress}%`, margin + progressBarWidth - 10, progressBarY + 3);

                        yPosition += 60;

                        // Weekly breakdown (if space allows)
                        const weeks = project.weeks || [];
                        if (weeks.length > 0 && weeks.length <= 4) { // Only show if reasonable number
                            checkNewPage(20 + (weeks.length * 6));
                            
                            pdf.setFontSize(10);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(0, 0, 0);
                            pdf.text('Weekly Progress:', margin + 5, yPosition);
                            yPosition += 8;

                            weeks.slice(0, 6).forEach((week, weekIndex) => { // Limit to 6 weeks
                                const totalTasks = week.total_tasks || 0;
                                const completedTasks = week.completed_tasks || 0;
                                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                                pdf.setFontSize(8);
                                pdf.setFont('helvetica', 'normal');
                                pdf.setTextColor(71, 85, 105);
                                
                                const weekText = `W${week.week_number || weekIndex + 1}: ${completedTasks}/${totalTasks} tasks (${completionRate}%)`;
                                pdf.text(weekText, margin + 10, yPosition);
                                
                                // Mini progress bar
                                const miniBarWidth = 30;
                                pdf.setFillColor(226, 232, 240);
                                pdf.rect(margin + 120, yPosition - 2, miniBarWidth, 3, 'F');
                                if (completionRate > 0) {
                                    pdf.setFillColor(34, 197, 94);
                                    pdf.rect(margin + 120, yPosition - 2, (miniBarWidth * completionRate / 100), 3, 'F');
                                }

                                yPosition += 6;
                            });

                            yPosition += 5;
                        }
                    });
                }

                // Footer on all pages
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    
                    // Footer line
                    pdf.setDrawColor(203, 213, 225);
                    pdf.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
                    
                    pdf.setFontSize(8);
                    pdf.setTextColor(107, 114, 128);
                    pdf.text('ProjectManager Dashboard', margin, pageHeight - 8);
                    pdf.text(`Page ${i} of ${totalPages}`, pageWidth - margin - 15, pageHeight - 8);
                    pdf.text(reportDate, pageWidth / 2 - 15, pageHeight - 8);
                }

                // Save with better filename
                const filename = `Project_Report_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.pdf`;
                pdf.save(filename);

                // Reset button
                button.innerHTML = originalText;
                button.disabled = false;

                console.log('✅ PDF report generated successfully');

            } catch (error) {
                console.error('❌ Error generating PDF:', error);
                alert('Error generating PDF report. Please try again.');
                
                // Reset button
                if (event && event.target) {
                    event.target.innerHTML = '📊 PDF Report';
                    event.target.disabled = false;
                }
            }
        }
        */

        // EMAIL FUNCTIONALITY COMMENTED OUT - Helper function for shorter date format
        /*
        function formatDateShort(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric'
            });
        }
        */

        // EMAIL FUNCTIONALITY COMMENTED OUT - Helper functions for PDF generation
        /*
        function getOverallHealth() {
            const stats = dashboardData.stats;
            if (stats.total === 0) return 'No Projects';
            
            const activeProjects = stats.inProgress;
            const completedProjects = stats.completed;
            const totalProjects = stats.total;
            
            const completionRate = (completedProjects / totalProjects) * 100;
            const activeRate = (activeProjects / totalProjects) * 100;
            
            if (completionRate >= 50) return '🟢 Excellent';
            if (activeRate >= 50) return '🟡 Good Progress';
            return '🟠 Needs Attention';
        }
        */

        // EMAIL FUNCTIONALITY COMMENTED OUT - PDF helper functions
        /*
        function getStatusColorRGB(status) {
            const colors = {
                'not-started': { r: 239, g: 68, b: 68 },   // red-500
                'not_started': { r: 239, g: 68, b: 68 },   // red-500
                'in-progress': { r: 245, g: 158, b: 11 },  // yellow-500
                'in_progress': { r: 245, g: 158, b: 11 },  // yellow-500
                'in-progress-guidance-required': { r: 249, g: 115, b: 22 }, // orange-500
                'in_progress_guidance_required': { r: 249, g: 115, b: 22 }, // orange-500
                'waiting-feedback': { r: 249, g: 115, b: 22 }, // orange-500
                'waiting_feedback': { r: 249, g: 115, b: 22 }, // orange-500
                'completed': { r: 34, g: 197, b: 94 },     // green-500
                'completed-review-pending': { r: 34, g: 197, b: 94 }, // green-500
                'completed_review_pending': { r: 34, g: 197, b: 94 }, // green-500
                'reviewing-completed': { r: 34, g: 197, b: 94 }, // green-500
                'reviewing_completed': { r: 34, g: 197, b: 94 }, // green-500
                'completed-data-discrepancy-addressing': { r: 34, g: 197, b: 94 }, // green-500
                'completed_data_discrepancy_addressing': { r: 34, g: 197, b: 94 }, // green-500
                'on-hold': { r: 75, g: 85, b: 99 },       // gray-600
                'on_hold': { r: 75, g: 85, b: 99 },       // gray-600
                'cancelled': { r: 156, g: 163, b: 175 },   // gray-400
                'planning': { r: 245, g: 158, b: 11 },    // amber-500
                'blocked': { r: 239, g: 68, b: 68 }       // red-500
            };
            return colors[status] || colors['planning'];
        }

        function getStatusIcon(status) {
            const icons = {
                'not-started': '🔴',
                'not_started': '🔴',
                'in-progress': '🟡',
                'in_progress': '🟡',
                'in-progress-guidance-required': '🟠',
                'in_progress_guidance_required': '🟠',
                'waiting-feedback': '🟠',
                'waiting_feedback': '🟠',
                'completed': '🟢',
                'completed-review-pending': '🟢',
                'completed_review_pending': '🟢',
                'reviewing-completed': '🟢',
                'reviewing_completed': '🟢',
                'completed-data-discrepancy-addressing': '🟢',
                'completed_data_discrepancy_addressing': '🟢',
                'on-hold': '⚫',
                'on_hold': '⚫',
                'cancelled': '⚪',
                'planning': '📋',
                'blocked': '🚫'
            };
            return icons[status] || '📊';
        }

        function getStatusColor(status) {
            const colors = {
                'not-started': 'text-red-400',
                'not_started': 'text-red-400',
        */
                'in-progress': 'text-yellow-400',
                'in_progress': 'text-yellow-400',
                'in-progress-guidance-required': 'text-orange-400',
                'in_progress_guidance_required': 'text-orange-400',
                'waiting-feedback': 'text-orange-400',
                'waiting_feedback': 'text-orange-400',
                'completed': 'text-green-400',
                'completed-review-pending': 'text-green-300',
                'completed_review_pending': 'text-green-300',
                'reviewing-completed': 'text-green-300',
                'reviewing_completed': 'text-green-300',
                'completed-data-discrepancy-addressing': 'text-green-300',
                'completed_data_discrepancy_addressing': 'text-green-300',
                'on-hold': 'text-gray-400',
                'on_hold': 'text-gray-400',
                'cancelled': 'text-gray-300',
                'planning': 'text-yellow-400',
                'blocked': 'text-red-400'
            };
            return colors[status] || 'text-gray-400';
        }
        */

        // EMAIL FUNCTIONALITY COMMENTED OUT - PDF helper functions
        /*
        function getStatusBarColors(status) {
            const colors = {
                'not-started': { background: '#ef4444', border: '2px solid #dc2626' },           // red-500 with red-600 border
                'not_started': { background: '#ef4444', border: '2px solid #dc2626' },           // red-500 with red-600 border
                'in-progress': { background: '#f59e0b', border: '2px solid #d97706' },          // yellow-500 with yellow-600 border
                'in_progress': { background: '#f59e0b', border: '2px solid #d97706' },          // yellow-500 with yellow-600 border
                'in-progress-guidance-required': { background: '#f97316', border: '2px solid #ea580c' }, // orange-500 with orange-600 border
                'in_progress_guidance_required': { background: '#f97316', border: '2px solid #ea580c' }, // orange-500 with orange-600 border
                'waiting-feedback': { background: '#f97316', border: '2px solid #ea580c' },      // orange-500 with orange-600 border
                'waiting_feedback': { background: '#f97316', border: '2px solid #ea580c' },      // orange-500 with orange-600 border
                'completed': { background: '#22c55e', border: '2px solid #16a34a' },            // green-500 with green-600 border
                'completed-review-pending': { background: '#22c55e', border: '2px solid #16a34a' }, // green-500 with green-600 border
                'completed_review_pending': { background: '#22c55e', border: '2px solid #16a34a' }, // green-500 with green-600 border
                'reviewing-completed': { background: '#22c55e', border: '2px solid #16a34a' },  // green-500 with green-600 border
                'reviewing_completed': { background: '#22c55e', border: '2px solid #16a34a' },  // green-500 with green-600 border
                'completed-data-discrepancy-addressing': { background: '#22c55e', border: '2px solid #16a34a' }, // green-500 with green-600 border
                'completed_data_discrepancy_addressing': { background: '#22c55e', border: '2px solid #16a34a' }, // green-500 with green-600 border
                'on-hold': { background: '#475569', border: '2px solid #374151' },               // gray-600 with gray-700 border
                'on_hold': { background: '#475569', border: '2px solid #374151' },               // gray-600 with gray-700 border
                'cancelled': { background: '#9ca3af', border: '2px solid #6b7280' },            // gray-400 with gray-500 border
                'planning': { background: '#f59e0b', border: '2px solid #d97706' },             // yellow-500 with yellow-600 border
                'blocked': { background: '#ef4444', border: '2px solid #dc2626' }               // red-500 with red-600 border
            };
            return colors[status] || { background: '#9ca3af', border: '2px solid #6b7280' }; // default gray
        }
        */

        function getPriorityIcon(priority) {
            const icons = {
                'low': '🟢',
                'medium': '🟡',
                'high': '🔴',
                'urgent': '🚨'
            };
            return icons[priority] || '🟡';
        }

        function formatDevelopmentStatus(status) {
            // Simple mapping function: if value equals X, display Y
            const statusMap = {
                'original_quoted': 'Original/Quoted Development',
                'new_development': 'New Development',
                'new_development_qms': 'New Development – QMS must be involved',
                'new_development_qms_change': 'New Development – QMS Change',
                'new_quoted_development': 'New Development/Quoted Development',
                'ongoing_development': 'Ongoing Development'
            };
            
            // Return the mapped value or the original if not found
            return statusMap[status] || status || 'Original/Quoted Development';
        }
        
        // Test the function immediately
        console.log('🧪 TESTING formatDevelopmentStatus:');
        console.log('Input: "original_quoted" -> Output:', formatDevelopmentStatus('original_quoted'));
        console.log('Input: "new_development" -> Output:', formatDevelopmentStatus('new_development'));
        
        // Force cache refresh - this will help ensure the updated code is loaded
        console.log('🔄 CACHE BUSTING: Dashboard JavaScript loaded at:', new Date().toISOString());
        console.log('🚀 NEW CODE VERSION: formatDevelopmentStatus function is ready!');
        
        // Show the test element to confirm JavaScript is working
        const testElement = document.getElementById('js-test');
        if (testElement) {
            testElement.style.display = 'block';
            console.log('✅ Test element displayed - JavaScript is working!');
        } else {
            console.log('❌ Test element not found - DOM issue!');
        }
        
        // Test the formatDevelopmentStatus function with actual data
        const testData = 'original_quoted';
        const formattedResult = formatDevelopmentStatus(testData);
        console.log(`🧪 FUNCTION TEST: "${testData}" -> "${formattedResult}"`);
        
        // Show the raw data debug element
        const rawDataElement = document.getElementById('raw-data-debug');
        if (rawDataElement) {
            rawDataElement.innerHTML = `
                🔍 Raw data from backend: <strong>${testData}</strong><br>
                🎯 After formatting: <strong>${formattedResult}</strong><br>
                ✅ Function working: ${formattedResult === 'Original/Quoted Development' ? 'YES' : 'NO'}
            `;
            rawDataElement.style.display = 'block';
        }
        
        // Test the inline element immediately
        const inlineTestElement = document.getElementById('test-result');
        if (inlineTestElement) {
            const inlineTestData = 'original_quoted';
            const inlineFormattedResult = formatDevelopmentStatus(inlineTestData);
            inlineTestElement.innerHTML = `
                <strong>${inlineTestData}</strong> → <strong>${inlineFormattedResult}</strong> 
                (${inlineFormattedResult === 'Original/Quoted Development' ? '✅ WORKING' : '❌ BROKEN'})
            `;
            console.log(`🔧 INLINE TEST: "${inlineTestData}" -> "${inlineFormattedResult}"`);
        }

        // Render Activities
        function renderActivities() {
            const container = document.getElementById('activities-container');
            if (!container) return;

            container.innerHTML = '';
            
            if (dashboardData.activities.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-8 text-slate-400 col-span-full">
                        <div class="text-center">
                            <p class="text-sm">No recent activities</p>
                            <p class="text-xs text-slate-500 mt-1">Activities will appear here as you work on projects</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            dashboardData.activities.forEach((activity, index) => {
                const activityElement = createActivityElement(activity);
                activityElement.style.animationDelay = `${index * 100}ms`;
                container.appendChild(activityElement);
            });
        }

        function createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'bg-slate-700 rounded-lg p-4 hover:bg-slate-600 transition-colors cursor-pointer slide-in';
            
            const title = activity.title || activity.description || 'Activity Update';
            const projectName = activity.project || activity.project_name || 'Unknown Project';
            const status = activity.status || 'active';

            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-medium text-sm">A</span>
                    </div>
                    <div class="min-w-0 flex-1">
                        <h3 class="text-sm font-medium text-white truncate">${title}</h3>
                        <p class="text-sm text-slate-400 truncate">${projectName}</p>
                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-blue-900 text-blue-200 mt-1">
                            ${status.charAt(0).toUpperCase() + status.slice(1)}
                        </span>
                    </div>
                </div>
            `;

            return div;
        }

        function showNoDataMessage() {
            const container = document.getElementById('projects-container');
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-12 text-slate-400">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto mb-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-slate-300 mb-2">No Projects Yet</h3>
                            <p class="text-sm mb-4">Create your first project to see it here</p>
                            <a href="/projects/create/" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Create Project
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // Utility Functions
        function toggleProjectWeeks(projectId) {
            const weeks = document.getElementById(`weeks-${projectId}`);
            const button = document.querySelector(`[data-project-id="${projectId}"]`);
            const icon = button?.querySelector('svg');
            
            if (weeks && icon) {
                if (weeks.classList.contains('hidden')) {
                    weeks.classList.remove('hidden');
                    weeks.classList.add('slide-in');
                    icon.style.transform = 'rotate(90deg)';
                } else {
                    weeks.classList.add('hidden');
                    weeks.classList.remove('slide-in');
                    icon.style.transform = 'rotate(0deg)';
                }
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = '/logout/';
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            
            const icon = document.getElementById('theme-icon');
            if (!document.documentElement.classList.contains('dark')) {
                icon.innerHTML = `<path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>`;
            } else {
                icon.innerHTML = `<path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z" clip-rule="evenodd"/>`;
            }
        }

        function setView(view) {
            dashboardData.currentView = view;
            
            const weekBtn = document.getElementById('week-view');
            const monthBtn = document.getElementById('month-view');
            
            if (view === 'weeks') {
                weekBtn.classList.add('bg-slate-600', 'shadow-sm', 'text-white');
                weekBtn.classList.remove('text-slate-400');
                monthBtn.classList.remove('bg-slate-600', 'shadow-sm', 'text-white');
                monthBtn.classList.add('text-slate-400');
            } else {
                monthBtn.classList.add('bg-slate-600', 'shadow-sm', 'text-white');
                monthBtn.classList.remove('text-slate-400');
                weekBtn.classList.remove('bg-slate-600', 'shadow-sm', 'text-white');
                weekBtn.classList.add('text-slate-400');
            }
            
            renderGanttChart();
        }

        function setupEventListeners() {
            // Sidebar toggle
            document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.remove('hidden');
            });

            document.getElementById('sidebar-close')?.addEventListener('click', closeSidebar);
            document.getElementById('sidebar-overlay')?.addEventListener('click', closeSidebar);

            // View toggle
            document.getElementById('week-view')?.addEventListener('click', () => setView('weeks'));
            document.getElementById('month-view')?.addEventListener('click', () => setView('months'));

            // Status filter
            document.getElementById('status-filter')?.addEventListener('change', (e) => {
                dashboardData.selectedFilter = e.target.value;
                renderGanttChart();
            });

            // Priority filter
            document.getElementById('priority-filter')?.addEventListener('change', (e) => {
                dashboardData.selectedPriorityFilter = e.target.value;
                renderGanttChart();
            });

            // Development status filter
            document.getElementById('development-filter')?.addEventListener('change', (e) => {
                dashboardData.selectedDevelopmentFilter = e.target.value;
                renderGanttChart();
            });

            // Escape key to close sidebar
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSidebar();
            });
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }

        function setupAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry, index) => {
                    if (entry.isIntersecting) {
                        setTimeout(() => {
                            entry.target.style.opacity = '1';
                            entry.target.style.transform = 'translateY(0)';
                        }, index * 100);
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.stats-card').forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
                observer.observe(card);
            });
        }

        // Helper Functions
        function getStatusGradient(status) {
            const gradients = {
                'completed': 'linear-gradient(90deg, #10b981, #059669)',
                'in-progress': 'linear-gradient(90deg, #3b82f6, #2563eb)',
                'planning': 'linear-gradient(90deg, #f59e0b, #d97706)',
                'on-hold': 'linear-gradient(90deg, #ef4444, #dc2626)'
            };
            return gradients[status] || gradients['planning'];
        }

        function getStatusBaseColor(status) {
            const baseColors = {
                'completed': '#10b981',      // Green
                'in-progress': '#3b82f6',    // Blue
                'planning': '#f59e0b',       // Orange
                'on-hold': '#ef4444',        // Red
                'pending': '#6b7280',        // Gray
                'not_started': '#6b7280'     // Gray
            };
            return baseColors[status] || '#f59e0b'; // Default to orange
        }

        // Function to animate progress changes smoothly
        function animateProgressChange(bar, oldProgress, newProgress, status) {
            const duration = 1000; // 1 second animation
            const steps = 30; // 30 steps for smooth animation
            const stepDuration = duration / steps;
            let currentStep = 0;
            
            const animate = () => {
                currentStep++;
                const currentProgress = oldProgress + ((newProgress - oldProgress) * currentStep / steps);
                
                if (currentProgress > 0) {
                    // Use green for completed, light grey for uncompleted
                    bar.style.background = `linear-gradient(90deg, #10b981 ${currentProgress}%, #9ca3af ${currentProgress}%)`;
                    
                    // Update CSS custom property for progress width
                    bar.style.setProperty('--progress-width', currentProgress + '%');
                    
                    // Add glow effect for completed projects
                    if (currentProgress >= 100) {
                        bar.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.5)';
                    } else {
                        bar.style.boxShadow = 'none';
                    }
                } else {
                    // No progress, use light grey
                    bar.style.background = '#9ca3af';
                    bar.style.removeProperty('--progress-width');
                    bar.style.boxShadow = 'none';
                }
                
                if (currentStep < steps) {
                    setTimeout(animate, stepDuration);
                }
            };
            
            animate();
        }

        function getWeekNumber(date) {
            const start = new Date(date.getFullYear(), 0, 1);
            const diff = date - start;
            return Math.ceil(diff / (7 * 24 * 60 * 60 * 1000));
        }

        function formatDate(dateString) {
            if (!dateString || dateString === 'null' || dateString === 'undefined') {
                return 'Not Set';
            }
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: dateString.includes('2024') ? undefined : 'numeric'
                });
            } catch (error) {
                return 'Invalid Date';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
            // Add refresh button after dashboard loads
            setTimeout(addRefreshButton, 1000);
            // Scroll to today's date after chart loads
            setTimeout(scrollToToday, 1500);
        });

        // Add refresh button to the dashboard
        function addRefreshButton() {
            const dashboardHeader = document.querySelector('main > div:first-child');
            if (dashboardHeader && !document.getElementById('refresh-progress-btn')) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex gap-2 items-center';
                
                const refreshBtn = document.createElement('button');
                refreshBtn.id = 'refresh-progress-btn';
                refreshBtn.className = 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm';
                refreshBtn.innerHTML = '🔄 Refresh Progress';
                refreshBtn.onclick = refreshProgressBars;
                
                const todayBtn = document.createElement('button');
                todayBtn.id = 'scroll-to-today-btn';
                todayBtn.className = 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors text-sm';
                todayBtn.innerHTML = '📅 Go to Today';
                todayBtn.onclick = scrollToToday;
                
                const testBtn = document.createElement('button');
                testBtn.id = 'test-progress-btn';
                testBtn.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors text-sm';
                testBtn.innerHTML = '🧪 Test Progress';
                testBtn.onclick = testProgressCalculation;
                
                const debugBtn = document.createElement('button');
                debugBtn.id = 'debug-data-btn';
                debugBtn.className = 'px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors text-sm';
                debugBtn.innerHTML = '🔍 Debug Data';
                debugBtn.onclick = debugProjectData;
                
                const inProgressBtn = document.createElement('button');
                inProgressBtn.id = 'debug-inprogress-btn';
                inProgressBtn.className = 'px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors text-sm';
                inProgressBtn.innerHTML = '🟡 Debug In-Progress';
                inProgressBtn.onclick = debugInProgressProjects;
                
                const recalcBtn = document.createElement('button');
                recalcBtn.id = 'recalc-progress-btn';
                recalcBtn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors text-sm';
                recalcBtn.innerHTML = '🔄 Recalc Progress';
                recalcBtn.onclick = recalculateAllProgress;
                
                buttonContainer.appendChild(refreshBtn);
                buttonContainer.appendChild(todayBtn);
                buttonContainer.appendChild(testBtn);
                buttonContainer.appendChild(debugBtn);
                buttonContainer.appendChild(inProgressBtn);
                buttonContainer.appendChild(recalcBtn);
                
                // Insert after the title
                const title = dashboardHeader.querySelector('h1');
                if (title) {
                    title.parentNode.insertBefore(buttonContainer, title.nextSibling);
                }
            }
        }

        // Demo function to show progress animation (for testing)
        function demoProgressAnimation() {
            const projectBars = document.querySelectorAll('.gantt-bar[data-progress]');
            projectBars.forEach((bar, index) => {
                setTimeout(() => {
                    const currentProgress = parseInt(bar.getAttribute('data-progress')) || 0;
                    const newProgress = Math.min(100, currentProgress + Math.random() * 20);
                    const status = bar.closest('.gantt-timeline').dataset.status;
                    
                    // Animate the progress change
                    animateProgressChange(bar, currentProgress, newProgress, status);
                    
                    // Update the data attribute
                    bar.setAttribute('data-progress', newProgress);
                }, index * 200); // Stagger the animations
            });
        }

        // Function to refresh progress bars based on current data
        function refreshProgressBars() {
            const projectBars = document.querySelectorAll('.gantt-bar:not([data-week="true"])');
            
            projectBars.forEach(bar => {
                const timeline = bar.closest('.gantt-timeline');
                const projectId = timeline.dataset.projectId;
                
                if (projectId) {
                    // Find the project data
                    const project = dashboardData.projects.find(p => p.id == projectId);
                    if (project && project.weeks) {
                        // Recalculate progress
                        let totalTasks = 0;
                        let completedTasks = 0;
                        
                        project.weeks.forEach(week => {
                            const weekTotal = parseInt(week.total_tasks || week.totalTasks || 0);
                            const weekCompleted = parseInt(week.completed_tasks || week.completedTasks || 0);
                            totalTasks += weekTotal;
                            completedTasks += weekCompleted;
                        });
                        
                        let newProgress = 0;
                        if (totalTasks > 0) {
                            newProgress = Math.round((completedTasks / totalTasks) * 100);
                        }
                        
                        // Update the bar if progress changed
                        const currentProgress = parseInt(bar.getAttribute('data-progress')) || 0;
                        if (newProgress !== currentProgress) {
                            console.log(`Updating progress for project ${projectId}: ${currentProgress}% -> ${newProgress}%`);
                            
                            // Update data attributes
                            timeline.dataset.progress = newProgress;
                            bar.setAttribute('data-progress', newProgress);
                            bar.style.setProperty('--progress-width', newProgress + '%');
                            
                            // Animate the change
                            animateProgressChange(bar, currentProgress, newProgress, timeline.dataset.status);
                        }
                    }
                }
            });
        }

        // Function to scroll Gantt chart to today's date
        function scrollToToday() {
            const ganttContainer = document.querySelector('.gantt-container');
            if (!ganttContainer) {
                console.log('Gantt container not found, retrying...');
                setTimeout(scrollToToday, 500);
                return;
            }

            // Show loading state
            const todayBtn = document.getElementById('scroll-to-today-btn');
            if (todayBtn) {
                const originalText = todayBtn.innerHTML;
                todayBtn.innerHTML = '⏳ Finding Today...';
                todayBtn.disabled = true;
                
                // Reset button after scroll completes
                setTimeout(() => {
                    todayBtn.innerHTML = originalText;
                    todayBtn.disabled = false;
                }, 2000);
            }

            const today = new Date();
            const headerCells = document.querySelectorAll('#gantt-header > div');
            
            if (headerCells.length === 0) {
                console.log('Gantt header cells not found, retrying...');
                setTimeout(scrollToToday, 500);
                return;
            }

            // Find today's column in the header
            let todayColumnIndex = -1;
            let closestDate = null;
            let minDiff = Infinity;

            headerCells.forEach((cell, index) => {
                const dateText = cell.textContent.trim();
                if (dateText) {
                    try {
                        // Parse the date from the header cell
                        const cellDate = parseHeaderDate(dateText);
                        if (cellDate) {
                            const diff = Math.abs(cellDate.getTime() - today.getTime());
                            if (diff < minDiff) {
                                minDiff = diff;
                                closestDate = cellDate;
                                todayColumnIndex = index;
                            }
                        }
                    } catch (error) {
                        console.log('Could not parse date from header cell:', dateText);
                    }
                }
            });

            if (todayColumnIndex !== -1) {
                // Calculate scroll position to center today's column
                const cellWidth = headerCells[0].offsetWidth;
                const containerWidth = ganttContainer.offsetWidth;
                const scrollPosition = (todayColumnIndex * cellWidth) - (containerWidth / 2) + (cellWidth / 2);
                
                // Smooth scroll to today's position
                ganttContainer.scrollTo({
                    left: Math.max(0, scrollPosition),
                    behavior: 'smooth'
                });

                console.log(`Scrolled to today's date (${closestDate ? closestDate.toDateString() : 'unknown'}) at column ${todayColumnIndex}`);
                
                // Add a visual indicator for today's column
                highlightTodayColumn(todayColumnIndex);
                
                // Show success message
                showTodayMessage(closestDate);
            } else {
                console.log('Could not find today\'s date in Gantt chart');
                // Show error message
                showTodayMessage(null, true);
            }
        }

        // Helper function to parse dates from header cells
        function parseHeaderDate(dateText) {
            // Handle various date formats
            const formats = [
                // "Jan 31", "Feb 1", etc.
                /^([A-Za-z]{3})\s+(\d{1,2})$/,
                // "31", "1", etc. (just day numbers)
                /^(\d{1,2})$/,
                // "Jan 31, 2024", "Feb 1, 2024", etc.
                /^([A-Za-z]{3})\s+(\d{1,2}),?\s+(\d{4})$/,
                // "2024-01-31", "2024-02-01", etc.
                /^(\d{4})-(\d{1,2})-(\d{1,2})$/
            ];

            for (const format of formats) {
                const match = dateText.match(format);
                if (match) {
                    if (format.source.includes('A-Za-z')) {
                        // Month name format
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const monthIndex = monthNames.indexOf(match[1]);
                        const day = parseInt(match[2]);
                        const year = match[3] ? parseInt(match[3]) : new Date().getFullYear();
                        
                        if (monthIndex !== -1 && day >= 1 && day <= 31) {
                            return new Date(year, monthIndex, day);
                        }
                    } else if (format.source.includes('\\d{4}')) {
                        // Full date format
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]) - 1; // Month is 0-indexed
                        const day = parseInt(match[3]);
                        
                        if (year >= 1900 && year <= 2100 && month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                            return new Date(year, month, day);
                        }
                    } else {
                        // Just day number - assume current month and year
                        const day = parseInt(match[1]);
                        const now = new Date();
                        if (day >= 1 && day <= 31) {
                            return new Date(now.getFullYear(), now.getMonth(), day);
                        }
                    }
                }
            }
            
            return null;
        }

        // Function to highlight today's column
        function highlightTodayColumn(columnIndex) {
            // Remove any existing highlights
            const existingHighlights = document.querySelectorAll('.today-highlight');
            existingHighlights.forEach(el => el.remove());

            const headerCells = document.querySelectorAll('#gantt-header > div');
            if (headerCells[columnIndex]) {
                const todayCell = headerCells[columnIndex];
                
                // Create highlight element
                const highlight = document.createElement('div');
                highlight.className = 'today-highlight';
                highlight.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 197, 253, 0.2));
                    border: 2px solid #3b82f6;
                    border-radius: 4px;
                    pointer-events: none;
                    z-index: 10;
                    animation: todayPulse 2s ease-in-out infinite;
                `;
                
                // Position the highlight
                todayCell.style.position = 'relative';
                todayCell.appendChild(highlight);
                
                // Add pulse animation CSS
                if (!document.getElementById('today-highlight-styles')) {
                    const style = document.createElement('style');
                    style.id = 'today-highlight-styles';
                    style.textContent = `
                        @keyframes todayPulse {
                            0%, 100% { opacity: 0.7; transform: scale(1); }
                            50% { opacity: 1; transform: scale(1.05); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // Function to show today message
        function showTodayMessage(date, isError = false) {
            // Remove any existing messages
            const existingMessages = document.querySelectorAll('.today-message');
            existingMessages.forEach(el => el.remove());

            const message = document.createElement('div');
            message.className = 'today-message fixed top-20 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full';
            
            if (isError) {
                message.className += ' bg-red-600 text-white';
                message.innerHTML = '❌ Could not find today\'s date in the chart';
            } else {
                message.className += ' bg-green-600 text-white';
                const dateStr = date ? date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }) : 'today';
                message.innerHTML = `✅ Scrolled to ${dateStr}`;
            }

            document.body.appendChild(message);

            // Animate in
            setTimeout(() => {
                message.classList.remove('translate-x-full');
            }, 100);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                message.classList.add('translate-x-full');
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }, 3000);
        }

        // Function to test progress calculation with sample data
        function testProgressCalculation() {
            console.log('🧪 Testing progress calculation...');
            
            // Sample project data structure
            const sampleProject = {
                name: 'Test Project',
                weeks: [
                    { total_tasks: 5, completed_tasks: 3 },
                    { total_tasks: 4, completed_tasks: 1 },
                    { total_tasks: 6, completed_tasks: 0 }
                ]
            };
            
            // Test the calculation logic
            let totalTasks = 0;
            let completedTasks = 0;
            
            sampleProject.weeks.forEach(week => {
                const weekTotal = parseInt(week.total_tasks || 0);
                const weekCompleted = parseInt(week.completed_tasks || 0);
                totalTasks += weekTotal;
                completedTasks += weekCompleted;
            });
            
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            console.log('Sample project progress calculation:', {
                totalTasks,
                completedTasks,
                progress: progress + '%',
                expected: '27% (4 out of 15 tasks completed)'
            });
            
            return progress;
        }

        // Function to debug project data structure
        function debugProjectData() {
            console.log('🔍 Debugging project data structure...');
            console.log('dashboardData:', dashboardData);
            
            if (dashboardData && dashboardData.projects) {
                dashboardData.projects.forEach((project, index) => {
                    console.log(`Project ${index + 1}:`, {
                        name: project.name || project.title,
                        weeks: project.weeks,
                        weekly_tasks: project.weekly_tasks,
                        progress: project.progress,
                        status: project.status,
                        hasWeeks: !!(project.weeks && project.weeks.length > 0),
                        hasWeeklyTasks: !!(project.weekly_tasks && project.weekly_tasks.length > 0)
                    });
                });
            } else {
                console.log('No dashboard data or projects found');
            }
        }

        // Function to specifically debug in-progress projects
        function debugInProgressProjects() {
            console.log('🔍 Debugging in-progress projects specifically...');
            
            if (dashboardData && dashboardData.projects) {
                const inProgressProjects = dashboardData.projects.filter(p => 
                    p.status === 'in-progress' || p.status === 'in_progress'
                );
                
                console.log(`Found ${inProgressProjects.length} in-progress projects:`, inProgressProjects);
                
                inProgressProjects.forEach((project, index) => {
                    console.log(`In-Progress Project ${index + 1}:`, {
                        name: project.name || project.title,
                        status: project.status,
                        weeks: project.weeks,
                        weekly_tasks: project.weekly_tasks,
                        originalProgress: project.progress
                    });
                    
                    // Calculate progress manually
                    if (project.weeks && project.weeks.length > 0) {
                        let totalTasks = 0;
                        let completedTasks = 0;
                        
                        project.weeks.forEach((week, weekIndex) => {
                            const weekTotal = parseInt(week.total_tasks || week.totalTasks || 0);
                            const weekCompleted = parseInt(week.completed_tasks || week.completedTasks || 0);
                            totalTasks += weekTotal;
                            completedTasks += weekCompleted;
                            
                            console.log(`  Week ${weekIndex + 1}: ${weekCompleted}/${weekTotal} tasks completed`);
                        });
                        
                        const calculatedProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                        console.log(`  Calculated Progress: ${calculatedProgress}% (${completedTasks}/${totalTasks} tasks)`);
                    } else {
                        console.log(`  No weekly data found for progress calculation`);
                    }
                });
            } else {
                console.log('No dashboard data or projects found');
            }
        }

        // Function to manually recalculate and update all project progress bars
        function recalculateAllProgress() {
            console.log('🔄 Manually recalculating all project progress...');
            
            const projectBars = document.querySelectorAll('.gantt-bar:not([data-week="true"])');
            let updatedCount = 0;
            
            projectBars.forEach(bar => {
                const timeline = bar.closest('.gantt-timeline');
                const projectId = timeline.dataset.projectId;
                
                if (projectId) {
                    // Find the project data
                    const project = dashboardData.projects.find(p => p.id == projectId);
                    if (project) {
                        // Recalculate progress
                        let totalTasks = 0;
                        let completedTasks = 0;
                        
                        if (project.weeks && project.weeks.length > 0) {
                            project.weeks.forEach(week => {
                                const weekTotal = parseInt(week.total_tasks || week.totalTasks || 0);
                                const weekCompleted = parseInt(week.completed_tasks || week.completedTasks || 0);
                                totalTasks += weekTotal;
                                completedTasks += weekCompleted;
                            });
                        }
                        
                        let newProgress = 0;
                        if (totalTasks > 0) {
                            newProgress = Math.round((completedTasks / totalTasks) * 100);
                        }
                        
                        console.log(`Project ${project.name || project.title}:`, {
                            totalTasks,
                            completedTasks,
                            newProgress: newProgress + '%',
                            oldProgress: timeline.dataset.progress + '%'
                        });
                        
                        // Update the bar
                        const currentProgress = parseInt(timeline.dataset.progress) || 0;
                        if (newProgress !== currentProgress) {
                            // Update data attributes
                            timeline.dataset.progress = newProgress;
                            bar.setAttribute('data-progress', newProgress);
                            bar.style.setProperty('--progress-width', newProgress + '%');
                            
                            // Update the visual progress bar in the project details
                            const progressBar = timeline.closest('.project-item').querySelector('.bg-blue-500');
                            if (progressBar) {
                                progressBar.style.width = newProgress + '%';
                            }
                            
                            // Update the progress percentage text
                            const progressText = timeline.closest('.project-item').querySelector('.w-10');
                            if (progressText) {
                                progressText.textContent = newProgress + '%';
                            }
                            
                            // Animate the change
                            animateProgressChange(bar, currentProgress, newProgress, timeline.dataset.status);
                            updatedCount++;
                        }
                    }
                }
            });
            
            console.log(`✅ Updated ${updatedCount} project progress bars`);
            
            // Show success message
            const message = document.createElement('div');
            message.className = 'fixed top-20 right-4 z-50 px-4 py-3 bg-green-600 text-white rounded-lg shadow-lg';
            message.innerHTML = `✅ Recalculated progress for ${updatedCount} projects`;
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 3000);
        }

        // EMAIL FUNCTIONALITY COMMENTED OUT - Client Email Modal Functions
        /*
        function showClientEmailModal() {
            document.getElementById('clientEmailModal').classList.remove('hidden');
        }

        function closeClientEmailModal() {
            document.getElementById('clientEmailModal').classList.add('hidden');
        }

        function sendClientEmail(clientEmail, projectName) {
            // Show loading state
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Sending...';
            button.disabled = true;

            // Send email via AJAX
            fetch('/send-client-email/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    client_email: clientEmail,
                    project_name: projectName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.textContent = 'Sent ✓';
                    button.classList.add('bg-green-600');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-600');
                        button.disabled = false;
                    }, 2000);
                } else {
                    button.textContent = 'Error';
                    button.classList.add('bg-red-600');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-red-600');
                        button.disabled = false;
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                button.textContent = 'Error';
                button.classList.add('bg-red-600');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-600');
                    button.disabled = false;
                }, 2000);
            });
        }

        // Close modals when clicking outside
        document.getElementById('clientEmailModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeClientEmailModal();
            }
        });
        */

        function drawTodayLine() {
            const today = new Date();
            const { startDate, endDate } = calculateProjectDateRange();
            
            // Remove any existing today lines
            document.querySelectorAll('.today-line').forEach(line => line.remove());
            
            // Calculate position for today's line
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const daysFromStart = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
            
            if (daysFromStart >= 0 && daysFromStart <= totalDays) {
                const timelineWidth = document.querySelector('#gantt-header')?.parentElement?.clientWidth || 800;
                const todayPosition = (daysFromStart / totalDays) * timelineWidth;
                
                // Add today line to header
                const header = document.getElementById('gantt-header');
                if (header) {
                    const todayLine = document.createElement('div');
                    todayLine.className = 'today-line absolute top-0 bottom-0 w-0.5 bg-red-500 z-20';
                    todayLine.style.left = todayPosition + 'px';
                    todayLine.innerHTML = `
                        <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-red-500 text-white text-xs px-2 py-1 rounded whitespace-nowrap">
                            Today: ${today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        </div>
                    `;
                    header.style.position = 'relative';
                    header.appendChild(todayLine);
                }
                
                // Add today line to all project timelines
                document.querySelectorAll('.gantt-timeline').forEach(timeline => {
                    const timelineRect = timeline.getBoundingClientRect();
                    const headerRect = header?.getBoundingClientRect();
                    
                    if (headerRect && timelineRect) {
                        const todayLine = document.createElement('div');
                        todayLine.className = 'today-line absolute top-0 bottom-0 w-0.5 bg-red-500 z-20';
                        todayLine.style.left = todayPosition + 'px';
                        timeline.style.position = 'relative';
                        timeline.appendChild(todayLine);
                    }
                });
            }
        }
    </script>

    <!-- EMAIL FUNCTIONALITY COMMENTED OUT - Client Email Modal -->
    <!--
    <div id="clientEmailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-white">Client Email Management</h3>
                        <button onclick="closeClientEmailModal()" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for project in projects %}
                            {% if project.client_email %}
                            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-white">{{ project.name }}</h4>
                                    <span class="px-2 py-1 text-xs rounded-full {% if project.status == 'completed' or project.status == 'completed-review-pending' or project.status == 'completed_review_pending' or project.status == 'reviewing-completed' or project.status == 'reviewing_completed' or project.status == 'completed-data-discrepancy-addressing' or project.status == 'completed_data_discrepancy_addressing %}bg-green-900 text-green-300{% elif project.status == 'in-progress' or project.status == 'in_progress' or project.status == 'in-progress-guidance-required' or project.status == 'in_progress_guidance_required %}bg-yellow-900 text-yellow-300{% elif project.status == 'not-started' or project.status == 'not_started' %}bg-red-900 text-red-300{% elif project.status == 'waiting-feedback' or project.status == 'waiting_feedback' %}bg-orange-900 text-orange-300{% elif project.status == 'on-hold' or project.status == 'on_hold' %}bg-gray-800 text-gray-300{% elif project.status == 'cancelled' %}bg-gray-400 text-gray-100{% elif project.status == 'planning' %}bg-purple-900 text-purple-300{% elif project.status == 'blocked' %}bg-red-800 text-red-200{% else %}bg-gray-600 text-gray-300{% endif %}">
                                        {{ project.status|title }}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-300 mb-3">
                                    <div class="flex items-center gap-2 mb-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        <span class="font-medium">{{ project.client }}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                        <span class="text-gray-400">{{ project.client_email }}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="sendClientEmail('{{ project.client_email }}', '{{ project.name }}')" 
                                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded transition-colors">
                                        Send Report
                                    </button>
                                    <a href="{% url 'main:generate_project_report' project.id %}" 
                                       class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded transition-colors">
                                        Download
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    {% if not projects|length %}
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 text-gray-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p class="text-gray-400">No projects with client emails found.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    -->
</body>