{% extends 'home/dashboard_base.html' %}
{% load static %}

{% block title %}Team Dashboard{% endblock %}

{% block extra_css %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    :root {
        /* Additional CSS variables needed for dark mode */
        --primary-blue: #3B82F6;
        --primary-dark: #1E40AF;
        --background-gray: #F3F4F6;
    }

    [data-theme="dark"] {
        --primary-blue: #60A5FA;
        --primary-dark: #3B82F6;
        --background-gray: #4A5568;
    }

    .team-dashboard {
        width: 100%;
        padding: 0;
        margin: 0;
    }

    .dashboard-header {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        padding: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        width: 100%;
    }

    .dashboard-header h1 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 2rem;
    }

    .dashboard-header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }



    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .section {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .section-header {
        background: var(--background-gray);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-light);
    }

    .section-header h2 {
        color: var(--text-primary);
        margin: 0;
        font-size: 1.3rem;
    }

    /* Priority Badge Styling */
    .priority-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-left: 0.5rem;
    }

    .priority-low {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .priority-medium {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }

    .priority-high {
        background-color: #fed7aa;
        color: #c2410c;
        border: 1px solid #fdba74;
    }

    .priority-urgent {
        background-color: #fecaca;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    [data-theme="dark"] .priority-low {
        background-color: #064e3b;
        color: #6ee7b7;
        border-color: #059669;
    }

    [data-theme="dark"] .priority-medium {
        background-color: #78350f;
        color: #fbbf24;
        border-color: #d97706;
    }

    [data-theme="dark"] .priority-high {
        background-color: #7c2d12;
        color: #fb923c;
        border-color: #ea580c;
    }

    [data-theme="dark"] .priority-urgent {
        background-color: #7f1d1d;
        color: #fca5a5;
        border-color: #dc2626;
    }

    .section-content {
        padding: 1.5rem;
    }

    .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .project-card {
        background: var(--background-secondary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-small);
        padding: 1.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .project-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .project-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .project-status {
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-small);
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* Dark mode compatible status colors */
    .project-status.planned { 
        background: var(--primary-blue); 
        color: var(--text-white); 
    }
    .project-status.in_progress { 
        background: var(--warning); 
        color: var(--text-white); 
    }
    .project-status.completed { 
        background: var(--success); 
        color: var(--text-white); 
    }

    .project-info {
        margin-bottom: 1rem;
    }

    .project-info p {
        color: var(--text-secondary);
        margin: 0.25rem 0;
        font-size: 0.9rem;
    }

    .tasks-list {
        margin-top: 1rem;
    }

    .task-item {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-small);
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .task-title {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }



    .task-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .task-detail {
        font-size: 0.85rem;
    }

    .task-detail span:first-child {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .task-detail span:last-child {
        color: var(--text-primary);
    }

    .task-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-small);
        background: var(--background-primary);
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .btn:hover {
        border-color: var(--primary-blue);
        background: var(--background-tertiary);
    }

    .btn-primary {
        background: var(--primary-blue);
        color: var(--text-white);
        border-color: var(--primary-blue);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-success {
        background: var(--success);
        color: var(--text-white);
        border-color: var(--success);
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-warning {
        background: var(--warning);
        color: var(--text-white);
        border-color: var(--warning);
    }

    .btn-warning:hover {
        background: #D97706;
    }

    .subtasks-list {
        margin-top: 0.75rem;
        padding-left: 1rem;
        border-left: 2px solid var(--border-light);
    }

    .subtask-item {
        background: var(--background-tertiary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-small);
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .subtask-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .subtask-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
    }

    .comments-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-light);
    }

    .comment-item {
        background: var(--background-tertiary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-small);
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .comment-item.admin-response {
        background: rgba(59, 130, 246, 0.1);
        border-left: 3px solid var(--primary-blue);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .comment-user {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.85rem;
    }

    .comment-time {
        color: var(--text-secondary);
        font-size: 0.75rem;
    }

    .comment-content {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .subtask-title {
        font-size: 0.9rem;
        color: var(--text-primary);
        margin: 0;
    }

    .subtask-status {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* Dark mode compatible subtask status colors */
    .subtask-status.not_started { 
        color: var(--text-secondary); 
    }
    .subtask-status.in_progress { 
        color: var(--warning); 
    }
    .subtask-status.completed { 
        color: var(--success); 
    }

    .status-update-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .status-update-modal.show {
        display: flex;
    }

    .modal-content {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
    }

    .modal-header h3 {
        margin: 0;
        color: var(--text-primary);
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0;
    }

    .close-btn:hover {
        color: var(--text-primary);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-small);
        background: var(--background-primary);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .empty-state h3 {
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .empty-state p {
        margin-bottom: 1.5rem;
    }

    @media (max-width: 768px) {
        .projects-grid {
            grid-template-columns: 1fr;
        }
        
        .task-details {
            grid-template-columns: 1fr;
        }
        
        .task-actions {
            flex-direction: column;
        }
        
        .btn {
            text-align: center;
            justify-content: center;
        }



        .subtask-actions {
            flex-direction: column;
        }

        .btn-sm {
            text-align: center;
            justify-content: center;
        }

        .comments-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        .comment-item {
            background: var(--background-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-small);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .comment-item.admin-response {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--primary-blue);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-user {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .comment-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .comment-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="team-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1>Team Dashboard</h1>
        <p>Welcome back, {{ user.get_full_name|default:user.username }}! Here's an overview of your assigned projects and tasks.</p>
        
        <!-- Theme Toggle -->

    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_projects }}</div>
            <div class="stat-label">Total Projects</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_projects }}</div>
            <div class="stat-label">Active Projects</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_tasks }}</div>
            <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ completed_tasks }}</div>
            <div class="stat-label">Completed Tasks</div>
        </div>
    </div>

    <!-- Projects Section -->
    <div class="section">
        <div class="section-header">
            <h2>My Assigned Projects</h2>
        </div>
        <div class="section-content">
            {% if assigned_projects %}
                <div class="projects-grid">
                    {% for project in assigned_projects %}
                    <div class="project-card">
                        <div class="project-header">
                            <h3 class="project-title">{{ project.name }}</h3>
                            <span class="project-status {{ project.status }}">{{ project.get_status_display }}</span>
                        </div>
                        
                        <div class="project-info">
                            <p><strong>Client:</strong> {{ project.client }}</p>
                            {% if project.start_date %}
                                <p><strong>Start Date:</strong> {{ project.start_date|date:"M d, Y" }}</p>
                            {% endif %}
                            {% if project.end_date %}
                                <p><strong>End Date:</strong> {{ project.end_date|date:"M d, Y" }}</p>
                            {% endif %}
                        </div>

                        <!-- Project Tasks -->
                        <div class="tasks-list">
                            <h4>Tasks ({{ project.tasks.count }})</h4>
                            {% for task in project.tasks.all %}
                            <div class="task-item">
                                <div class="task-header">
                                    <h5 class="task-title">{{ task.title }}</h5>
                                </div>
                                
                                <div class="task-details">
                                    <div class="task-detail">
                                        <span>Status:</span>
                                        <span>{{ task.get_status_display }}</span>
                                    </div>
                                    <div class="task-detail">
                                        <span>Priority:</span>
                                        <span class="priority-badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                                    </div>
                                    <div class="task-detail">
                                        <span>Due:</span>
                                        <span>{% if task.end_date %}{{ task.end_date|date:"M d, Y" }}{% else %}Not set{% endif %}</span>
                                    </div>
                                    {% if task.estimated_hours %}
                                    <div class="task-detail">
                                        <span>Est. Hours:</span>
                                        <span>{{ task.estimated_hours }}h</span>
                                    </div>
                                    {% endif %}
                                    <div class="task-detail">
                                        <span>Description:</span>
                                        <span>{{ task.description|default:"No description"|truncatechars:50 }}</span>
                                    </div>
                                </div>

                                <div class="task-actions">
                                    <button class="btn btn-primary" onclick="openStatusModal('task', {{ task.id }}, '{{ task.title }}', '{{ task.status }}')">
                                        Update Status
                                    </button>
                                    <button class="btn" onclick="openCommentModal('task', {{ task.id }}, '{{ task.title }}')">
                                        Add Comment
                                    </button>
                                    {% if task.status != 'completed' and task.end_date %}
                                    <button class="btn btn-warning" onclick="openExtendModal('task', {{ task.id }}, '{{ task.title }}', '{{ task.end_date|date:"Y-m-d" }}')">
                                        Extend Deadline
                                    </button>
                                    {% endif %}
                                </div>

                                <!-- Subtasks -->
                                {% if task.subtasks.all %}
                                <div class="subtasks-list">
                                    <h6>Subtasks:</h6>
                                    {% for subtask in task.subtasks.all %}
                                    <div class="subtask-item">
                                        <div class="subtask-content">
                                            <span class="subtask-title">{{ subtask.title }}</span>
                                            <span class="subtask-status {{ subtask.status }}">{{ subtask.get_status_display }}</span>
                                            <span class="priority-badge priority-{{ subtask.priority }}">{{ subtask.get_priority_display }}</span>
                                        </div>
                                        <div class="subtask-actions">
                                            <button class="btn btn-sm btn-primary" onclick="openStatusModal('subtask', {{ subtask.id }}, '{{ subtask.title }}', '{{ subtask.status }}')">
                                                Update Status
                                            </button>
                                            <button class="btn btn-sm" onclick="openCommentModal('subtask', {{ subtask.id }}, '{{ subtask.title }}')">
                                                Add Comment
                                            </button>
                                            {% if subtask.status != 'completed' and task.end_date %}
                                            <button class="btn btn-sm btn-warning" onclick="openExtendModal('subtask', {{ subtask.id }}, '{{ subtask.title }}', '{{ task.end_date|date:"Y-m-d" }}')">
                                                Extend Deadline
                                            </button>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Show subtask comments and admin responses -->
                                        {% if subtask.comments.all %}
                                        <div class="comments-section">
                                            <h6>Comments:</h6>
                                            {% for comment in subtask.comments.all %}
                                            <div class="comment-item {% if comment.is_admin_response %}admin-response{% endif %}">
                                                <div class="comment-header">
                                                    <span class="comment-user">
                                                        {% if comment.is_admin_response %}
                                                            <i class="fas fa-user-shield"></i> Admin: {{ comment.user.get_full_name|default:comment.user.username }}
                                                        {% else %}
                                                            {{ comment.user.get_full_name|default:comment.user.username }}
                                                        {% endif %}
                                                    </span>
                                                    <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                                                </div>
                                                <div class="comment-content">{{ comment.comment }}</div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <!-- Show task comments and admin responses -->
                                {% if task.comments.all %}
                                <div class="comments-section">
                                    <h6>Comments:</h6>
                                    {% for comment in task.comments.all %}
                                    <div class="comment-item {% if comment.is_admin_response %}admin-response{% endif %}">
                                        <div class="comment-header">
                                            <span class="comment-user">
                                                {% if comment.is_admin_response %}
                                                    <i class="fas fa-user-shield"></i> Admin: {{ comment.user.get_full_name|default:comment.user.username }}
                                                {% else %}
                                                    {{ comment.user.get_full_name|default:comment.user.username }}
                                                {% endif %}
                                            </span>
                                            <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                                        </div>
                                        <div class="comment-content">{{ comment.comment }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>No Projects Assigned</h3>
                    <p>You don't have any projects assigned to you yet. Contact your project manager to get started.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Upcoming Tasks Section -->
    {% if upcoming_tasks %}
    <div class="section">
        <div class="section-header">
            <h2>Upcoming Deadlines (Next 7 Days)</h2>
        </div>
        <div class="section-content">
            <div class="tasks-list">
                {% for task in upcoming_tasks %}
                <div class="task-item">
                    <div class="task-header">
                        <h5 class="task-title">{{ task.title }} - {{ task.project.name }}</h5>
                    </div>
                    <div class="task-details">
                        <div class="task-detail">
                            <span>Due Date:</span>
                            <span>{{ task.end_date|date:"M d, Y" }}</span>
                        </div>
                        <div class="task-detail">
                            <span>Status:</span>
                            <span>{{ task.get_status_display }}</span>
                        </div>
                        <div class="task-detail">
                            <span>Priority:</span>
                            <span class="priority-badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-primary" onclick="openStatusModal('task', {{ task.id }}, '{{ task.title }}', '{{ task.status }}')">
                            Update Status
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- High Priority Tasks Section -->
    {% if high_priority_tasks %}
    <div class="section">
        <div class="section-header">
            <h2>🚨 High Priority Tasks</h2>
        </div>
        <div class="section-content">
            <div class="tasks-list">
                {% for task in high_priority_tasks %}
                <div class="task-item high-priority">
                    <div class="task-header">
                        <h5 class="task-title">{{ task.title }} - {{ task.project.name }}</h5>
                        <span class="priority-badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                    </div>
                    <div class="task-details">
                        <div class="task-detail">
                            <span>Status:</span>
                            <span>{{ task.get_status_display }}</span>
                        </div>
                        {% if task.end_date %}
                        <div class="task-detail">
                            <span>Due Date:</span>
                            <span>{{ task.end_date|date:"M d, Y" }}</span>
                        </div>
                        {% endif %}
                        {% if task.estimated_hours %}
                        <div class="task-detail">
                            <span>Est. Hours:</span>
                            <span>{{ task.estimated_hours }}h</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-primary" onclick="openStatusModal('task', {{ task.id }}, '{{ task.title }}', '{{ task.status }}')">
                            Update Status
                        </button>
                        <button class="btn" onclick="openCommentModal('task', {{ task.id }}, '{{ task.title }}')">
                            Add Comment
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Status Update Modal -->
<div class="status-update-modal" id="statusModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Status</h3>
            <button class="close-btn" onclick="closeStatusModal()">&times;</button>
        </div>
        <form id="statusForm">
            <input type="hidden" id="itemType" name="item_type">
            <input type="hidden" id="itemId" name="item_id">
            
            <div class="form-group">
                <label for="newStatus">New Status:</label>
                <select id="newStatus" name="new_status" class="form-control" required>
                    <option value="">Select Status</option>
                    <option value="not_started">Not Started</option>
                    <option value="in_progress">In Progress</option>
                    <option value="in_progress_guidance_required">In Progress (Guidance Required)</option>
                    <option value="completed">Completed</option>
                    <option value="completed_review_pending">Completed (Review Pending)</option>
                    <option value="completed_data_discrepancy_addressing">Completed (Data Discrepancy addressing)</option>
                    <option value="on_hold">On Hold</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reason">Reason/Comment:</label>
                <textarea id="reason" name="reason" class="form-control" rows="3" placeholder="Optional: Add a reason or comment for this status change"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeStatusModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
        </form>
    </div>
</div>

<!-- Comment Modal -->
<div class="status-update-modal" id="commentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Comment</h3>
            <button class="close-btn" onclick="closeCommentModal()">&times;</button>
        </div>
        <form id="commentForm">
            <input type="hidden" id="commentItemType" name="item_type">
            <input type="hidden" id="commentItemId" name="item_id">
            
            <div class="form-group">
                <label for="commentText">Comment:</label>
                <textarea id="commentText" name="comment_text" class="form-control" rows="4" placeholder="Enter your comment..." required></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeCommentModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Comment</button>
            </div>
        </form>
    </div>
</div>

<!-- Extend Deadline Modal -->
<div class="status-update-modal" id="extendModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Extend Deadline</h3>
            <button class="close-btn" onclick="closeExtendModal()">&times;</button>
        </div>
        <form id="extendForm">
            <input type="hidden" id="extendItemType" name="item_type">
            <input type="hidden" id="extendItemId" name="item_id">
            
            <div class="form-group">
                <label for="newEndDate">New End Date:</label>
                <input type="date" id="newEndDate" name="new_end_date" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="extendReason">Reason:</label>
                <textarea id="extendReason" name="reason" class="form-control" rows="3" placeholder="Why do you need to extend this deadline?" required></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeExtendModal()">Cancel</button>
                <button type="submit" class="btn btn-warning">Extend Deadline</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Status Update Modal Functions
    function openStatusModal(type, id, title, currentStatus) {
        document.getElementById('itemType').value = type;
        document.getElementById('itemId').value = id;
        document.getElementById('newStatus').value = currentStatus;
        document.getElementById('statusModal').classList.add('show');
    }

    function closeStatusModal() {
        document.getElementById('statusModal').classList.remove('show');
        document.getElementById('statusForm').reset();
    }

    // Comment Modal Functions
    function openCommentModal(type, id, title) {
        document.getElementById('commentItemType').value = type;
        document.getElementById('commentItemId').value = id;
        document.getElementById('commentModal').classList.add('show');
    }

    function closeCommentModal() {
        document.getElementById('commentModal').classList.remove('show');
        document.getElementById('commentForm').reset();
    }

    // Extend Deadline Modal Functions
    function openExtendModal(type, id, title, currentEndDate) {
        document.getElementById('extendItemType').value = type;
        document.getElementById('extendItemId').value = id;
        document.getElementById('newEndDate').value = currentEndDate;
        document.getElementById('extendModal').classList.add('show');
    }

    function closeExtendModal() {
        document.getElementById('extendModal').classList.remove('show');
        document.getElementById('extendForm').reset();
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('status-update-modal')) {
            event.target.classList.remove('show');
        }
    }

    // Form Submissions
    document.getElementById('statusForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        const itemType = formData.get('item_type');
        const itemId = formData.get('item_id');
        const newStatus = formData.get('new_status');
        
        // Determine the correct endpoint based on item type
        let endpoint;
        if (itemType === 'subtask') {
            endpoint = `/subtasks/${itemId}/update/`;
            // For subtasks, we need to send the new status directly
            formData.set('new_status', newStatus);
        } else {
            endpoint = `/tasks/${itemId}/update/`;
            // For tasks, we need to map the status to update_type
            const statusToUpdateType = {
                'not_started': 'not_started',
                'in_progress': 'in_progress',
                'completed': 'completed',
                'on_hold': 'on_hold',
                'cancelled': 'cancelled'
            };
            formData.set('update_type', statusToUpdateType[newStatus] || newStatus);
        }
        
        fetch(endpoint, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Status updated successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the status.');
        });
        
        closeStatusModal();
    });

    document.getElementById('commentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        const itemType = formData.get('item_type');
        const itemId = formData.get('item_id');
        
        // Determine the correct endpoint based on item type
        let endpoint;
        if (itemType === 'subtask') {
            endpoint = `/subtasks/${itemId}/comment/`;
        } else {
            endpoint = `/tasks/${itemId}/comment/`;
        }
        
        fetch(endpoint, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Comment added successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the comment.');
        });
        
        closeCommentModal();
    });

    document.getElementById('extendForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        const itemType = formData.get('item_type');
        const itemId = formData.get('item_id');
        
        // Determine the correct endpoint based on item type
        let endpoint;
        if (itemType === 'subtask') {
            endpoint = `/subtasks/${itemId}/extend/`;
        } else {
            endpoint = `/tasks/${itemId}/extend/`;
        }
        
        fetch(endpoint, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Deadline extended successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while extending the deadline.');
        });
        
        closeExtendModal();
    });

    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
