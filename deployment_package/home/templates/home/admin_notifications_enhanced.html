{% extends 'home/dashboard_base.html' %}
{% load static %}

{% block title %}Enhanced Admin Notifications{% endblock %}

{% block extra_css %}
<style>
    .admin-notifications {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .filters-section {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-weight: 500;
    }

    .filter-select {
        padding: 0.5rem;
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-small);
        background: var(--background-primary);
        color: var(--text-primary);
    }

    .notifications-section {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .section-header {
        background: var(--background-secondary);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-header h2 {
        color: var(--text-primary);
        margin: 0;
        font-size: 1.3rem;
    }

    .section-content {
        padding: 1.5rem;
    }

    .notifications-table {
        width: 100%;
        border-collapse: collapse;
    }

    .table-header {
        background: var(--background-tertiary);
        border-bottom: 2px solid var(--border-medium);
    }

    .table-cell {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-light);
        color: var(--text-primary);
    }

    .table-header .table-cell {
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
    }

    .notification-row {
        transition: background-color 0.2s ease;
    }

    .notification-row:hover {
        background: var(--background-tertiary);
    }

    .notification-row.unread {
        background: rgba(59, 130, 246, 0.05);
    }

    .notification-type {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-small);
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        background: var(--primary-blue);
        color: white;
    }

    .notification-content {
        max-width: 300px;
    }

    .notification-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .notification-message {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .item-badge {
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-small);
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-right: 0.5rem;
        margin-bottom: 0.25rem;
        display: inline-block;
    }

    .item-badge.task {
        background: var(--warning);
        color: white;
    }

    .item-badge.project {
        background: var(--success);
        color: white;
    }

    .item-badge.subtask {
        background: var(--primary-blue);
        color: white;
    }

    .notification-time {
        text-align: center;
    }

    .time-ago {
        color: var(--text-primary);
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .time-date {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-small);
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-badge.unread {
        background: var(--primary-blue);
        color: white;
    }

    .status-badge.read {
        background: var(--background-secondary);
        color: var(--text-secondary);
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 0.375rem 0.75rem;
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-small);
        background: var(--background-primary);
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .action-btn:hover {
        border-color: var(--primary-blue);
        background: var(--background-tertiary);
    }

    .action-btn.primary {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .action-btn.primary:hover {
        background: var(--primary-dark);
    }

    .action-btn.danger {
        background: var(--danger);
        color: white;
        border-color: var(--danger);
    }

    .action-btn.danger:hover {
        background: #991B1B;
    }

    .comments-section {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        margin-bottom: 2rem;
    }

    .comment-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border-light);
        transition: background-color 0.2s ease;
    }

    .comment-item:hover {
        background: var(--background-tertiary);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .comment-user {
        font-weight: 600;
        color: var(--text-primary);
    }

    .comment-time {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    .comment-content {
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        line-height: 1.4;
    }

    .comment-context {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .response-form {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--background-secondary);
        border-radius: var(--radius-small);
        border: 1px solid var(--border-light);
    }

    .response-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-small);
        background: var(--background-primary);
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        resize: vertical;
        min-height: 60px;
    }

    .response-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .notification-details {
        padding: 1rem;
    }

    .detail-row {
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-row strong {
        color: var(--text-primary);
        min-width: 100px;
        margin-right: 1rem;
    }

    .detail-row:not(:first-child) strong {
        margin-top: 0.25rem;
    }

    .modal-content {
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-medium);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
    }

    .modal-header h3 {
        margin: 0;
        color: var(--text-primary);
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0;
    }

    .close-btn:hover {
        color: var(--text-primary);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-small);
        background: var(--background-primary);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-medium);
        border-radius: var(--radius-small);
        background: var(--background-primary);
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .btn:hover {
        border-color: var(--primary-blue);
        background: var(--background-tertiary);
    }

    .btn-primary {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .empty-state h3 {
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    @media (max-width: 768px) {
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .table-cell {
            padding: 0.5rem;
            font-size: 0.8rem;
        }
        
        .notification-content {
            max-width: 200px;
        }
    }

    .triggered-by {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .user-badge {
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .admin-badge {
        background: var(--success);
        color: white;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .no-trigger {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="admin-notifications">
    <h1>Enhanced Admin Notifications</h1>
    
    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_notifications }}</div>
            <div class="stat-label">Total Notifications</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ unread_notifications }}</div>
            <div class="stat-label">Unread</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ admin_notifications }}</div>
            <div class="stat-label">Admin Generated</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ team_notifications }}</div>
            <div class="stat-label">Team Generated</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <h3>Filters</h3>
        <div class="filters-grid">
            <div class="filter-group">
                <label for="typeFilter">Notification Type:</label>
                <select id="typeFilter" class="filter-select" onchange="filterNotifications()">
                    <option value="">All Types</option>
                    {% for type_code, type_name in notification_types %}
                        <option value="{{ type_code }}">{{ type_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" class="filter-select" onchange="filterNotifications()">
                    <option value="">All Status</option>
                    <option value="unread">Unread</option>
                    <option value="read">Read</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="adminFilter">Source:</label>
                <select id="adminFilter" class="filter-select" onchange="filterNotifications()">
                    <option value="">All Sources</option>
                    <option value="true">Admin Generated</option>
                    <option value="false">Team Generated</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn btn-primary" onclick="openSendMessageModal()">
                    <i class="fas fa-envelope"></i> Send Message
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Comments Needing Response -->
    <div class="comments-section">
        <div class="section-header">
            <h2>Recent Comments Needing Response</h2>
        </div>
        <div class="section-content">
            <!-- Task Comments -->
            {% if recent_task_comments %}
            <h4>Task Comments</h4>
            {% for comment in recent_task_comments %}
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-user">{{ comment.user.get_full_name|default:comment.user.username }}</span>
                    <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                </div>
                <div class="comment-context">
                    <span class="item-badge task">Task: {{ comment.task.title }}</span>
                    <span class="item-badge project">Project: {{ comment.task.project.name }}</span>
                </div>
                <div class="comment-content">{{ comment.comment }}</div>
                <div class="response-form">
                    <textarea class="response-input" placeholder="Type your response..." id="task-response-{{ comment.id }}"></textarea>
                    <div class="response-actions">
                        <button class="btn" onclick="closeResponseForm('task', {{ comment.id }})">Cancel</button>
                        <button class="btn btn-primary" onclick="sendTaskResponse({{ comment.id }})">Send Response</button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Subtask Comments -->
            {% if recent_subtask_comments %}
            <h4>Subtask Comments</h4>
            {% for comment in recent_subtask_comments %}
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-user">{{ comment.user.get_full_name|default:comment.user.username }}</span>
                    <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                </div>
                <div class="comment-context">
                    <span class="item-badge subtask">Subtask: {{ comment.subtask.title }}</span>
                    <span class="item-badge task">Task: {{ comment.subtask.task.title }}</span>
                    <span class="item-badge project">Project: {{ comment.subtask.task.project.name }}</span>
                </div>
                <div class="comment-content">{{ comment.comment }}</div>
                <div class="response-form">
                    <textarea class="response-input" placeholder="Type your response..." id="subtask-response-{{ comment.id }}"></textarea>
                    <div class="response-actions">
                        <button class="btn" onclick="closeResponseForm('subtask', {{ comment.id }})">Cancel</button>
                        <button class="btn btn-primary" onclick="sendSubtaskResponse({{ comment.id }})">Send Response</button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}

            {% if not recent_task_comments and not recent_subtask_comments %}
            <div class="empty-state">
                <h3>No Comments Needing Response</h3>
                <p>All recent comments have been responded to by admins.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- All Notifications -->
    <div class="notifications-section">
        <div class="section-header">
            <h2>All Notifications</h2>
            <div class="action-buttons">
                <button class="action-btn" onclick="markAllAsRead()">Mark All Read</button>
                <button class="action-btn danger" onclick="deleteSelected()">Delete Selected</button>
            </div>
        </div>
        <div class="section-content">
            {% if notifications %}
            <div class="notifications-table">
                <div class="table-header">
                    <div class="table-cell">Type</div>
                    <div class="table-cell">Content</div>
                    <div class="table-cell">Recipient</div>
                    <div class="table-cell">Triggered By</div>
                    <div class="table-cell">Time</div>
                    <div class="table-cell">Status</div>
                    <div class="table-cell">Actions</div>
                </div>
                
                {% for notification in notifications %}
                <div class="table-row notification-row {% if not notification.is_read %}unread{% endif %}" data-id="{{ notification.id }}">
                    <div class="table-cell">
                        <div class="notification-type">
                            <span class="type-badge">{{ notification.get_notification_type_display }}</span>
                            {% if notification.is_admin_notification %}
                                <span class="item-badge" style="background: var(--success);">Admin</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="table-cell">
                        <div class="notification-content">
                            <div class="notification-title">{{ notification.title }}</div>
                            <div class="notification-message">{{ notification.message|truncatechars:100 }}</div>
                            {% if notification.related_task %}
                                <span class="item-badge task">Task: {{ notification.related_task.title }}</span>
                            {% endif %}
                            {% if notification.related_project %}
                                <span class="item-badge project">Project: {{ notification.related_project.name }}</span>
                            {% endif %}
                            {% if notification.related_subtask %}
                                <span class="item-badge subtask">Subtask: {{ notification.related_subtask.title }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="table-cell">
                        {% if notification.recipient %}
                            {{ notification.recipient.get_full_name|default:notification.recipient.username }}
                        {% elif notification.triggered_by %}
                            {{ notification.triggered_by.get_full_name|default:notification.triggered_by.username }}
                        {% else %}
                            <span class="no-recipient">System</span>
                        {% endif %}
                    </div>
                    
                    <div class="table-cell">
                        {% if notification.triggered_by %}
                            <div class="triggered-by">
                                <span class="user-badge">{{ notification.triggered_by.get_full_name|default:notification.triggered_by.username }}</span>
                                {% if notification.triggered_by.is_staff %}
                                    <span class="admin-badge">Admin</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="no-trigger">System</span>
                        {% endif %}
                    </div>
                    
                    <div class="table-cell">
                        <div class="notification-time">
                            <div class="time-ago">{{ notification.created_at|timesince }} ago</div>
                            <div class="time-date">{{ notification.created_at|date:"M d, Y" }}</div>
                        </div>
                    </div>
                    
                    <div class="table-cell">
                        <span class="status-badge {% if notification.is_read %}read{% else %}unread{% endif %}">
                            {% if notification.is_read %}Read{% else %}Unread{% endif %}
                        </span>
                    </div>
                    
                    <div class="table-cell">
                        <div class="action-buttons">
                            <input type="checkbox" class="notification-checkbox" value="{{ notification.id }}">
                            <button class="action-btn" onclick="toggleReadStatus({{ notification.id }})" title="Toggle Read Status">
                                {% if notification.is_read %}
                                    <i class="fas fa-eye-slash"></i>
                                {% else %}
                                    <i class="fas fa-eye"></i>
                                {% endif %}
                            </button>
                            <button class="action-btn" onclick="viewNotificationDetails({{ notification.id }})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn danger" onclick="deleteNotification({{ notification.id }})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <h3>No Notifications</h3>
                <p>There are no notifications to display.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div class="modal" id="sendMessageModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Send Message</h3>
            <button class="close-btn" onclick="closeSendMessageModal()">&times;</button>
        </div>
        <form id="sendMessageForm">
            <div class="form-group">
                <label for="recipientSelect">Recipient:</label>
                <select id="recipientSelect" name="recipient_id" class="form-control" required>
                    <option value="">Select Recipient</option>
                    <option value="all">All Users</option>
                    {% for user in available_users %}
                        <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="messageTitle">Message Title:</label>
                <input type="text" id="messageTitle" name="message_title" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="messageText">Message:</label>
                <textarea id="messageText" name="message_text" class="form-control" rows="4" required></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeSendMessageModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Send Message</button>
            </div>
        </form>
    </div>
</div>

<!-- Notification Details Modal -->
<div class="modal" id="notificationDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Notification Details</h3>
            <button class="close-btn" onclick="closeNotificationDetailsModal()">&times;</button>
        </div>
        <div id="notificationDetailsContent">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    console.log('DEBUG: JavaScript loading...');
    
    // Filter notifications
    function filterNotifications() {
        console.log('DEBUG: filterNotifications called');
        const typeFilter = document.getElementById('typeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const adminFilter = document.getElementById('adminFilter').value;
        
        console.log('DEBUG: Filter values:', { typeFilter, statusFilter, adminFilter });
        
        let url = new URL(window.location);
        if (typeFilter) url.searchParams.set('type', typeFilter);
        else url.searchParams.delete('type');
        
        if (statusFilter) url.searchParams.set('status', statusFilter);
        else url.searchParams.delete('status');
        
        if (adminFilter) url.searchParams.set('admin', adminFilter);
        else url.searchParams.delete('admin');
        
        console.log('DEBUG: Redirecting to:', url.toString());
        window.location.href = url.toString();
    }

    // Toggle read status
    function toggleReadStatus(notificationId) {
        console.log('DEBUG: toggleReadStatus called with ID:', notificationId);
        fetch(`/notifications/${notificationId}/read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            console.log('DEBUG: Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('DEBUG: Response data:', data);
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the notification.');
        });
    }

    // Mark all as read
    function markAllAsRead() {
        console.log('DEBUG: markAllAsRead called');
        const checkboxes = document.querySelectorAll('.notification-checkbox:checked');
        const notificationIds = Array.from(checkboxes).map(cb => cb.value);
        console.log('DEBUG: Selected notification IDs:', notificationIds);
        
        if (notificationIds.length === 0) {
            alert('Please select notifications to mark as read.');
            return;
        }
        
        // Mark selected as read
        Promise.all(notificationIds.map(id => 
            fetch(`/notifications/${id}/read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(response => response.json())
        )).then(results => {
            console.log('DEBUG: Mark as read results:', results);
            const failedCount = results.filter(result => !result.success).length;
            if (failedCount > 0) {
                alert(`${failedCount} notification(s) failed to update. Please try again.`);
            } else {
                location.reload();
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating notifications.');
        });
    }

    // Delete selected notifications
    function deleteSelected() {
        console.log('DEBUG: deleteSelected called');
        const checkboxes = document.querySelectorAll('.notification-checkbox:checked');
        const notificationIds = Array.from(checkboxes).map(cb => cb.value);
        console.log('DEBUG: Selected notification IDs for deletion:', notificationIds);
        
        if (notificationIds.length === 0) {
            alert('Please select notifications to delete.');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${notificationIds.length} notification(s)?`)) {
            // Delete selected notifications
            Promise.all(notificationIds.map(id => 
                fetch(`/notifications/${id}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                }).then(response => response.json())
            )).then(results => {
                console.log('DEBUG: Delete results:', results);
                const failedCount = results.filter(result => !result.success).length;
                if (failedCount > 0) {
                    alert(`${failedCount} notification(s) failed to delete. Please try again.`);
                } else {
                    location.reload();
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting notifications.');
            });
        }
    }

    // Delete single notification
    function deleteNotification(notificationId) {
        console.log('DEBUG: ===== DELETE NOTIFICATION START =====');
        console.log('DEBUG: deleteNotification called with ID:', notificationId);
        console.log('DEBUG: Function is accessible and working');
        console.log('DEBUG: Current URL:', window.location.href);
        
        if (confirm('Are you sure you want to delete this notification?')) {
            console.log('DEBUG: User confirmed deletion, making API call...');
            
            const csrfToken = getCookie('csrftoken');
            console.log('DEBUG: CSRF token:', csrfToken);
            
            const url = `/notifications/${notificationId}/delete/`;
            console.log('DEBUG: Making request to URL:', url);
            console.log('DEBUG: Full URL would be:', window.location.origin + url);
            
            console.log('DEBUG: About to make fetch request...');
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('DEBUG: Fetch response received!');
                console.log('DEBUG: Response status:', response.status);
                console.log('DEBUG: Response ok:', response.ok);
                console.log('DEBUG: Response statusText:', response.statusText);
                console.log('DEBUG: Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('DEBUG: Response parsed as JSON successfully');
                console.log('DEBUG: Delete response data:', data);
                if (data.success) {
                    console.log('DEBUG: Delete successful, reloading page...');
                    location.reload();
                } else {
                    console.error('DEBUG: Delete failed:', data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('DEBUG: ===== DELETE ERROR =====');
                console.error('DEBUG: Delete request failed:', error);
                console.error('DEBUG: Error name:', error.name);
                console.error('DEBUG: Error message:', error.message);
                console.error('DEBUG: Error stack:', error.stack);
                alert('An error occurred while deleting the notification. Check console for details.');
            });
        } else {
            console.log('DEBUG: User cancelled deletion');
        }
        console.log('DEBUG: ===== DELETE NOTIFICATION END =====');
    }

    // Send task response
    function sendTaskResponse(commentId) {
        const responseText = document.getElementById(`task-response-${commentId}`).value.trim();
        
        if (!responseText) {
            alert('Please enter a response.');
            return;
        }
        
        const formData = new FormData();
        formData.append('response_text', responseText);
        
        fetch(`/admin/respond/task-comment/${commentId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Response sent successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while sending the response.');
        });
    }

    // Send subtask response
    function sendSubtaskResponse(commentId) {
        const responseText = document.getElementById(`subtask-response-${commentId}`).value.trim();
        
        if (!responseText) {
            alert('Please enter a response.');
            return;
        }
        
        const formData = new FormData();
        formData.append('response_text', responseText);
        
        fetch(`/admin/respond/subtask-comment/${commentId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Response sent successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while sending the response.');
        });
    }

    // Close response form
    function closeResponseForm(type, commentId) {
        const responseForm = document.querySelector(`#${type}-response-${commentId}`).closest('.response-form');
        responseForm.style.display = 'none';
    }

    // Send message modal functions
    function openSendMessageModal() {
        document.getElementById('sendMessageModal').classList.add('show');
    }

    function closeSendMessageModal() {
        document.getElementById('sendMessageModal').classList.remove('show');
        document.getElementById('sendMessageForm').reset();
    }

    // Send message form submission
    document.getElementById('sendMessageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('/admin/send-message/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Message sent successfully!');
                closeSendMessageModal();
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while sending the message.');
        });
    });

    // View notification details
    function viewNotificationDetails(notificationId) {
        console.log('DEBUG: ===== VIEW NOTIFICATION START =====');
        console.log('DEBUG: viewNotificationDetails called with ID:', notificationId);
        console.log('DEBUG: Current URL:', window.location.href);
        
        // Check if modal elements exist
        const modal = document.getElementById('notificationDetailsModal');
        const content = document.getElementById('notificationDetailsContent');
        
        console.log('DEBUG: Modal element found:', modal);
        console.log('DEBUG: Content element found:', content);
        console.log('DEBUG: Modal element type:', typeof modal);
        console.log('DEBUG: Content element type:', typeof content);
        
        if (!modal) {
            console.error('DEBUG: Modal element not found');
            console.error('DEBUG: Available elements with "modal" in ID:');
            document.querySelectorAll('[id*="modal"]').forEach(el => {
                console.error('DEBUG: - Found element:', el.id, el.tagName);
            });
            alert('Modal not found');
            return;
        }
        
        if (!content) {
            console.error('DEBUG: Modal content element not found');
            console.error('DEBUG: Available elements with "content" in ID:');
            document.querySelectorAll('[id*="content"]').forEach(el => {
                console.error('DEBUG: - Found element:', el.id, el.tagName);
            });
            alert('Modal content not found');
            return;
        }
        
        // Find the notification row
        const notificationRow = document.querySelector(`[data-id="${notificationId}"]`);
        if (!notificationRow) {
            console.error('DEBUG: Notification row not found for ID:', notificationId);
            console.error('DEBUG: Available data-id elements:');
            document.querySelectorAll('[data-id]').forEach(el => {
                console.error('DEBUG: - Found element with data-id:', el.getAttribute('data-id'), el.tagName);
            });
            alert('Notification not found');
            return;
        }
        
        console.log('DEBUG: Found notification row:', notificationRow);
        console.log('DEBUG: Notification row HTML:', notificationRow.outerHTML);
        
        // Extract notification information
        const typeElement = notificationRow.querySelector('.type-badge');
        const titleElement = notificationRow.querySelector('.notification-title');
        const messageElement = notificationRow.querySelector('.notification-message');
        const recipientElement = notificationRow.querySelector('.table-cell:nth-child(3)');
        const timeElement = notificationRow.querySelector('.time-ago');
        const statusElement = notificationRow.querySelector('.status-badge');
        
        console.log('DEBUG: Found elements:', {
            typeElement: typeElement?.tagName,
            titleElement: titleElement?.tagName,
            messageElement: messageElement?.tagName,
            recipientElement: recipientElement?.tagName,
            timeElement: timeElement?.tagName,
            statusElement: statusElement?.tagName
        });
        
        const type = typeElement ? typeElement.textContent : 'N/A';
        const title = titleElement ? titleElement.textContent : 'N/A';
        const message = messageElement ? messageElement.textContent : 'N/A';
        const recipient = recipientElement ? recipientElement.textContent.trim() : 'N/A';
        const time = timeElement ? timeElement.textContent : 'N/A';
        const status = statusElement ? statusElement.textContent.trim() : 'N/A';
        
        console.log('DEBUG: Extracted notification details:', { type, title, message, recipient, time, status });
        
        console.log('DEBUG: Modal and content elements found, updating content');
        
        const contentHTML = `
            <div class="notification-details">
                <div class="detail-row">
                    <strong>Type:</strong> ${type}
                </div>
                <div class="detail-row">
                    <strong>Title:</strong> ${title}
                </div>
                <div class="detail-row">
                    <strong>Message:</strong> ${message}
                </div>
                <div class="detail-row">
                    <strong>Recipient:</strong> ${recipient}
                </div>
                <div class="detail-row">
                    <strong>Time:</strong> ${time}
                </div>
                <div class="detail-row">
                    <strong>Status:</strong> ${status}
                </div>
            </div>
        `;
        
        console.log('DEBUG: Content HTML to be inserted:', contentHTML);
        content.innerHTML = contentHTML;
        console.log('DEBUG: Content updated, showing modal');
        
        // Check modal state before showing
        console.log('DEBUG: Modal classes before show:', modal.classList.toString());
        console.log('DEBUG: Modal display before show:', window.getComputedStyle(modal).display);
        console.log('DEBUG: Modal visibility before show:', window.getComputedStyle(modal).visibility);
        console.log('DEBUG: Modal opacity before show:', window.getComputedStyle(modal).opacity);
        
        modal.classList.add('show');
        console.log('DEBUG: Modal should now be visible');
        console.log('DEBUG: Modal classes after show:', modal.classList.toString());
        
        // Additional debugging - check modal state
        setTimeout(() => {
            const modalVisible = modal.classList.contains('show');
            const modalDisplay = window.getComputedStyle(modal).display;
            const modalVisibility = window.getComputedStyle(modal).visibility;
            const modalOpacity = window.getComputedStyle(modal).opacity;
            const modalZIndex = window.getComputedStyle(modal).zIndex;
            
            console.log('DEBUG: Modal state after show:', { 
                modalVisible, 
                modalDisplay, 
                modalVisibility, 
                modalOpacity, 
                modalZIndex 
            });
            
            // Check if modal is actually visible
            const rect = modal.getBoundingClientRect();
            console.log('DEBUG: Modal bounding rect:', rect);
            console.log('DEBUG: Modal is in viewport:', rect.width > 0 && rect.height > 0);
        }, 100);
        
        console.log('DEBUG: ===== VIEW NOTIFICATION END =====');
    }

    function closeNotificationDetailsModal() {
        document.getElementById('notificationDetailsModal').classList.remove('show');
    }

    // Get CSRF token from cookies
    function getCookie(name) {
        console.log('DEBUG: getCookie called for:', name);
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            console.log('DEBUG: All cookies:', document.cookie);
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    console.log('DEBUG: Found cookie value:', cookieValue);
                    break;
                }
            }
        }
        console.log('DEBUG: Returning cookie value:', cookieValue);
        return cookieValue;
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('show');
        }
    }
    
    // Test function accessibility when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DEBUG: ===== PAGE LOAD DEBUG START =====');
        console.log('DEBUG: Page loaded, testing function accessibility');
        console.log('DEBUG: Current URL:', window.location.href);
        console.log('DEBUG: Document ready state:', document.readyState);
        
        // Test function accessibility
        console.log('DEBUG: deleteNotification function accessible:', typeof deleteNotification);
        console.log('DEBUG: viewNotificationDetails function accessible:', typeof viewNotificationDetails);
        console.log('DEBUG: toggleReadStatus function accessible:', typeof toggleReadStatus);
        console.log('DEBUG: markAllAsRead function accessible:', typeof markAllAsRead);
        console.log('DEBUG: deleteSelected function accessible:', typeof deleteSelected);
        
        // Test if we can find notification buttons
        const deleteButtons = document.querySelectorAll('button[onclick*="deleteNotification"]');
        const viewButtons = document.querySelectorAll('button[onclick*="viewNotificationDetails"]');
        const readButtons = document.querySelectorAll('button[onclick*="toggleReadStatus"]');
        
        console.log('DEBUG: Found delete buttons:', deleteButtons.length);
        console.log('DEBUG: Found view buttons:', viewButtons.length);
        console.log('DEBUG: Found read buttons:', readButtons.length);
        
        if (deleteButtons.length > 0) {
            console.log('DEBUG: First delete button onclick:', deleteButtons[0].getAttribute('onclick'));
            console.log('DEBUG: First delete button HTML:', deleteButtons[0].outerHTML);
        }
        
        if (viewButtons.length > 0) {
            console.log('DEBUG: First view button onclick:', viewButtons[0].getAttribute('onclick'));
            console.log('DEBUG: First view button HTML:', viewButtons[0].outerHTML);
        }
        
        // Test modal elements
        const modal = document.getElementById('notificationDetailsModal');
        const content = document.getElementById('notificationDetailsContent');
        console.log('DEBUG: Modal element found on load:', modal);
        console.log('DEBUG: Content element found on load:', content);
        
        // Test notification rows
        const notificationRows = document.querySelectorAll('[data-id]');
        console.log('DEBUG: Found notification rows:', notificationRows.length);
        if (notificationRows.length > 0) {
            console.log('DEBUG: First notification row data-id:', notificationRows[0].getAttribute('data-id'));
            console.log('DEBUG: First notification row HTML:', notificationRows[0].outerHTML);
        }
        
        // Test CSRF token
        const csrfToken = getCookie('csrftoken');
        console.log('DEBUG: CSRF token on page load:', csrfToken);
        
        // Test all elements with onclick attributes
        const allOnclickElements = document.querySelectorAll('[onclick]');
        console.log('DEBUG: Total elements with onclick:', allOnclickElements.length);
        allOnclickElements.forEach((el, index) => {
            console.log(`DEBUG: Element ${index + 1}:`, {
                tagName: el.tagName,
                id: el.id,
                className: el.className,
                onclick: el.getAttribute('onclick')
            });
        });
        
        console.log('DEBUG: ===== PAGE LOAD DEBUG END =====');
    });
    
    // Also test when window loads
    window.addEventListener('load', function() {
        console.log('DEBUG: ===== WINDOW LOAD DEBUG =====');
        console.log('DEBUG: Window fully loaded');
        console.log('DEBUG: All resources loaded');
        
        // Test if functions are still accessible after full load
        console.log('DEBUG: Functions after full load:');
        console.log('DEBUG: - deleteNotification:', typeof deleteNotification);
        console.log('DEBUG: - viewNotificationDetails:', typeof viewNotificationDetails);
        
        // Test button click simulation
        const deleteButtons = document.querySelectorAll('button[onclick*="deleteNotification"]');
        if (deleteButtons.length > 0) {
            console.log('DEBUG: Testing first delete button click simulation...');
            const firstButton = deleteButtons[0];
            console.log('DEBUG: Button element:', firstButton);
            console.log('DEBUG: Button onclick attribute:', firstButton.getAttribute('onclick'));
            
            // Try to extract the notification ID from the onclick
            const onclickText = firstButton.getAttribute('onclick');
            const match = onclickText.match(/deleteNotification\((\d+)\)/);
            if (match) {
                console.log('DEBUG: Extracted notification ID from onclick:', match[1]);
            }
        }
    });
</script>
{% endblock %}
