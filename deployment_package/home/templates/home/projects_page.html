{% extends 'home/dashboard_base.html' %}
{% load static %}

{% block extra_css %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
/* Notification Styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-left: 4px solid #3b82f6;
    animation: slideInRight 0.3s ease-out;
}

.notification-success {
    border-left-color: #10b981;
}

.notification-error {
    border-left-color: #ef4444;
}

.notification-info {
    border-left-color: #3b82f6;
}

.notification-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    gap: 12px;
}

.notification-content span {
    flex: 1;
    color: #1f2937;
    font-size: 14px;
    line-height: 1.4;
}

.notification-close {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
    flex-shrink: 0;
}

.notification-close:hover {
    background: #f3f4f6;
    color: #374151;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Loading spinner styles */
.loading-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* Button loading state */
.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block content %}
<div class="projects-dashboard">
    <!-- Modern Header -->
    <div class="header">
        <div class="header-content">
            <h1 class="welcome-text">Projects</h1>
            <p class="subtitle">{% if can_edit_projects or can_delete_projects %}Manage and track your project portfolio{% else %}View your assigned projects{% endif %}</p>
        </div>
        <div class="header-actions">
            <!-- Theme Toggle -->
            
            
            {% if can_create_projects %}
            <button class="add-btn" onclick="document.getElementById('addProjectModal').style.display='block';">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Project
            </button>
            {% endif %}
        </div>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {% if message.tags %}message-{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Modern Filters -->
    <div class="filters-section">
        <div class="search-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" id="searchProjects" placeholder="Search projects..." />
        </div>
        
        <div class="filter-controls">
            <select class="status-filter" id="statusFilter">
                <option value="">All Status</option>
                <option value="planned">Planned</option>
                <option value="in_progress">In Progress</option>
                <option value="in_progress_guidance_required">In Progress (Guidance Required)</option>
                <option value="completed">Completed</option>
                <option value="completed_review_pending">Completed (Review Pending)</option>
                <option value="completed_data_discrepancy_addressing">Completed (Data Discrepancy addressing)</option>
            </select>
            
            <button class="clear-btn" onclick="clearFilters()">Clear</button>
        </div>
    </div>

    <!-- Projects Grid -->
    <div class="projects-container">
        {% for project in projects %}
        <div class="project-card" data-status="{{ project.status }}" data-name="{{ project.name|lower }}" data-client="{{ project.client|lower }}" data-project-id="{{ project.id }}" data-client-email="{{ project.client_email|default:'' }}" data-client-username="{{ project.client_username|default:'' }}">
            <div class="project-header">
                <div class="project-title">
                    <h3>{{ project.name }}</h3>
                    <span class="client-name">{{ project.client }}</span>
                </div>
                <div class="status-indicator">
                    <span class="status-dot {{ project.status }}"></span>
                    <span class="status-text">{{ project.get_status_display }}</span>
                </div>
            </div>
            
            <div class="project-details">
                <div class="detail-item">
                    <span class="label">Email</span>
                    <span class="value">{{ project.client_email|default:"Not provided" }}</span>
                </div>
                
                <div class="detail-item">
                    <span class="label">Duration</span>
                    <span class="value">
                        {% if project.start_date and project.end_date %}
                            {{ project.start_date|date:"M d" }} - {{ project.end_date|date:"M d, Y" }}
                        {% else %}
                            Not set
                        {% endif %}
                    </span>
                </div>
                
                <div class="detail-item">
                    <span class="label">Created</span>
                    <span class="value">{{ project.created_at|date:"M d, Y" }}</span>
                </div>
                

                
                <div class="detail-item">
                    <span class="label">Assigned To</span>
                    <div class="assigned-users-section">
                        {% if project.assigned_users.all %}
                            <div class="assigned-users-list">
                                {% for user in project.assigned_users.all %}
                                    <span class="user-badge">{{ user.get_full_name|default:user.username }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="value">No users assigned</span>
                        {% endif %}
                        

                    </div>
                </div>
            </div>
            
            <div class="project-actions">
                <button class="btn btn-sm btn-primary" onclick="viewProjectDetails({{ project.id }})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    View
                </button>
                
                {% if can_edit_projects %}
                <button class="btn btn-sm btn-secondary" onclick="editProject({{ project.id }})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Edit
                </button>
                {% endif %}
                
                {% if project.client_email %}
                <button class="btn btn-sm btn-info" onclick="sendProjectReport({{ project.id }})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2H2v16h20V2zM2 22l4-4h16"></path>
                    </svg>
                    Send Report
                </button>
                {% endif %}
                
                {% if user.is_staff and project.client_email %}
                <button class="btn btn-sm btn-warning" onclick="sendClientOTP({{ project.id }}, '{{ project.client_username|default:"" }}', '{{ project.client_email }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/>
                    </svg>
                    Reset Password
                </button>
                {% endif %}
                
                {% if can_delete_projects %}
                <button class="btn btn-sm btn-danger" onclick="deleteProject({{ project.id }})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                    </svg>
                    Delete
                </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                </svg>
            </div>
            <h3>No projects yet</h3>
            <p>{% if can_create_projects %}Get started by creating your first project{% else %}You haven't been assigned to any projects yet{% endif %}</p>
            {% if can_create_projects %}
            <button class="add-btn" onclick="openAddProjectModal()">Create Project</button>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modern Add Project Modal -->
<div id="addProjectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Project</h2>
            <button class="close-btn" onclick="closeAddProjectModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <!-- Tabs -->
            <div class="edit-project-tabs">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="basic-info">
                        <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Basic Info
                    </button>
                    <button class="tab-btn" data-tab="tasks-breakdown">
                        <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Tasks & Subtasks
                    </button>
                </div>
            </div>

            <!-- Basic Info Tab -->
            <div class="tab-content active" id="basic-info">
                <form id="basicProjectForm" method="POST" action="{% url 'add_project' %}">
                    {% csrf_token %}
                    
                    <!-- Client Type Selection -->
                    <div class="client-type-section">
                        <h3>Client Information</h3>
                        <div class="client-type-options">
                            <label class="client-type-option">
                                <input type="radio" name="is_existing_client" value="false" id="new-client" checked onchange="toggleClientType()">
                                <span class="radio-custom"></span>
                                <div class="option-content">
                                    <h4>New Client</h4>
                                    <p>Create a new client account{% if user.is_staff %} and send OTP for setup{% endif %}</p>
                                </div>
                            </label>
                            <label class="client-type-option">
                                <input type="radio" name="is_existing_client" value="true" id="existing-client" onchange="toggleClientType()">
                                <span class="radio-custom"></span>
                                <div class="option-content">
                                    <h4>Existing Client</h4>
                                    <p>Use existing client credentials{% if user.is_staff %} (no OTP needed){% endif %}</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="project_name">Project Name *</label>
                        <input type="text" id="project_name" name="name" required>
                    </div>
                    
                    <!-- New Client Fields -->
                    <div id="new-client-fields">
                        <div class="form-group">
                            <label for="client_name">Client Name *</label>
                            <input type="text" id="client_name" name="client" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="client_username">Client Username (Optional)</label>
                                <input type="text" id="client_username" name="client_username" placeholder="Username for client login">
                                <small>If not provided, will be generated from email</small>
                            </div>
                            <div class="form-group">
                                <label for="client_email">Client Email *</label>
                                <input type="email" id="client_email" name="client_email" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Existing Client Fields -->
                    <div id="existing-client-fields" style="display: none;">
                        <div class="form-group">
                            <label for="existing_client_select">Select Existing Client *</label>
                            <select id="existing_client_select" name="existing_client_id" onchange="fillExistingClientInfo()" required>
                                <option value="">Choose an existing client...</option>
                                {% for client in existing_clients %}
                                    <option value="{{ client.id }}" data-username="{{ client.username }}" data-email="{{ client.email }}" data-name="{{ client.username }}">
                                        {{ client.username }} ({{ client.email }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="existing_client_email">Client Email (Read-only)</label>
                                <input type="email" id="existing_client_email" name="existing_client_email" readonly>
                            </div>
                            <div class="form-group">
                                <label for="existing_client_username">Client Username (Read-only)</label>
                                <input type="text" id="existing_client_username" name="existing_client_username" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="existing_client_name">Client Name (Read-only)</label>
                            <input type="text" id="existing_client_name" name="existing_client_name" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="project_status">Status *</label>
                            <select id="project_status" name="status" required>
                                <option value="planned">Planned</option>
                                <option value="in_progress">In Progress</option>
                                <option value="in_progress_guidance_required">In Progress (Guidance Required)</option>
                                <option value="completed">Completed</option>
                                <option value="completed_review_pending">Completed (Review Pending)</option>
                                <option value="completed_data_discrepancy_addressing">Completed (Data Discrepancy addressing)</option>
                            </select>
                        </div>
                        

                        <div class="form-group">
                            <label>Project Duration (Auto-calculated)</label>
                            <div class="duration-display" id="project-duration-display">
                                Not set (add tasks with dates)
                            </div>
                            <div class="duration-warning" id="duration-warning" style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                    <line x1="12" y1="9" x2="12" y2="13"></line>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                <span>Warning: Tasks added but no dates set. Project will not have start/end dates.</span>
                            </div>
                            <small class="help-text">Project dates are automatically calculated from task start and end dates</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="assigned_users">Assign Users (Optional)</label>
                        <select id="assigned_users" name="assigned_users" multiple size="4">
                            {% for user in all_users %}
                                <option value="{{ user.id }}">
                                    {{ user.username }} {% if user.is_staff %}(Admin){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple users</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddProjectModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitProjectForm()">Create Project</button>
                    </div>
                </form>
            </div>

            <!-- Tasks Breakdown Tab -->
            <div class="tab-content" id="tasks-breakdown">
                <div class="section-title">Project Tasks</div>
                
                <!-- Add New Task Button -->
                <div class="add-task-section">
                    <button type="button" class="add-task-btn" onclick="openAddTaskModal()">+ Add New Task</button>
                </div>
                
                <!-- Tasks List -->
                <div class="existing-tasks" id="project-tasks">
                    <!-- Tasks will be added here -->
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddProjectModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitProjectForm()">Create Project</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Task</h2>
            <span class="close" onclick="closeAddTaskModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addTaskForm" method="POST" action="{% url 'add_task' %}">
                {% csrf_token %}
                <input type="hidden" name="project_id" value="{{ project.id }}">
                
                <div class="form-group">
                    <label for="task_title">Task Title *</label>
                    <input type="text" id="task_title" name="title" required>
                </div>
                
                <div class="form-group">
                    <label for="task_description">Description</label>
                    <textarea id="task_description" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="task_status">Status *</label>
                    <select id="task_status" name="status" required>
                        <option value="not_started">Not Started</option>
                        <option value="in_progress">In Progress</option>
                        <option value="in_progress_guidance_required">In Progress (Guidance Required)</option>
                        <option value="completed">Completed</option>
                        <option value="completed_review_pending">Completed (Review Pending)</option>
                        <option value="completed_data_discrepancy_addressing">Completed (Data Discrepancy addressing)</option>
                        <option value="on_hold">On Hold</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="task_development_status">Development Status *</label>
                    <select id="task_development_status" name="development_status" required>
                        <option value="original_quoted">Original/Quoted Development</option>
                        <option value="new_development">New Development</option>
                        <option value="new_development_qms">New Development – QMS must be involved</option>
                        <option value="new_development_qms_change">New Development – QMS Change</option>
                        <option value="new_quoted_development">New Development/Quoted Development</option>
                        <option value="ongoing_development">Ongoing Development</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="task_priority">Priority *</label>
                    <select id="task_priority" name="priority" required>
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="task_start_date">Start Date</label>
                        <input type="date" id="task_start_date" name="start_date">
                    </div>
                    
                    <div class="form-group">
                        <label for="task_end_date">End Date</label>
                        <input type="date" id="task_end_date" name="end_date">
                    </div>
                </div>
                
                                    <div class="form-group">
                        <label for="task_assigned_to">Assigned To</label>
                        <select id="task_assigned_to" name="assigned_to" class="form-select" multiple>
                            <option value="">Select Users</option>
                            {% for user in all_users %}
                                <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple users</small>
                    </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addTaskFromModal()">Add Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Subtask Modal -->
<div id="addSubtaskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Subtask</h2>
            <span class="close" onclick="closeAddSubtaskModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addSubtaskForm" method="POST">
                {% csrf_token %}
                <input type="hidden" name="task_id" id="subtask_task_id">
                
                <div class="form-group">
                    <label for="subtask_title">Subtask Title *</label>
                    <input type="text" id="subtask_title" name="title" required>
                </div>
                
                <div class="form-group">
                    <label for="subtask_description">Description</label>
                    <textarea id="subtask_description" name="description" rows="2"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="subtask_start_date">Start Date</label>
                        <input type="date" id="subtask_start_date" name="start_date" onchange="validateNewSubtaskDates()">
                    </div>
                    
                    <div class="form-group">
                        <label for="subtask_end_date">End Date</label>
                        <input type="date" id="subtask_end_date" name="end_date" onchange="validateNewSubtaskDates()">
                    </div>
                </div>
                
                <div class="date-validation-warning" id="new-subtask-date-validation" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>Warning: Subtask dates cannot exceed the parent task's date range.</span>
                </div>
                
                <div class="form-group">
                    <label for="subtask_priority">Priority</label>
                    <select id="subtask_priority" name="priority" class="form-select">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subtask_status">Status</label>
                    <select id="subtask_status" name="status" class="form-select">
                        <option value="not_started" selected>Not Started</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddSubtaskModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addSubtaskFromModal()">Add Subtask</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Project Details Modal -->
<div id="projectDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="projectDetailsTitle">Project Details</h2>
            <button class="close-btn" onclick="closeProjectDetailsModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="project-info-grid">
                <div class="info-item">
                    <span class="info-label">Project Name</span>
                    <span class="info-value" id="detail-project-name"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Client</span>
                    <span class="info-value" id="detail-client"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email</span>
                    <span class="info-value" id="detail-email"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Duration</span>
                    <span class="info-value" id="detail-weeks"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="info-value" id="detail-status"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Created</span>
                    <span class="info-value" id="detail-created"></span>
                </div>
            </div>
        </div>
    </div>
</div>



<style>
    /* Projects page specific theme variables that extend the base theme */
    :root {
        --primary-color: #2563eb;
        --primary-light: #60a5fa;
        --primary-dark: #1e40af;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;
        --gray-50: var(--background-secondary);
        --gray-100: var(--background-tertiary);
        --gray-200: var(--border-light);
        --gray-300: var(--border-medium);
        --gray-400: var(--border-dark);
        --gray-500: var(--text-muted);
        --gray-600: var(--text-secondary);
        --gray-700: var(--text-secondary);
        --gray-800: var(--text-primary);
        --gray-900: var(--text-primary);
        --white: var(--background-primary);
        --text-color: var(--text-primary);
        --shadow: var(--shadow-soft);
        --shadow-lg: var(--shadow-medium);
        --radius: var(--radius-small);
        --radius-lg: var(--radius-medium);
    }

    /* Base Styles */
    .projects-dashboard {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
        background: var(--gray-50);
        min-height: 100vh;
    }

    .main-content {
        padding: 2rem;
        background: var(--gray-50);
        min-height: 100vh;
    }

    /* Header */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding: 2rem;
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }

    .header-content .welcome-text {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
    }

    .subtitle {
        color: var(--gray-600);
        font-size: 1.125rem;
        margin: 0;
    }

    .add-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--primary-color);
        color: #ffffff !important;
        border: none;
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow);
    }

    .add-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
    }

    /* Header Actions and Theme Toggle */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }



    /* Messages */
    .messages {
        margin-bottom: 2rem;
    }

    .message {
        padding: 1rem 1.5rem;
        border-radius: var(--radius);
        margin-bottom: 1rem;
        font-weight: 500;
    }

    .message-success {
        background: #ecfdf5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .message-error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    /* Filters */
    .filters-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }

    .search-box {
        position: relative;
        flex: 1;
        max-width: 400px;
    }

    .search-box svg {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
    }

    .search-box input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        font-size: 0.875rem;
        background: var(--background-primary);
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .filter-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .status-filter,
    .clear-btn {
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        background: var(--background-primary);
        color: var(--text-primary);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .status-filter:focus,
    .clear-btn:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .clear-btn {
        background: var(--gray-100);
        color: var(--gray-700);
        font-weight: 500;
    }

    .clear-btn:hover {
        background: var(--gray-200);
        border-color: var(--gray-400);
    }

    /* Dark mode dropdown options */
    .status-filter option {
        background: var(--background-primary);
        color: var(--text-primary);
    }

    /* Ensure placeholder text is visible in both themes */
    .search-box input::placeholder {
        color: var(--text-muted);
    }

    /* Projects Grid */
    .projects-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 1.5rem;
    }

    .project-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: all 0.2s ease;
    }

    .project-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--gray-300);
    }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }

    .project-title h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
        line-height: 1.4;
    }

    .client-name {
        color: var(--gray-600);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--gray-400);
    }

    .status-dot.planned {
        background: var(--info);
    }

    .status-dot.in_progress {
        background: var(--warning);
    }

    .status-dot.completed {
        background: var(--success);
    }

    .status-text {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-600);
    }

    /* Project Details */
    .project-details {
        margin-bottom: 1.5rem;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--gray-100);
        gap: 1rem;
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-item .label {
        font-weight: 600;
        color: var(--gray-700);
        min-width: 80px;
        flex-shrink: 0;
    }

    .detail-item .value {
        color: var(--text-color);
        text-align: right;
        flex: 1;
    }

    .detail-item:has(.assigned-users-section) {
        align-items: flex-start;
    }

    .detail-item:has(.assigned-users-section) .value {
        text-align: left;
    }

    /* Project Actions */
    .project-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Button Styles */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        text-align: center;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
    }

    .btn-xs {
        padding: 0.375rem 0.75rem;
        font-size: 0.625rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: var(--white);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .btn-secondary {
        background: var(--gray-600);
        color: var(--white);
    }

    .btn-secondary:hover {
        background: var(--gray-700);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .btn-info {
        background: var(--info);
        color: var(--white);
    }

    .btn-info:hover {
        background: #0891b2;
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .btn-warning {
        background: var(--warning);
        color: var(--white);
    }

    .btn-warning:hover {
        background: #d97706;
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .btn-danger {
        background: var(--danger);
        color: var(--white);
    }

    .btn-danger:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .btn-success {
        background: var(--success);
        color: var(--white);
    }

    .btn-success:hover {
        background: #059669;
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--gray-600);
        color: var(--gray-600);
    }
    
    .btn-outline:hover {
        background: var(--gray-600);
        color: var(--white);
    }

    /* Assigned Users Section Styles */
    .assigned-users-section {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        flex-wrap: wrap;
        flex-direction: column;
        width: 100%;
    }

    .assigned-users-list {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
        width: 100%;
    }

    .user-badge {
        background: var(--gray-100);
        color: var(--gray-700);
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        border: 1px solid var(--gray-300);
        white-space: nowrap;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .btn-outline {
        background: transparent;
        color: var(--gray-600);
        border: 1px solid var(--gray-300);
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* User Selection Modal Styles */
    .users-selection {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        padding: 0.5rem;
    }



    /* Form Select Styling */
    .form-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        background-color: var(--white);
        color: var(--text-color);
        font-size: 0.875rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-select:hover {
        border-color: var(--gray-400);
    }

    /* Empty State */
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }

    .empty-icon {
        color: var(--gray-400);
        margin-bottom: 1.5rem;
    }

    .empty-state h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
    }

    .empty-state p {
        color: var(--gray-600);
        margin: 0 0 2rem 0;
        font-size: 1.125rem;
    }

    /* Minimalist Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        animation: fadeIn 0.3s ease;
        overflow: hidden;
    }

    .modal-content {
        background: var(--background-primary);
        margin: 2% auto;
        border-radius: 20px;
        width: 90%;
        max-width: 800px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--border-light);
        max-height: 92vh;
        overflow-y: auto;
        overflow-x: hidden;
        animation: slideInScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideInScale {
        from { 
            opacity: 0; 
            transform: translateY(30px) scale(0.95);
        }
        to { 
            opacity: 1; 
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2.5rem 3rem 1rem;
        border-bottom: none;
        background: transparent;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 300;
        color: var(--gray-800);
        letter-spacing: -0.02em;
    }

    .close-btn {
        background: transparent;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0.75rem;
        border-radius: 50%;
        transition: all 0.3s ease;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        background: var(--gray-100);
        color: var(--gray-600);
        transform: scale(1.1);
    }

    .close {
        color: var(--gray-400);
        font-size: 24px;
        font-weight: 300;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close:hover {
        color: var(--gray-600);
    }

    .modal-body {
        padding: 0 3rem 3rem;
    }

    /* Minimalist Tab Styles */
    .edit-project-tabs {
        margin-bottom: 3rem;
    }

    .tabs {
        display: flex;
        background: transparent;
        border-radius: 0;
        padding: 0;
        margin-bottom: 3rem;
        border-bottom: 1px solid var(--gray-200);
        position: relative;
    }

    .tab-btn {
        flex: 1;
        padding: 1.5rem 2rem;
        border: none;
        background: transparent;
        color: var(--gray-500);
        font-size: 0.9rem;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        border-radius: 0;
        position: relative;
        letter-spacing: 0.025em;
    }

    .tab-icon {
        width: 18px;
        height: 18px;
        transition: all 0.3s ease;
    }

    .tab-btn::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 2px;
        background: var(--primary-color);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tab-btn.active {
        background: transparent;
        color: var(--primary-color);
        box-shadow: none;
        border: none;
    }

    .tab-btn.active::after {
        width: 60%;
    }

    .tab-btn:hover:not(.active) {
        background: transparent;
        color: var(--gray-700);
    }

    .tab-btn:hover:not(.active)::after {
        width: 30%;
        background: var(--gray-300);
    }

    .tab-content {
        display: none;
        animation: fadeInUp 0.5s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeInUp {
        from { 
            opacity: 0; 
            transform: translateY(20px);
        }
        to { 
            opacity: 1; 
            transform: translateY(0);
        }
    }

    /* Minimalist Form Styles */
    .form-group {
        margin-bottom: 2rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.75rem;
        font-weight: 400;
        color: var(--gray-700);
        font-size: 0.875rem;
        letter-spacing: 0.025em;
        text-transform: uppercase;
        font-size: 0.8rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 1rem 0;
        border: none;
        border-bottom: 1px solid var(--gray-200);
        border-radius: 0;
        font-size: 1rem;
        background: transparent;
        transition: all 0.3s ease;
        font-family: inherit;
        color: var(--gray-800);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-bottom: 2px solid var(--primary-color);
        background: transparent;
        box-shadow: none;
        transform: translateY(-1px);
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
        color: var(--gray-400);
        font-weight: 300;
    }

    .form-group small {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: 300;
        font-style: italic;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--gray-200);
    }

    /* Minimalist Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 2rem;
        border: 1px solid transparent;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        text-align: center;
        letter-spacing: 0.025em;
        min-width: 120px;
        justify-content: center;
    }

    .btn-primary {
        background: var(--gray-900);
        color: var(--white);
        border-color: var(--gray-900);
    }

    .btn-primary:hover {
        background: var(--gray-800);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn-secondary {
        background: transparent;
        color: var(--gray-600);
        border-color: var(--gray-300);
    }

    .btn-secondary:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
        color: var(--gray-700);
    }

    /* Minimalist Client Type Selection */
    .client-type-section {
        margin-bottom: 3rem;
        padding: 0;
        background: transparent;
        border-radius: 0;
        border: none;
    }

    .client-type-section h3 {
        margin: 0 0 2rem 0;
        color: var(--gray-700);
        font-size: 1rem;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.8rem;
    }

    .client-type-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
    }

    .client-type-option {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 2rem 1.5rem;
        border: 1px solid var(--gray-200);
        border-radius: 0;
        cursor: pointer;
        transition: all 0.3s ease;
        background: transparent;
        position: relative;
    }

    .client-type-option:first-child {
        border-radius: 8px 0 0 8px;
        border-right: none;
    }

    .client-type-option:last-child {
        border-radius: 0 8px 8px 0;
    }

    .client-type-option:hover {
        border-color: var(--gray-300);
        background: var(--gray-50);
    }

    .client-type-option input[type="radio"]:checked ~ .option-content {
        color: var(--gray-800);
    }

    .client-type-option input[type="radio"]:checked {
        background: var(--gray-50);
        border-color: var(--gray-400);
    }

    .client-type-option input[type="radio"] {
        display: none;
    }

    .radio-custom {
        width: 16px;
        height: 16px;
        border: 1px solid var(--gray-300);
        border-radius: 50%;
        position: relative;
        flex-shrink: 0;
        margin-top: 4px;
        transition: all 0.3s ease;
        background: transparent;
    }

    .client-type-option input[type="radio"]:checked + .radio-custom {
        background: var(--primary-color);
        border-color: var(--primary-color);
        transform: scale(1.1);
    }

    .client-type-option input[type="radio"]:checked + .radio-custom::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 4px;
        height: 4px;
        background: #ffffff;
        border-radius: 50%;
    }

    .option-content h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 500;
        color: var(--gray-800);
        letter-spacing: -0.01em;
    }

    .option-content p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--gray-500);
        line-height: 1.5;
        font-weight: 300;
    }

    #new-client-fields,
    #existing-client-fields {
        margin-top: 2rem;
        padding: 0;
        background: transparent;
        border-radius: 0;
        border: none;
    }

    #existing-client-fields {
        background: transparent;
    }

    #existing-client-fields input[readonly] {
        background: transparent;
        color: var(--gray-500);
        border-bottom-color: var(--gray-200);
    }

    .duration-display {
        background: transparent;
        padding: 1rem 0;
        border-bottom: 1px solid var(--gray-200);
        color: var(--gray-700);
        font-weight: 400;
        margin-bottom: 0.75rem;
        border-radius: 0;
    }

    .help-text {
        color: var(--gray-500);
        font-size: 0.75rem;
        font-weight: 300;
        font-style: italic;
    }

    .duration-warning {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        margin: 0.75rem 0;
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: var(--radius);
        color: #92400e;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .duration-warning svg {
        color: #f59e0b;
        flex-shrink: 0;
    }

    /* Minimalist Tasks Section */
    .section-title {
        font-size: 1rem;
        font-weight: 400;
        color: var(--gray-700);
        margin: 3rem 0 2rem 0;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-200);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.8rem;
    }

    .add-task-section {
        text-align: center;
        margin: 2rem 0;
    }

    .add-task-btn {
        background: transparent;
        color: var(--gray-600);
        border: 1px solid var(--gray-300);
        padding: 1rem 2rem;
        border-radius: 50px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 400;
        transition: all 0.3s ease;
        letter-spacing: 0.025em;
    }

    .add-task-btn:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
        color: var(--gray-700);
        transform: translateY(-1px);
    }

    .existing-tasks {
        margin-bottom: 2rem;
    }

    .task-item {
        background: transparent;
        border-radius: 0;
        padding: 2rem 0;
        margin-bottom: 0;
        border: none;
        border-bottom: 1px solid var(--gray-200);
        transition: all 0.3s ease;
    }

    .task-item:hover {
        box-shadow: none;
        border-bottom-color: var(--gray-300);
        padding-left: 1rem;
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .task-info h4 {
        margin: 0 0 0.75rem 0;
        color: var(--gray-800);
        font-size: 1.125rem;
        font-weight: 400;
        letter-spacing: -0.01em;
    }

    .task-status,
    .task-development-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 400;
        margin-right: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: 1px solid;
    }

    .task-status.completed { 
        background: transparent; 
        color: var(--success); 
        border-color: var(--success);
    }
    .task-status.in_progress { 
        background: transparent; 
        color: var(--warning); 
        border-color: var(--warning);
    }
    .task-status.not_started { 
        background: transparent; 
        color: var(--gray-500); 
        border-color: var(--gray-300);
    }


    
    .task-development-status {
        background: transparent;
        color: var(--info);
        border-color: var(--info);
    }

    .task-actions {
        display: flex;
        gap: 0.5rem;
    }

    .task-edit-form {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 12px;
        padding: 2rem;
        margin: 2rem 0;
    }

    /* Minimalist Subtasks */
    .subtasks-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--gray-200);
    }

    .subtasks-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .subtasks-header h5 {
        margin: 0;
        color: var(--gray-600);
        font-size: 0.8rem;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .subtasks-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .subtask-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        background: transparent;
        border-radius: 0;
        font-size: 0.875rem;
        border: none;
        border-bottom: 1px solid var(--gray-100);
    }

    .subtask-item.completed {
        background: transparent;
        border-bottom-color: var(--success);
    }

    .subtask-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .subtask-title {
        color: var(--gray-700);
        font-weight: 400;
    }

    .subtask-status {
        color: var(--success);
        font-weight: 400;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .subtask-priority {
        font-size: 0.75rem;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        border: 1px solid;
    }

    .subtask-priority.low { 
        background: transparent; 
        color: var(--gray-500); 
        border-color: var(--gray-300);
    }
    .subtask-priority.medium { 
        background: transparent; 
        color: var(--warning); 
        border-color: var(--warning);
    }
    .subtask-priority.high { 
        background: transparent; 
        color: var(--danger); 
        border-color: var(--danger);
    }
    .subtask-priority.urgent { 
        background: var(--danger); 
        color: var(--white); 
        border-color: var(--danger);
    }

    .subtask-dates {
        color: var(--gray-600);
        font-size: 0.75rem;
        font-weight: 400;
        font-style: italic;
    }

    .subtask-edit-form {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 8px;
    }

    .subtask-edit-form .form-group {
        margin-bottom: 1rem;
    }

    .subtask-edit-form .form-actions {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }

    .date-validation-warning {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        margin: 0.75rem 0;
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: var(--radius);
        color: #92400e;
        font-size: 0.875rem;
        font-weight: 500;
        animation: fadeIn 0.3s ease;
    }

    .date-validation-warning svg {
        color: #f59e0b;
        flex-shrink: 0;
    }

    .date-validation-warning span {
        flex: 1;
    }

    .subtask-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Minimalist Checkbox Styles */
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 1rem;
        cursor: pointer;
        font-weight: 400;
        color: var(--gray-700);
        font-size: 0.875rem;
    }

    .checkbox-label input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin: 0;
        cursor: pointer;
        border: 1px solid var(--gray-300);
        border-radius: 3px;
    }

    .checkmark {
        width: 16px;
        height: 16px;
        border: 1px solid var(--gray-300);
        border-radius: 3px;
        position: relative;
        transition: all 0.3s ease;
        background: transparent;
    }

    .checkbox-label input[type="checkbox"]:checked + .checkmark {
        background: var(--gray-800);
        border-color: var(--gray-800);
    }

    .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--white);
        font-size: 10px;
        font-weight: bold;
    }

    /* Enhanced Dropdown Styles */
    select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        cursor: pointer;
    }

    select:focus {
        border-bottom: 2px solid var(--primary-color);
        background-color: var(--gray-50);
    }

    select option {
        background: var(--white);
        color: var(--text-color);
        padding: 0.5rem;
    }

    select option:hover {
        background: var(--gray-100);
    }

    /* Multi-select dropdown styling */
    select[multiple] {
        background-image: none;
        padding-right: 0.75rem;
        min-height: 120px;
    }

    select[multiple] option {
        padding: 0.5rem 0.75rem;
        margin: 0.125rem 0;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    select[multiple] option:checked {
        background: var(--primary-color);
        color: var(--white);
    }

    select[multiple] option:hover:not(:checked) {
        background: var(--gray-100);
    }

    /* Form validation styles */
    .form-group input:invalid,
    .form-group select:invalid {
        border-bottom-color: var(--danger);
    }

    .form-group input:valid,
    .form-group select:valid {
        border-bottom-color: var(--success);
    }

    /* Required field indicator */
    .form-group label[for*="required"]::after,
    .form-group label:contains("*")::after {
        content: " *";
        color: var(--danger);
        font-weight: bold;
    }

    /* Project Info Grid */
    .project-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius);
        border: 1px solid var(--gray-200);
    }

    .info-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .info-value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
    }

    /* Responsive Design for Minimalist Modal */
    @media (max-width: 768px) {
        .projects-dashboard {
            padding: 0.5rem;
        }
        
        .main-content {
            padding: 1rem;
        }

        .header {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .header-actions {
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .filters-section {
            flex-direction: column;
            gap: 1rem;
        }

        .search-box {
            max-width: 100%;
        }

        .projects-container {
            grid-template-columns: 1fr;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .client-type-options {
            grid-template-columns: 1fr;
        }

        .client-type-option:first-child {
            border-radius: 8px 8px 0 0;
            border-right: 1px solid var(--gray-200);
            border-bottom: none;
        }

        .client-type-option:last-child {
            border-radius: 0 0 8px 8px;
            border-top: none;
        }

        .modal-content {
            margin: 1rem auto;
            width: 95%;
            border-radius: 16px;
        }

        .modal-header {
            padding: 2rem 1.5rem 1rem;
        }

        .modal-body {
            padding: 0 1.5rem 2rem;
        }

        .project-actions {
            flex-direction: column;
        }

        .task-header {
            flex-direction: column;
            gap: 1rem;
        }

        .task-actions {
            width: 100%;
            justify-content: flex-end;
        }

        .tabs {
            flex-direction: column;
        }

        .tab-btn {
            border-bottom: 1px solid var(--gray-200);
            justify-content: flex-start;
            padding: 1rem 0;
        }

        .tab-btn::after {
            display: none;
        }

        .tab-btn.active {
            background: var(--gray-50);
            color: var(--primary-color);
        }

        /* Assigned Users Responsive Styles */
        .assigned-users-section {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }

        .assigned-users-list {
            gap: 0.5rem;
            justify-content: flex-start;
        }

        .user-badge {
            font-size: 0.7rem;
            padding: 0.375rem 0.75rem;
            max-width: none;
        }

        .btn-outline {
            align-self: flex-start;
            margin-top: 0.25rem;
        }

        .detail-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .detail-item .label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .detail-item .value {
            font-size: 0.875rem;
            color: var(--text-color);
        }
    }

    @media (max-width: 480px) {
        .projects-dashboard {
            padding: 0.25rem;
        }
        
        .header {
            padding: 1rem;
        }
        
        .welcome-text {
            font-size: 1.5rem;
        }

        /* Additional mobile optimizations */
        .project-card {
            padding: 1rem;
        }

        .project-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .status-indicator {
            align-self: flex-start;
        }

        .assigned-users-section {
            gap: 0.5rem;
        }

        .assigned-users-list {
            gap: 0.375rem;
        }

        .user-badge {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
        }

        .btn-outline {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }

        .project-actions {
            gap: 0.5rem;
        }

        .btn {
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem;
        }
    }
</style>

<script>
    let currentProjectId = null;
    let taskCounter = 1;

    // Tab functionality
    document.addEventListener('DOMContentLoaded', function() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                
                // Remove active class from all tabs and contents
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                this.classList.add('active');
                const targetContent = document.getElementById(targetTab);
                targetContent.classList.add('active');
            });
        });
    });

    // Modal functions
    function openAddProjectModal() {
        const modal = document.getElementById('addProjectModal');
        modal.style.display = 'block';
        
        // Reset to first tab
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        const firstTab = document.querySelector('[data-tab="basic-info"]');
        const firstContent = document.getElementById('basic-info');
        
        firstTab.classList.add('active');
        firstContent.classList.add('active');
        
        // Reset form and clear tasks
        document.getElementById('basicProjectForm').reset();
        document.getElementById('new-client-fields').style.display = 'block';
        document.getElementById('existing-client-fields').style.display = 'none';
        document.getElementById('project-tasks').innerHTML = '';
        taskCounter = 1;
        
        // Initialize the summary and warning
        updateSummary();
    }

    function closeAddProjectModal() {
        document.getElementById('addProjectModal').style.display = 'none';
    }

    function toggleClientType() {
        const newClientFields = document.getElementById('new-client-fields');
        const existingClientFields = document.getElementById('existing-client-fields');
        const newClientRadio = document.getElementById('new-client');
        const existingClientRadio = document.getElementById('existing-client');

        if (newClientRadio.checked) {
            newClientFields.style.display = 'block';
            existingClientFields.style.display = 'none';
            // Clear existing client form fields
            document.getElementById('existing_client_select').value = '';
            document.getElementById('existing_client_name').value = '';
            document.getElementById('existing_client_username').value = '';
            document.getElementById('existing_client_email').value = '';
        } else {
            newClientFields.style.display = 'none';
            existingClientFields.style.display = 'block';
            // Clear new client form fields
            document.getElementById('client_name').value = '';
            document.getElementById('client_username').value = '';
            document.getElementById('client_email').value = '';
        }
    }

    function fillExistingClientInfo() {
        const selectedOption = document.getElementById('existing_client_select').options[document.getElementById('existing_client_select').selectedIndex];
        
        if (selectedOption && selectedOption.value) {
            const clientName = selectedOption.dataset.name;
            const clientUsername = selectedOption.dataset.username;
            const clientEmail = selectedOption.dataset.email;
            
            document.getElementById('existing_client_name').value = clientName;
            document.getElementById('existing_client_username').value = clientUsername;
            document.getElementById('existing_client_email').value = clientEmail;
            
            // Also update the hidden fields that the form will submit
            document.getElementById('client_name').value = clientName;
            document.getElementById('client_username').value = clientUsername;
            document.getElementById('client_email').value = clientEmail;
        }
    }

    // Project form submission function
    function submitProjectForm() {
        const form = document.getElementById('basicProjectForm');
        
        // Validate required fields
        const projectName = document.getElementById('project_name').value.trim();
        const isExistingClient = document.getElementById('existing-client').checked;
        
        if (!projectName) {
            alert('Please enter a project name.');
            document.getElementById('project_name').focus();
            return;
        }
        
        if (isExistingClient) {
            const existingClientId = document.getElementById('existing_client_select').value;
            if (!existingClientId) {
                alert('Please select an existing client.');
                document.getElementById('existing_client_select').focus();
                return;
            }
            
            // For existing clients, populate the main form fields from the existing client data
            const selectedOption = document.getElementById('existing_client_select').options[document.getElementById('existing_client_select').selectedIndex];
            if (selectedOption && selectedOption.value) {
                const clientName = selectedOption.dataset.name;
                const clientUsername = selectedOption.dataset.username;
                const clientEmail = selectedOption.dataset.email;
                
                // Create hidden inputs for the main form
                const clientNameInput = document.createElement('input');
                clientNameInput.type = 'hidden';
                clientNameInput.name = 'client';
                clientNameInput.value = clientName;
                form.appendChild(clientNameInput);
                
                const clientUsernameInput = document.createElement('input');
                clientUsernameInput.type = 'hidden';
                clientUsernameInput.name = 'client_username';
                clientUsernameInput.value = clientUsername;
                form.appendChild(clientUsernameInput);
                
                const clientEmailInput = document.createElement('input');
                clientEmailInput.type = 'hidden';
                clientEmailInput.name = 'client_email';
                clientEmailInput.value = clientEmail;
                form.appendChild(clientEmailInput);
            }
        } else {
            const clientName = document.getElementById('client_name').value.trim();
            const clientEmail = document.getElementById('client_email').value.trim();
            
            if (!clientName || !clientEmail) {
                alert('Please fill in all required client information.');
                if (!clientName) document.getElementById('client_name').focus();
                else if (!clientEmail) document.getElementById('client_email').focus();
                return;
            }
        }
        
        // Check if any tasks have dates set
        const tasks = document.querySelectorAll('.task-item');
        let hasTaskWithDates = false;
        
        tasks.forEach(task => {
            const editForm = task.querySelector('.task-edit-form');
            if (editForm) {
                const startDate = editForm.querySelector('input[name^="task_start_"]')?.value;
                const endDate = editForm.querySelector('input[name^="task_end_"]')?.value;
                if (startDate && endDate) {
                    hasTaskWithDates = true;
                }
            }
        });
        
        if (tasks.length > 0 && !hasTaskWithDates) {
            const warningMessage = 'Warning: You have added tasks but none have start and end dates set. ' +
                                 'This means the project will not have start and end dates, which may affect ' +
                                 'project duration calculations and reporting.\n\n' +
                                 'Do you want to continue anyway?';
            
            if (!confirm(warningMessage)) {
                return;
            }
        }
        
        // Show loading state
        const submitBtn = document.querySelector('#addProjectModal .btn-primary');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Creating Project...';
        submitBtn.disabled = true;
        
        // Collect task data and add to form
        let taskIndex = 1;
        
        tasks.forEach(task => {
            const taskTitle = task.querySelector('.task-info h4').textContent.trim();
            const taskStatus = task.querySelector('.task-status').textContent.trim();
            const taskDevelopmentStatus = task.querySelector('.task-development-status')?.textContent.trim() || 'original_quoted';
            
            // Create hidden inputs for task data
            const titleInput = document.createElement('input');
            titleInput.type = 'hidden';
            titleInput.name = `task_title_${taskIndex}`;
            titleInput.value = taskTitle;
            form.appendChild(titleInput);
            
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = `task_status_${taskIndex}`;
            statusInput.value = getStatusValue(taskStatus);
            form.appendChild(statusInput);
            
            const developmentStatusInput = document.createElement('input');
            developmentStatusInput.type = 'hidden';
            developmentStatusInput.name = `task_development_status_${taskIndex}`;
            developmentStatusInput.value = getDevelopmentStatusValue(taskDevelopmentStatus);
            form.appendChild(developmentStatusInput);
            
            // Get task dates if available
            const editForm = task.querySelector('.task-edit-form');
            if (editForm) {
                const startDate = editForm.querySelector('input[name^="task_start_"]')?.value;
                const endDate = editForm.querySelector('input[name^="task_end_"]')?.value;
                const description = editForm.querySelector('textarea[name^="task_description_"]')?.value || '';
                const assignedToSelect = editForm.querySelector('select[name^="task_assigned_to_"]');
                const assignedTo = assignedToSelect ? Array.from(assignedToSelect.selectedOptions).map(option => option.value).join(',') : '';
                
                if (startDate) {
                    const startInput = document.createElement('input');
                    startInput.type = 'hidden';
                    startInput.name = `task_start_${taskIndex}`;
                    startInput.value = startDate;
                    form.appendChild(startInput);
                }
                
                if (endDate) {
                    const endInput = document.createElement('input');
                    endInput.type = 'hidden';
                    endInput.name = `task_end_${taskIndex}`;
                    endInput.value = endDate;
                    form.appendChild(endInput);
                }
                
                if (description) {
                    const descInput = document.createElement('input');
                    descInput.type = 'hidden';
                    descInput.name = `task_description_${taskIndex}`;
                    descInput.value = description;
                    form.appendChild(descInput);
                }
                
                if (assignedTo) {
                    // Handle multiple assigned users
                    const assignedUsers = assignedTo.split(',').map(id => id.trim()).filter(id => id);
                    assignedUsers.forEach(userId => {
                        const assignInput = document.createElement('input');
                        assignInput.type = 'hidden';
                        assignInput.name = `task_assigned_to_${taskIndex}`;
                        assignInput.value = userId;
                        form.appendChild(assignInput);
                    });
                }
            }
            
            // Collect subtasks
            const subtasks = task.querySelectorAll('.subtask-item');
            let subtaskIndex = 1;
            
            subtasks.forEach(subtask => {
                const subtaskTitle = subtask.querySelector('.subtask-title').textContent.trim();
                const subtaskStatus = subtask.querySelector('.subtask-status').textContent.trim();
                const subtaskPriority = subtask.querySelector('.subtask-priority').textContent.trim();
                
                const subtaskTitleInput = document.createElement('input');
                subtaskTitleInput.type = 'hidden';
                subtaskTitleInput.name = `subtask_title_${taskIndex}_${subtaskIndex}`;
                subtaskTitleInput.value = subtaskTitle;
                form.appendChild(subtaskTitleInput);
                
                const subtaskStatusInput = document.createElement('input');
                subtaskStatusInput.type = 'hidden';
                subtaskStatusInput.name = `subtask_status_${taskIndex}_${subtaskIndex}`;
                subtaskStatusInput.value = getSubtaskStatusValue(subtaskStatus);
                form.appendChild(subtaskStatusInput);
                
                const subtaskPriorityInput = document.createElement('input');
                subtaskPriorityInput.type = 'hidden';
                subtaskPriorityInput.name = `subtask_priority_${taskIndex}_${subtaskIndex}`;
                subtaskPriorityInput.value = getSubtaskPriorityValue(subtaskPriority);
                form.appendChild(subtaskPriorityInput);
                
                // Get subtask dates if available
                const subtaskDates = subtask.querySelector('.subtask-dates');
                if (subtaskDates) {
                    const dateText = subtaskDates.textContent;
                    if (dateText.includes(' to ')) {
                        const [startDate, endDate] = dateText.split(' to ');
                        const startInput = document.createElement('input');
                        startInput.type = 'hidden';
                        startInput.name = `subtask_start_${taskIndex}_${subtaskIndex}`;
                        startInput.value = startDate;
                        form.appendChild(startInput);
                        
                        const endInput = document.createElement('input');
                        endInput.type = 'hidden';
                        endInput.name = `subtask_end_${taskIndex}_${subtaskIndex}`;
                        endInput.value = endDate;
                        form.appendChild(endInput);
                    } else if (dateText.startsWith('From ')) {
                        const startDate = dateText.replace('From ', '');
                        const startInput = document.createElement('input');
                        startInput.type = 'hidden';
                        startInput.name = `subtask_start_${taskIndex}_${subtaskIndex}`;
                        startInput.value = startDate;
                        form.appendChild(startInput);
                    } else if (dateText.startsWith('Until ')) {
                        const endDate = dateText.replace('Until ', '');
                        const endInput = document.createElement('input');
                        endInput.type = 'hidden';
                        endInput.name = `subtask_end_${taskIndex}_${subtaskIndex}`;
                        endInput.value = endDate;
                        form.appendChild(endInput);
                    }
                }
                
                // Add subtask description (empty for now, can be enhanced later)
                const subtaskDescInput = document.createElement('input');
                subtaskDescInput.type = 'hidden';
                subtaskDescInput.name = `subtask_description_${taskIndex}_${subtaskIndex}`;
                subtaskDescInput.value = '';
                form.appendChild(subtaskDescInput);
                
                subtaskIndex++;
            });
            
            taskIndex++;
        });
        
        // Submit the form
        form.submit();
    }

    // Utility functions for form submission
    function getStatusValue(statusText) {
        const statusMap = {
            'Not Started': 'not_started',
            'In Progress': 'in_progress',
            'Completed': 'completed'
        };
        return statusMap[statusText] || 'not_started';
    }

    function getDevelopmentStatusValue(developmentStatusText) {
        const developmentStatusMap = {
            'Original/Quoted Development': 'original_quoted',
            'New Development': 'new_development',
            'New Development – QMS must be involved': 'new_development_qms',
            'New Development – QMS Change': 'new_development_qms_change',
            'New Development/Quoted Development': 'new_quoted_development',
            'Ongoing Development': 'ongoing_development'
        };
        return developmentStatusMap[developmentStatusText] || 'original_quoted';
    }

    function getSubtaskStatusValue(statusText) {
        const statusMap = {
            'not_started': 'not_started',
            'in_progress': 'in_progress',
            'completed': 'completed'
        };
        return statusMap[statusText] || 'not_started';
    }

    function getSubtaskPriorityValue(priorityText) {
        const priorityMap = {
            'low': 'low',
            'medium': 'medium',
            'high': 'high',
            'urgent': 'urgent'
        };
        return priorityMap[priorityText] || 'medium';
    }

    // Date validation functions
    function validateSubtaskDates(taskId, subtaskId) {
        const startDateInput = document.getElementById(`subtask_edit_start_${taskId}_${subtaskId}`);
        const endDateInput = document.getElementById(`subtask_edit_end_${taskId}_${subtaskId}`);
        const warningDiv = document.getElementById(`date-validation-${taskId}_${subtaskId}`);
        
        if (!startDateInput || !endDateInput) return;
        
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (startDate && endDate) {
            // Get the parent task's date range
            const taskItem = startDateInput.closest('.task-item');
            const taskStartInput = taskItem.querySelector('input[name^="task_start_"]');
            const taskEndInput = taskItem.querySelector('input[name^="task_end_"]');
            
            if (taskStartInput && taskEndInput && taskStartInput.value && taskEndInput.value) {
                const taskStart = new Date(taskStartInput.value);
                const taskEnd = new Date(taskEndInput.value);
                const subtaskStart = new Date(startDate);
                const subtaskEnd = new Date(endDate);
                
                // Check if subtask dates are within task range
                if (subtaskStart < taskStart || subtaskEnd > taskEnd) {
                    warningDiv.style.display = 'flex';
                    startDateInput.style.borderBottomColor = 'var(--danger)';
                    endDateInput.style.borderBottomColor = 'var(--danger)';
                } else {
                    warningDiv.style.display = 'none';
                    startDateInput.style.borderBottomColor = 'var(--gray-200)';
                    endDateInput.style.borderBottomColor = 'var(--gray-200)';
                }
            }
        }
    }

    function validateNewSubtaskDates() {
        const startDateInput = document.getElementById('subtask_start_date');
        const endDateInput = document.getElementById('subtask_end_date');
        const warningDiv = document.getElementById('new-subtask-date-validation');
        
        if (!startDateInput || !endDateInput) return;
        
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (startDate && endDate) {
            // Get the current task's date range from the modal context
            // This will be validated when the subtask is actually added to a task
            const subtaskStart = new Date(startDate);
            const subtaskEnd = new Date(endDate);
            
            if (subtaskStart > subtaskEnd) {
                warningDiv.style.display = 'flex';
                warningDiv.querySelector('span').textContent = 'Warning: Start date cannot be after end date.';
                startDateInput.style.borderBottomColor = 'var(--danger)';
                endDateInput.style.borderBottomColor = 'var(--danger)';
            } else {
                warningDiv.style.display = 'none';
                startDateInput.style.borderBottomColor = 'var(--gray-200)';
                endDateInput.style.borderBottomColor = 'var(--gray-200)';
            }
        }
    }

    function validateTaskDates(taskId) {
        const startDateInput = document.getElementById(`task_start_${taskId}`);
        const endDateInput = document.getElementById(`task_end_${taskId}`);
        const warningDiv = document.getElementById(`task-date-validation-${taskId}`);
        
        if (!startDateInput || !endDateInput) return;
        
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (startDate && endDate) {
            const taskStart = new Date(startDate);
            const taskEnd = new Date(endDate);
            
            if (taskStart > taskEnd) {
                warningDiv.style.display = 'flex';
                startDateInput.style.borderBottomColor = 'var(--danger)';
                endDateInput.style.borderBottomColor = 'var(--danger)';
            } else {
                warningDiv.style.display = 'none';
                startDateInput.style.borderBottomColor = 'var(--gray-200)';
                endDateInput.style.borderBottomColor = 'var(--gray-200)';
            }
        }
    }

    function populateUserOptions(selectElement) {
        // Get all users from the page context (from the existing select element)
        const existingSelect = document.getElementById('assigned_users');
        if (existingSelect) {
            const options = Array.from(existingSelect.options);
            options.forEach(option => {
                const newOption = document.createElement('option');
                newOption.value = option.value;
                newOption.textContent = option.textContent;
                selectElement.appendChild(newOption);
            });
        }
    }

    // Task management functions
    function openAddTaskModal() {
        document.getElementById('addTaskModal').style.display = 'block';
        document.getElementById('addTaskForm').reset();
    }

    function closeAddTaskModal() {
        document.getElementById('addTaskModal').style.display = 'none';
    }

    function openAddSubtaskModal(taskId) {
        document.getElementById('addSubtaskModal').style.display = 'block';
        document.getElementById('addSubtaskForm').reset();
        document.getElementById('subtask_task_id').value = taskId;
    }

    function closeAddSubtaskModal() {
        document.getElementById('addSubtaskModal').style.display = 'none';
    }

    // Add task from modal
    function addTaskFromModal() {
        const form = document.getElementById('addTaskForm');
        const formData = new FormData(form);
        
        // Create task item
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        taskItem.innerHTML = `
            <div class="task-header">
                <div class="task-info">
                    <h4>${formData.get('title')}</h4>
                    <span class="task-status ${formData.get('status')}">${getStatusDisplay(formData.get('status'))}</span>
                    <span class="task-development-status">${getDevelopmentStatusDisplay(formData.get('development_status'))}</span>
                </div>
                <div class="task-actions">
                    <button type="button" class="btn btn-sm btn-info" onclick="toggleEditTask(${taskCounter})">Edit</button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteTask(${taskCounter})">Delete</button>
                </div>
            </div>
            
            <!-- Task Edit Form (Hidden by default) -->
            <div class="task-edit-form" id="task-edit-${taskCounter}" style="display: none;">
                <form method="POST">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="task_title_${taskCounter}">Task Title *</label>
                        <input type="text" id="task_title_${taskCounter}" name="task_title_${taskCounter}" value="${formData.get('title')}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="task_description_${taskCounter}">Description</label>
                        <textarea id="task_description_${taskCounter}" name="task_description_${taskCounter}" rows="3">${formData.get('description')}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="task_status_${taskCounter}">Status *</label>
                        <select id="task_status_${taskCounter}" name="task_status_${taskCounter}" required>
                            <option value="not_started" ${formData.get('status') === 'not_started' ? 'selected' : ''}>Not Started</option>
                            <option value="in_progress" ${formData.get('status') === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${formData.get('status') === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="task_development_status_${taskCounter}">Development Status *</label>
                        <select id="task_development_status_${taskCounter}" name="task_development_status_${taskCounter}" required>
                            <option value="original_quoted" ${formData.get('development_status') === 'original_quoted' ? 'selected' : ''}>Original/Quoted Development</option>
                            <option value="new_development" ${formData.get('development_status') === 'new_development' ? 'selected' : ''}>New Development</option>
                            <option value="new_development_qms" ${formData.get('development_status') === 'new_development_qms' ? 'selected' : ''}>New Development – QMS must be involved</option>
                            <option value="new_development_qms_change" ${formData.get('development_status') === 'new_development_qms_change' ? 'selected' : ''}>New Development – QMS Change</option>
                            <option value="new_quoted_development" ${formData.get('development_status') === 'new_quoted_development' ? 'selected' : ''}>New Development/Quoted Development</option>
                            <option value="ongoing_development" ${formData.get('development_status') === 'ongoing_development' ? 'selected' : ''}>Ongoing Development</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task_start_${taskCounter}">Start Date</label>
                            <input type="date" id="task_start_${taskCounter}" name="task_start_${taskCounter}" value="${formData.get('start_date')}" onchange="validateTaskDates(${taskCounter})">
                        </div>
                        
                        <div class="form-group">
                            <label for="task_end_${taskCounter}">End Date</label>
                            <input type="date" id="task_end_${taskCounter}" name="task_end_${taskCounter}" value="${formData.get('end_date')}" onchange="validateTaskDates(${taskCounter})">
                        </div>
                    </div>
                    
                    <div class="date-validation-warning" id="task-date-validation-${taskCounter}" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span>Warning: End date cannot be before start date.</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="task_assigned_to_${taskCounter}">Assigned To</label>
                        <select id="task_assigned_to_${taskCounter}" name="task_assigned_to_${taskCounter}" multiple>
                            <!-- User options will be populated dynamically -->
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple users</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditTask(${taskCounter})">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveTaskEdit(${taskCounter})">Save Task</button>
                    </div>
                </form>
            </div>
            
            <!-- Subtasks Section -->
            <div class="subtasks-section">
                <div class="subtasks-header">
                    <h5>Subtasks:</h5>
                    <button type="button" class="btn btn-xs btn-success" onclick="openAddSubtaskModal(${taskCounter})">+ Add Subtask</button>
                </div>
                <div class="subtasks-list" id="subtasks-${taskCounter}">
                    <!-- Subtasks will be added here -->
                </div>
            </div>
        `;
        
        document.getElementById('project-tasks').appendChild(taskItem);
        
        // Populate user options for the newly created task
        const userSelect = document.getElementById(`task_assigned_to_${taskCounter - 1}`);
        if (userSelect) {
            populateUserOptions(userSelect);
        }
        
        taskCounter++;
        updateSummary();
        closeAddTaskModal();
    }

    // Add subtask from modal
    function addSubtaskFromModal() {
        const form = document.getElementById('addSubtaskForm');
        const formData = new FormData(form);
        const taskId = formData.get('task_id');
        
        const startDate = formData.get('start_date');
        const endDate = formData.get('end_date');
        const priority = formData.get('priority');
        const status = formData.get('status');
        
        // Validate dates if both are provided
        if (startDate && endDate) {
            const subtaskStart = new Date(startDate);
            const subtaskEnd = new Date(endDate);
            
            if (subtaskStart > subtaskEnd) {
                alert('Start date cannot be after end date. Please adjust the dates.');
                return;
            }
        }
        
        const subtaskItem = document.createElement('div');
        subtaskItem.className = 'subtask-item';
        if (status === 'completed') {
            subtaskItem.classList.add('completed');
        }
        
        let dateInfo = '';
        if (startDate && endDate) {
            dateInfo = `<span class="subtask-dates">${startDate} to ${endDate}</span>`;
        } else if (startDate) {
            dateInfo = `<span class="subtask-dates">From ${startDate}</span>`;
        } else if (endDate) {
            dateInfo = `<span class="subtask-dates">Until ${endDate}</span>`;
        }
        
        subtaskItem.innerHTML = `
            <div class="subtask-content">
                <span class="subtask-title">${formData.get('title')}</span>
                <span class="subtask-priority ${priority}">${priority}</span>
                <span class="subtask-status ${status}">${status}</span>
                ${dateInfo}
            </div>
            <div class="subtask-actions">
                <button type="button" class="btn btn-xs btn-info" onclick="toggleEditSubtask(${taskId}, ${Date.now()})">Edit</button>
                <button type="button" class="btn btn-xs btn-danger" onclick="deleteSubtask(this)">Delete</button>
            </div>
        `;
        
        document.getElementById(`subtasks-${taskId}`).appendChild(subtaskItem);
        updateSummary();
        closeAddSubtaskModal();
    }

    // Task management functions
    function toggleEditTask(taskId) {
        const editForm = document.getElementById(`task-edit-${taskId}`);
        const editBtn = event.target;
        
        if (editForm.style.display === 'none') {
            editForm.style.display = 'block';
            editBtn.textContent = 'Close';
            editBtn.classList.remove('btn-info');
            editBtn.classList.add('btn-secondary');
        } else {
            editForm.style.display = 'none';
            editBtn.textContent = 'Edit';
            editBtn.classList.remove('btn-secondary');
            editBtn.classList.add('btn-info');
        }
    }

    function closeEditTask(taskId) {
        const editForm = document.getElementById(`task-edit-${taskId}`);
        const editBtn = editForm.previousElementSibling.querySelector('.btn-info');
        
        editForm.style.display = 'none';
                    editBtn.textContent = 'Edit';
        editBtn.classList.remove('btn-secondary');
        editBtn.classList.add('btn-info');
    }

    function saveTaskEdit(taskId) {
        const editForm = document.getElementById(`task-edit-${taskId}`);
        const taskTitle = editForm.querySelector(`#task_title_${taskId}`).value;
        const taskStatus = editForm.querySelector(`#task_status_${taskId}`).value;
        const taskDevelopmentStatus = editForm.querySelector(`#task_development_status_${taskId}`).value;
        
        if (taskTitle.trim()) {
            const taskInfo = editForm.closest('.task-item').querySelector('.task-info');
            taskInfo.querySelector('h4').textContent = taskTitle;
            taskInfo.querySelector('.task-status').textContent = getStatusDisplay(taskStatus);
            taskInfo.querySelector('.task-development-status').textContent = getDevelopmentStatusDisplay(taskDevelopmentStatus);
            
            // Update status and development status classes
            const statusSpan = taskInfo.querySelector('.task-status');
            const developmentStatusSpan = taskInfo.querySelector('.task-development-status');
            
            statusSpan.className = `task-status ${taskStatus}`;
            developmentStatusSpan.className = `task-development-status`;
            
            closeEditTask(taskId);
            updateSummary();
        } else {
            alert('Task title cannot be empty!');
        }
    }

    function toggleEditSubtask(taskId, subtaskId) {
        const subtaskItem = event.target.closest('.subtask-item');
        const editForm = subtaskItem.querySelector('.subtask-edit-form');
        const editBtn = event.target;
        
        if (!editForm) {
            // Create edit form if it doesn't exist
            const subtaskTitle = subtaskItem.querySelector('.subtask-title').textContent.trim();
            const subtaskPriority = subtaskItem.querySelector('.subtask-priority').textContent.trim();
            const subtaskStatus = subtaskItem.querySelector('.subtask-status').textContent.trim();
            
            // Get dates from the subtask-dates element if it exists
            let startDate = '';
            let endDate = '';
            const subtaskDates = subtaskItem.querySelector('.subtask-dates');
            if (subtaskDates) {
                const dateText = subtaskDates.textContent;
                if (dateText.includes(' to ')) {
                    [startDate, endDate] = dateText.split(' to ');
                } else if (dateText.startsWith('From ')) {
                    startDate = dateText.replace('From ', '');
                } else if (dateText.startsWith('Until ')) {
                    endDate = dateText.replace('Until ', '');
                }
            }
            
            const editFormHtml = `
                <div class="subtask-edit-form">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="subtask_edit_title_${taskId}_${subtaskId}">Subtask Title *</label>
                            <input type="text" id="subtask_edit_title_${taskId}_${subtaskId}" name="subtask_edit_title_${taskId}_${subtaskId}" value="${subtaskTitle}" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subtask_edit_start_${taskId}_${subtaskId}">Start Date</label>
                                <input type="date" id="subtask_edit_start_${taskId}_${subtaskId}" name="subtask_edit_start_${taskId}_${subtaskId}" value="${startDate}" onchange="validateSubtaskDates(${taskId}, ${subtaskId})">
                            </div>
                            
                            <div class="form-group">
                                <label for="subtask_edit_end_${taskId}_${subtaskId}">End Date</label>
                                <input type="date" id="subtask_edit_end_${taskId}_${subtaskId}" name="subtask_edit_end_${taskId}_${subtaskId}" value="${endDate}" onchange="validateSubtaskDates(${taskId}, ${subtaskId})">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subtask_edit_priority_${taskId}_${subtaskId}">Priority</label>
                                <select id="subtask_edit_priority_${taskId}_${subtaskId}" name="subtask_edit_priority_${taskId}_${subtaskId}">
                                    <option value="low" ${subtaskPriority === 'low' ? 'selected' : ''}>Low</option>
                                    <option value="medium" ${subtaskPriority === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="high" ${subtaskPriority === 'high' ? 'selected' : ''}>High</option>
                                    <option value="urgent" ${subtaskPriority === 'urgent' ? 'selected' : ''}>Urgent</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="subtask_edit_status_${taskId}_${subtaskId}">Status</label>
                                <select id="subtask_edit_status_${taskId}_${subtaskId}" name="subtask_edit_status_${taskId}_${subtaskId}">
                                    <option value="not_started" ${subtaskStatus === 'not_started' ? 'selected' : ''}>Not Started</option>
                                    <option value="in_progress" ${subtaskStatus === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${subtaskStatus === 'completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="date-validation-warning" id="date-validation-${taskId}_${subtaskId}" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <span>Warning: Subtask dates cannot exceed the parent task's date range.</span>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeEditSubtask(${taskId}, ${subtaskId})">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveSubtaskEdit(${taskId}, ${subtaskId})">Save Subtask</button>
                        </div>
                    </form>
                </div>
            `;
            
            subtaskItem.insertAdjacentHTML('beforeend', editFormHtml);
            editBtn.textContent = 'Close';
            editBtn.classList.remove('btn-info');
            editBtn.classList.add('btn-secondary');
        } else {
            // Toggle existing form
            if (editForm.style.display === 'none') {
                editForm.style.display = 'block';
                editBtn.textContent = 'Close';
                editBtn.classList.remove('btn-info');
                editBtn.classList.add('btn-secondary');
            } else {
                editForm.style.display = 'none';
                editBtn.textContent = 'Edit';
                editBtn.classList.remove('btn-secondary');
                editBtn.classList.add('btn-info');
            }
        }
    }

    function closeEditSubtask(taskId, subtaskId) {
        const subtaskItem = event.target.closest('.subtask-item');
        const editForm = subtaskItem.querySelector('.subtask-edit-form');
        const editBtn = subtaskItem.querySelector('.btn-info, .btn-secondary');
        
        if (editForm) {
            editForm.remove();
        }
        
        if (editBtn) {
            editBtn.textContent = 'Edit';
            editBtn.classList.remove('btn-secondary');
            editBtn.classList.add('btn-info');
        }
    }

    function saveSubtaskEdit(taskId, subtaskId) {
        const subtaskItem = event.target.closest('.subtask-item');
        const editForm = subtaskItem.querySelector('.subtask-edit-form');
        
        if (!editForm) return;
        
        const newTitle = editForm.querySelector(`#subtask_edit_title_${taskId}_${subtaskId}`).value.trim();
        const newPriority = editForm.querySelector(`#subtask_edit_priority_${taskId}_${subtaskId}`).value;
        const newStatus = editForm.querySelector(`#subtask_edit_status_${taskId}_${subtaskId}`).value;
        const newStartDate = editForm.querySelector(`#subtask_edit_start_${taskId}_${subtaskId}`).value;
        const newEndDate = editForm.querySelector(`#subtask_edit_end_${taskId}_${subtaskId}`).value;
        
        if (!newTitle) {
            alert('Subtask title cannot be empty!');
            return;
        }
        
        // Validate dates against parent task
        if (newStartDate && newEndDate) {
            const taskItem = subtaskItem.closest('.task-item');
            const taskStartInput = taskItem.querySelector('input[name^="task_start_"]');
            const taskEndInput = taskItem.querySelector('input[name^="task_end_"]');
            
            if (taskStartInput && taskEndInput && taskStartInput.value && taskEndInput.value) {
                const taskStart = new Date(taskStartInput.value);
                const taskEnd = new Date(taskEndInput.value);
                const subtaskStart = new Date(newStartDate);
                const subtaskEnd = new Date(newEndDate);
                
                if (subtaskStart < taskStart || subtaskEnd > taskEnd) {
                    alert('Cannot save: Subtask dates exceed the parent task\'s date range. Please adjust the dates.');
                    return;
                }
            }
        }
        
        // Update the subtask display
        subtaskItem.querySelector('.subtask-title').textContent = newTitle;
        
        // Update priority
        const prioritySpan = subtaskItem.querySelector('.subtask-priority');
        prioritySpan.textContent = newPriority;
        prioritySpan.className = `subtask-priority ${newPriority}`;
        
        // Update status
        const statusSpan = subtaskItem.querySelector('.subtask-status');
        statusSpan.textContent = newStatus;
        statusSpan.className = `subtask-status ${newStatus}`;
        
        // Update completion class
        if (newStatus === 'completed') {
            subtaskItem.classList.add('completed');
        } else {
            subtaskItem.classList.remove('completed');
        }
        
        // Update dates
        let dateInfo = '';
        if (newStartDate && newEndDate) {
            dateInfo = `<span class="subtask-dates">${newStartDate} to ${newEndDate}</span>`;
        } else if (newStartDate) {
            dateInfo = `<span class="subtask-dates">From ${newStartDate}</span>`;
        } else if (newEndDate) {
            dateInfo = `<span class="subtask-dates">Until ${newEndDate}</span>`;
        }
        
        // Remove existing dates and add new ones
        const existingDates = subtaskItem.querySelector('.subtask-dates');
        if (existingDates) {
            existingDates.remove();
        }
        
        if (dateInfo) {
            const datesSpan = subtaskItem.querySelector('.subtask-content');
            datesSpan.insertAdjacentHTML('beforeend', dateInfo);
        }
        
        // Close the edit form
        closeEditSubtask(taskId, subtaskId);
    }

    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task?')) {
            document.querySelector(`#task-edit-${taskId}`).closest('.task-item').remove();
            updateSummary();
        }
    }

    function deleteSubtask(button) {
        if (confirm('Are you sure you want to delete this subtask?')) {
            button.closest('.subtask-item').remove();
            updateSummary();
        }
    }

    // Utility functions
    function getStatusDisplay(status) {
        const statusMap = {
            'not_started': 'Not Started',
            'in_progress': 'In Progress',
            'completed': 'Completed'
        };
        return statusMap[status] || status;
    }

    function getDevelopmentStatusDisplay(developmentStatus) {
        const developmentStatusMap = {
            'original_quoted': 'Original/Quoted Development',
            'new_development': 'New Development',
            'new_development_qms': 'New Development – QMS must be involved',
            'new_development_qms_change': 'New Development – QMS Change',
            'new_quoted_development': 'New Development/Quoted Development',
            'ongoing_development': 'Ongoing Development'
        };
        return developmentStatusMap[developmentStatus] || developmentStatus;
    }

    function updateSummary() {
        const tasks = document.querySelectorAll('.task-item');
        const subtasks = document.querySelectorAll('.subtask-item');
        
        // Update project duration display
        const startDateInputs = document.querySelectorAll('input[name^="task_start_"]');
        const endDateInputs = document.querySelectorAll('input[name^="task_end_"]');
        let earliestStart = null;
        let latestEnd = null;
        let hasTaskWithDates = false;
        
        startDateInputs.forEach((input, index) => {
            if (input.value) {
                const startDate = new Date(input.value);
                const endDate = new Date(endDateInputs[index].value);
                
                if (endDateInputs[index] && endDateInputs[index].value) {
                    hasTaskWithDates = true;
                    
                    if (!earliestStart || startDate < earliestStart) {
                        earliestStart = startDate;
                    }
                    if (!latestEnd || endDate > latestEnd) {
                        latestEnd = endDate;
                    }
                }
            }
        });
        
        const projectDurationDisplay = document.getElementById('project-duration-display');
        const durationWarning = document.getElementById('duration-warning');
        
        if (earliestStart && latestEnd) {
            const duration = Math.ceil((latestEnd - earliestStart) / (1000 * 60 * 60 * 24));
            projectDurationDisplay.textContent = `${duration} days (${earliestStart.toLocaleDateString()} to ${latestEnd.toLocaleDateString()})`;
            durationWarning.style.display = 'none';
        } else {
            projectDurationDisplay.textContent = 'Not set (add tasks with dates)';
            
            // Show warning if there are tasks but no dates
            if (tasks.length > 0 && !hasTaskWithDates) {
                durationWarning.style.display = 'flex';
            } else {
                durationWarning.style.display = 'none';
            }
        }
    }

    function viewProjectDetails(projectId) {
        currentProjectId = projectId;
        // Fetch project details
        fetch(`/projects/${projectId}/details/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('detail-project-name').textContent = data.name;
                document.getElementById('detail-client').textContent = data.client;
                document.getElementById('detail-email').textContent = data.client_email;
                document.getElementById('detail-weeks').textContent = data.duration;
                document.getElementById('detail-status').textContent = data.status_display;
                document.getElementById('detail-created').textContent = new Date(data.created_at).toLocaleDateString();
                
                document.getElementById('projectDetailsTitle').textContent = data.name;
                document.getElementById('projectDetailsModal').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading project details');
            });
    }

    function closeProjectDetailsModal() {
        document.getElementById('projectDetailsModal').style.display = 'none';
        currentProjectId = null;
    }

    function editProject(projectId) {
        window.location.href = `/projects/edit/${projectId}/`;
    }

    function deleteProject(projectId) {
        if (confirm('Are you sure you want to delete this project?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/projects/delete/${projectId}/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function sendProjectReport(projectId) {
        // Get project information from the DOM
        const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
        if (!projectCard) {
            alert('Project information not found. Please refresh the page and try again.');
            return;
        }
        
        const projectName = projectCard.dataset.name;
        const clientEmail = projectCard.dataset.clientEmail;
        const clientUsername = projectCard.dataset.clientUsername;
        
        if (!clientEmail) {
            alert('This project does not have a client email associated with it. Please update the project information first.');
            return;
        }
        
        if (confirm(`Send a report for project "${projectName}" to ${clientEmail}?`)) {
            // Get the button and add loading state
            const button = event.target.closest('.btn');
            const originalText = button.innerHTML;
            button.innerHTML = `
                <svg class="loading-spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                        <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                        <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                    </svg>
                    Sending...
            `;
            button.disabled = true;
            
            // Prepare form data
            const formData = new FormData();
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            
            if (!csrfToken) {
                alert('Security token not found. Please refresh the page and try again.');
                button.innerHTML = originalText;
                button.disabled = false;
                return;
            }
            
            formData.append('csrfmiddlewaretoken', csrfToken.value);
            formData.append('project_id', projectId);
            formData.append('client_email', clientEmail);
            formData.append('client_username', clientUsername || '');
            
            // Send the report via AJAX
            fetch('{% url "send_project_report_ajax" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    showNotification('✅ ' + data.message, 'success');
                } else {
                    // Show error message
                    showNotification('❌ ' + (data.error || 'Failed to send report'), 'error');
                }
            })
            .catch(error => {
                console.error('Error sending report:', error);
                showNotification('❌ Error sending report: ' + error.message, 'error');
            })
            .finally(() => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    function sendClientOTP(projectId, clientUsername, clientEmail) {
        if (!clientUsername || !clientEmail) {
            alert('Please ensure the project has a client username and email before sending OTP.');
            return;
        }

        if (confirm(`Send OTP to ${clientEmail} for client ${clientUsername}?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "send_client_otp" %}';

            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            form.appendChild(csrfToken);

            const projectIdInput = document.createElement('input');
            projectIdInput.type = 'hidden';
            projectIdInput.name = 'project_id';
            projectIdInput.value = projectId;
            form.appendChild(projectIdInput);

            const usernameInput = document.createElement('input');
            usernameInput.type = 'hidden';
            usernameInput.name = 'client_username';
            usernameInput.value = clientUsername;
            form.appendChild(usernameInput);

            const emailInput = document.createElement('input');
            emailInput.type = 'hidden';
            emailInput.name = 'client_email';
            emailInput.value = clientEmail;
            form.appendChild(emailInput);

            document.body.appendChild(form);
            form.submit();
        }
    }



    // Filtering functions
    function clearFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('searchProjects').value = '';
        filterProjects();
    }

    function filterProjects() {
        const statusFilter = document.getElementById('statusFilter').value;
        const searchTerm = document.getElementById('searchProjects').value.toLowerCase();
        const projectCards = document.querySelectorAll('.project-card');

        projectCards.forEach(card => {
            const status = card.dataset.status;
            const name = card.dataset.name;
            const client = card.dataset.client;
            
            const statusMatch = !statusFilter || status === statusFilter;
            const searchMatch = !searchTerm || name.includes(searchTerm) || client.includes(searchTerm);
            
            card.style.display = statusMatch && searchMatch ? 'block' : 'none';
        });
    }

    // Add event listeners for filtering
    document.getElementById('statusFilter').addEventListener('change', filterProjects);
    document.getElementById('searchProjects').addEventListener('input', filterProjects);

    // Close modals when clicking outside
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    };

    // Theme will be handled by the global theme toggle in settings
</script>
{% endblock %}